<!-- jquery autocomplete plugin-->
<!--<link rel="stylesheet" href="plugins/jquery-autocomplete/jquery.autocomplete.css">-->
<!--<script type="text/javascript" src="plugins/jquery-autocomplete/jquery.autocomplete.min.js"></script>-->
<!--<script type="text/javascript" src="repair/js/repairSchedule.js"></script>-->

<style type="text/css">
    .tab_position{
        position: relative;
    }
    .tab_btn_close{
        position: absolute;
        top: -5px;
        right: -2px;
    }
    .tab_btn_close_color{
        color: rgba(0,0,0,0.3)
    }
    .tab_btn_close_color:hover{
        color: red;
    }
    .inputgroup-addon-left{
        position: absolute;
        z-index: 5;
        height: 34px;
        padding-top: 7px;
        min-width: 40px;
        text-align: center;
        border-right: 1px solid #ccc;
    }
    .inputgroup-addon-input{
        padding-left: 45px;
        padding-right: 45px;
    }
    .inputgroup-addon-right{
        position: absolute;
        top:0px;
        right: 0px;
        z-index: 5;
        height: 34px;
        padding-top: 7px;
        min-width: 40px;
        text-align: center;
        border-left: 1px solid #ccc;
    }

    #table_data > tr > td{
        word-break: break-all;
    }
</style>
<script type="application/javascript">

    var home_detail_flag="home";
    /**
     * 加载该页面时的初始化操作
     * @param {string} page : home or detail
     */
    function init_schedule(page){
        home_detail_flag=page;
        if(page == "home"){
            //加载css文件
            $("<link>").attr({ rel: "stylesheet",
                        type: "text/css",
                        href: "plugins/jquery-autocomplete/jquery.autocomplete.css"
                    }).appendTo("head");
            //加载js文件
            $.getScript("plugins/jquery-autocomplete/jquery.autocomplete.min.js",function () {
                init_schedule_select(page);
            });
            $.getScript("repair/js/repairSchedule.js");
            require(['scheduleService'], function() {
                // 引入分页
                $("#page_footer").pagination({
                    changePage:function (cursor,limit) {
                        //分页内容改变的回调函数
                        getlist_schedule(cursor,limit);
                    }
                });
                getlist_schedule(0,$("#page_footer .col-sm-5 select").val());
            });
            $("#modal_asset_list_div").load("repair/order/repair_asset.html");
        }else if(page == "detail"){
            $("#form_group_label_site,#form_group_input_site").remove();
            $("<link>").attr({ rel: "stylesheet",
                type: "text/css",
                href: "../plugins/jquery-autocomplete/jquery.autocomplete.css"
            }).appendTo("head");
            $.getScript("../plugins/jquery-autocomplete/jquery.autocomplete.min.js",function () {
                init_schedule_select(page);
            });
            $.getScript("../repair/js/repairSchedule.js");
            $.getScript("../admin/service/scheduleService.js",function () {
                // 引入分页
                $("#page_footer").pagination({
                    changePage:function (cursor,limit) {
                        getlist_schedule(cursor,limit);
                    }
                });
                getlist_schedule(0,$("#page_footer .col-sm-5 select").val());
            });
            $("#modal_asset_list_div").load("../repair/order/repair_asset.html");
        }
    }
    /**
     * 初始化自动补全插件
     * */
    function init_schedule_select(page) {
        $('#search_assetnumber').AutoComplete({
            'width': 168,
            'maxHeight': 200,
            'itemHeight': 20,
            'data': "/api/assets?",
            'inputName':'asset_no', // 给输入框的变量取名
            'ajaxParams':"limit=-1&access_token="+sessionStorage.getItem("accessToken"),
            'afterSelectedHandler': function(data){
                // 在列表项被选择之后的回调函数
                $("#search_assetnumber").removeAttr("data-assetId").attr("data-assetId",data._id);
            },
            'doseNotSelect_blur':function (date_list) {
                // 没有选择列表值时，点击其他空白地方(失去焦点)，而导致列表消失时执行的函数方法
                //date_list[0]:查询结果列表的name集合  date_list[1]:查询结果的id集合
                var input_val=$("#search_assetnumber").val();
                if(input_val != null && input_val != ''){
                    var symbol=false;
                    for(var i=0;i<date_list[0].length;i++){
                        if(input_val == date_list[0][i]){
                            $("#search_assetnumber").removeAttr("data-assetId").attr("data-assetId",date_list[1][i]);
                            symbol=true;
                            break;
                        }
                    }
                    if(!symbol){
                        $("#search_assetnumber").removeAttr("data-assetId")
                    }
                }else{
                    $("#search_assetnumber").removeAttr("data-assetId");
                }
            },
            'propertychange':function (array_name,array_id) {
                //输入框值输入发生变化时
                $("#search_assetnumber").removeAttr("data-assetId");
                var input_val=$("#search_assetnumber").val();
                if(input_val != null && input_val != ''){
                    var symbol=false;
                    for(var i=0;i<array_name.length;i++){
                        if(input_val == array_name[i]){
                            $("#search_assetnumber").removeAttr("data-assetId").attr("data-assetId",array_id[i]);
                            symbol=true;
                            break;
                        }
                    }
                    if(!symbol){
                        $("#search_assetnumber").removeAttr("data-assetId")
                    }
                }else{
                    $("#search_assetnumber").removeAttr("data-assetId");
                }
            },
            'success':function (data) {
                var t=[[],[]];
                if(data.result){
                    for(var index=0;index<data.result.length;index++){
                        if(data.result[index].asset_no && data.result[index].asset_no !=""){
                            t[0].push(data.result[index].asset_no);
                            t[1].push(data.result[index]._id);
                        }
                    }
                }
                return t;
            }
        }).AutoComplete('show');
        $('#search_devicename').AutoComplete({
            'width': 168,
            'maxHeight': 200,
            'itemHeight': 20,
            'data': "/api/assets?",
            'inputName':'device_name', // 给输入框的变量取名
            'ajaxParams':"limit=-1&access_token="+sessionStorage.getItem("accessToken"),
            'afterSelectedHandler': function(data){
                $("#search_devicename").removeAttr("data-assetId").attr("data-assetId",data._id);
            },
            'doseNotSelect_blur':function (date_list) {
                var input_val=$("#search_devicename").val();
                if(input_val != null && input_val != ''){
                    var symbol=false;
                    for(var i=0;i<date_list[0].length;i++){
                        if(input_val == date_list[0][i]){
                            $("#search_devicename").removeAttr("data-assetId").attr("data-assetId",date_list[1][i]);
                            symbol=true;
                            break;
                        }
                    }
                    if(!symbol){
                        $("#search_devicename").removeAttr("data-assetId");
                    }
                }else{
                    $("#search_devicename").removeAttr("data-assetId");
                }
            },
            'propertychange':function (array_name,array_id) {
                $("#search_devicename").removeAttr("data-assetId");
                var input_val=$("#search_devicename").val();
                if(input_val != null && input_val != ''){
                    var symbol=false;
                    for(var i=0;i<array_name.length;i++){
                        if(input_val == array_name[i]){
                            $("#search_devicename").removeAttr("data-assetId").attr("data-assetId",array_id[i]);
                            symbol=true;
                            break;
                        }
                    }
                    if(!symbol){
                        $("#search_devicename").removeAttr("data-assetId")
                    }
                }else{
                    $("#search_devicename").removeAttr("data-assetId");
                }
            },
            'success':function (data) {
                var t=[[],[]];
                if(data.result){
                    for(var index=0;index<data.result.length;index++){
                        if(data.result[index].device_name && data.result[index].device_name !=""){
                            t[0].push(data.result[index].device_name);
                            t[1].push(data.result[index]._id);
                        }
                    }
                }
                return t;
            }
        }).AutoComplete('show');
        if(page == "home"){
            $('#search_site').AutoComplete({
                'width': 168,
                'maxHeight': 200,
                'itemHeight': 20,
                'data': "/api/sites?",
                'inputName':'name', // 给输入框的变量取名
                'ajaxParams':"limit=-1&access_token="+sessionStorage.getItem("accessToken"),
                'afterSelectedHandler': function(data){
                    $("#search_site").removeAttr("data-siteId").attr("data-siteId",data._id);
                },
                'doseNotSelect_blur':function (date_list) {
                    var input_val=$("#search_site").val();
                    if(input_val != null && input_val != ''){
                        var symbol=false;
                        for(var i=0;i<date_list[0].length;i++){
                            if(input_val == date_list[0][i]){
                                $("#search_site").removeAttr("data-siteId").attr("data-siteId",date_list[1][i]);
                                symbol=true;
                                break;
                            }
                        }
                        if(!symbol){
                            $("#search_site").removeAttr("data-siteId")
                        }
                    }else{
                        $("#search_site").removeAttr("data-siteId");
                    }
                },
                'propertychange':function (array_name,array_id) {
                    $("#search_site").removeAttr("data-siteId");
                    var input_val=$("#search_site").val();
                    if(input_val != null && input_val != ''){
                        var symbol=false;
                        for(var i=0;i<array_name.length;i++){
                            if(input_val == array_name[i]){
                                $("#search_site").removeAttr("data-siteId").attr("data-siteId",array_id[i]);
                                symbol=true;
                                break;
                            }
                        }
                        if(!symbol){
                            $("#search_site").removeAttr("data-siteId")
                        }
                    }else{
                        $("#search_site").removeAttr("data-siteId");
                    }
                },
                'success':function (data) {
                    var t=[[],[]];
                    if(data.result){
                        for(var index=0;index<data.result.length;index++){
                            if(data.result[index].name && data.result[index].name !=""){
                                t[0].push(data.result[index].name);
                                t[1].push(data.result[index]._id);
                            }
                        }
                    }
                    return t;
                }
            }).AutoComplete('show');
        }

    }

    $(document).ready(function() {
        // 权限过滤
        permissionFilter_pageFunc();
        // 初始化页面国际化
        locale.render({element: "#init_body"});
        $("#search_assetnumber").on('input propertychange',function () {
            $("#search_assetnumber").removeAttr("data-assetId");
        });
        $("#search_devicename").on('input propertychange',function () {
            $("#search_devicename").removeAttr("data-assetId");
        });
        $("#search_site").on('input propertychange',function () {
            $("#search_site").removeAttr("data-assetId");
        });
    });
</script>

<section class="content-header">
    <h1 lang="text:repair_schedule">
        预防性计划
    </h1>
    <ol class="breadcrumb">
        <li><a href="#" lang="text:repair_manage"></a></li>
        <li class="active" lang="text:repair_schedule"></li>
    </ol>
</section>
<section class="content" id="tcontent">
    <div class="nav-tabs-custom">
        <!--标签页 Nav tabs-->
        <ul class="nav nav-tabs" role="tablist" id="myNavTabs">
            <li role="presentation" class="active">
                <a role="tab" data-toggle="tab" lang="text:plan_information" href="#tab_list">计划信息</a>
            </li>
        </ul>
        <!--标签页 Tab panes-->
        <div class="tab-content" id="myPanesTabs" style="padding-bottom: 0px;">
            <div role="tabpanel" class="tab-pane active row" id="tab_list"><!--列表信息-->
                <div class="col-md-12">
                    <div class="box box-solid" style="margin-bottom: 0px;box-shadow: 0px 0px;">
                        <div class="overlay" style="display: none;" id="overlay1">
                            <i class="fa icon-refresh icon-spin"></i>
                        </div>
                        <div class="box-body">
                            <div class="row"><!--查询条件-->
                                <div class="col-sm-12" style="padding-bottom: 10px;">
                                    <form class="form-inline" id="schedule_form_query">
                                        <div class="form-group" id="form_group_label_site">
                                            <label lang="text:site">现场:</label>
                                        </div>
                                        <div class="form-group" id="form_group_input_site">
                                            <input type="text" class="form-control input-sm" id="search_site" placeholder="现场" lang="placeholder:site">
                                        </div>
                                        <div class="form-group">
                                            <div class="input-group">
                                                <div class="input-group-btn" id="radio_select_assetid">
                                                    <button type="button" class="btn btn-default dropdown-toggle btn-sm" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                        <span name="radio_select_assetid" data-val="2" lang="text:device_name">资产编号</span><span class="caret"></span>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li><a href="javascript:void(0)" lang="text:asset_number" onclick="select_assetId_content(1)">资产编号</a></li>
                                                        <li><a href="javascript:void(0)" lang="text:device_name" onclick="select_assetId_content(2)">设备名称</a></li>
                                                    </ul>
                                                </div>
                                                <div class="form-group">
                                                    <input type="text" class="form-control input-sm" id="search_assetnumber" placeholder="资产编号" lang="placeholder:asset_number" style="display: none;">
                                                </div>
                                                <div class="form-group">
                                                    <input type="text" class="form-control input-sm" id="search_devicename" placeholder="设备名称" lang="placeholder:device_name">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label lang="text:plan_name">计划名称:</label>
                                            <input type="text" class="form-control input-sm" id="search_planname" placeholder="计划名称" lang="placeholder:plan_name">
                                        </div>
                                        <div class="form-group">
                                            <label for="search_type" class="control-label" lang="text:type">类型</label>
                                            <select id="search_type" class="form-control input-sm">
                                                <option value="" selected="selected" lang="text:---+all+---">全部</option>
                                                <option value="1"  lang="text:periodic_plan"></option>
                                                <option value="2"  lang="text:according_to_the_deadline"></option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <button type="button" class="btn btn-default btn-sm" id="btn_research" data-permissionFilter="[29]" data-toggle="tooltip"
                                                    title="查询" lang="title:query">
                                                <span class="glyphicon glyphicon-search"></span>
                                            </button>
                                        </div>
                                        <!--右侧-->
                                        <div class="form-group box-tools pull-right">
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-default btn-sm" title='新增'
                                                        data-toggle='tooltip' data-placement="bottom" lang="title:add" onclick="option_schedule('add',null,null);" data-permissionFilter="[29]">
                                                    <i class="glyphicon glyphicon-plus"></i>
                                                </button>
                                                <button type="button" class="btn btn-default btn-sm" title='删除'
                                                        data-toggle='tooltip' data-placement="bottom" lang="title:delete" onclick="delete_schedule();" data-permissionFilter="[29]">
                                                    <i class="glyphicon glyphicon-minus"></i>
                                                </button>
                                                <button type="button" class="btn btn-default btn-sm" title='导出' style="display: none;"
                                                        data-toggle='tooltip' data-placement="bottom" lang="title:export" onclick="" data-permissionFilter="[29]">
                                                    <i class="icon-upload-alt"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div><!--查询条件-->
                            <div>
                                <table class="table table-bordered table-striped">
                                    <thead>
                                    <tr>
                                        <th id="tableHead_selectAll" style="width: 30px;cursor: pointer;">
                                            <input type="checkbox" data-toggle='tooltip' data-placement="bottom" lang="title:check_all">
                                        </th>
                                        <th lang="text:site" style="width: 17%;">现场</th>
                                        <th lang="text:device_name" style="width: 18%;">设备名称</th>
                                        <th lang="text:plan_name" style="width: 18%;">计划名称</th>
                                        <th lang="text:type" style="width: 16%;">类型</th>
                                        <th lang="text:execute_time" style="width: 17%;">执行时间</th>
                                        <th style="width:10%; text-align:center;" lang="text:operate"></th>
                                    </tr>
                                    </thead>
                                    <tbody id="table_data">
                                    <!--动态载入数据-->
                                    </tbody>
                                </table>
                            </div>
                        </div><!--box-body-->
                        <div id="page_footer">
                            <!--分页工具-->
                        </div>

                    </div>
                </div>
            </div><!--列表信息-->
        </div>
    </div>

    <div id="modal_asset_list_div"></div><!--安置查询模态框-->
</section>

<script type="application/javascript">
    // 资产编号，设备名称  切换事件
    function select_assetId_content(val) {
        if(val == 1){
            $("#radio_select_assetid > button > span[name='radio_select_assetid']").attr("lang","text:asset_number");
            $("#radio_select_assetid > button > span[name='radio_select_assetid']").attr("data-val","1");
            $("#search_assetnumber").show();
            $("#search_devicename").hide();
        }else if(val == 2){
            $("#radio_select_assetid > button > span[name='radio_select_assetid']").attr("lang","text:device_name");
            $("#radio_select_assetid > button > span[name='radio_select_assetid']").attr("data-val","2");
            $("#search_assetnumber").hide();
            $("#search_devicename").show();
        }
        locale.render({element: "#init_body"});
    }
    /*********************************************** 预防性计划相关操作 **********************************************************************************/
    /**
     * 绘制表格，填写schedule数据
     * */
    function fill_data_schedule(data) {
        $("#table_data").empty();
        $("#tableHead_selectAll > input").prop("checked", false);
        var str = "";
        var schedule_type="";
        var execute_ts="";
        for(var i=0;i<data.length;i++){
            if(data[i].schedule.setting.schedule_type==1){
                schedule_type=locale.get({lang: "periodic_plan"});
                if(data[i].schedule.setting.cycle_type == 1){
                    var _day=data[i].schedule.setting.day;
                    execute_ts=String.format(locale.get("every_number_days"),_day);
                }else if(data[i].schedule.setting.cycle_type == 2){
                    var week=data[i].schedule.setting.day;
                    switch (week){
                        case 1:
                            execute_ts=locale.get({lang: "monday"});
                            break;
                        case 2:
                            execute_ts=locale.get({lang: "tuesday"});
                            break;
                        case 3:
                            execute_ts=locale.get({lang: "wednesday"});
                            break;
                        case 4:
                            execute_ts=locale.get({lang: "thursday"});
                            break;
                        case 5:
                            execute_ts=locale.get({lang: "friday"});
                            break;
                        case 6:
                            execute_ts=locale.get({lang: "saturday"});
                            break;
                        case 7:
                            execute_ts=locale.get({lang: "sunday"});
                            break;
                        default:
                            break;
                    }
                }else if(data[i].schedule.setting.cycle_type == 3){
                    var month_day=data[i].schedule.setting.day;
                    execute_ts=String.format(locale.get("every_month_day"),month_day);
                }
            }else if(data[i].schedule.setting.schedule_type==2){
                schedule_type=locale.get({lang: "according_to_the_deadline"});
                if(data[i].schedule.setting.deadline){
                    var date=new Date(data[i].schedule.setting.deadline);
                    execute_ts=schneider.util.dateFormat(date.getTime(), "yyyy-MM-dd");
                }
            }
            if(home_detail_flag == "home"){
                var site_click="<a href='javascript:void(0)' onclick='detail_popUp(\"" + data[i].schedule.site_id + "\")'>"+data[i].schedule.site_name +"</a>";
            }else{
                var site_click=data[i].schedule.site_name;
            }
            str = "<tr>"
                    +"<td><input type='checkbox' value='" + data[i].schedule._id + "' class='tabs-checked'></td>"
                    +"<td>"+site_click+"</td>"
                    +"<td>" + data[i].schedule.device_name + "</td>"
                    +"<td>" + data[i].schedule.name + "</td>"
                    +"<td>" + schedule_type + "</td>"
                    +"<td>" + execute_ts+ "</td>"
                    +"<td style='text-align:center;'>" +
                    "<span data-toggle='tooltip' class='glyphicon glyphicon-edit link-black' style='cursor: pointer;' lang='title:modify' data-permissionFilter='[29]' onclick='option_schedule(\"update\",\"" + data[i].schedule._id + "\",\""+data[i].schedule.name+"\");'></span>"
                    + "</td>"
                    +"</tr>";
            $("#table_data").append(str);
            execute_ts="";
        }
        $("tbody > tr > td > input").on("click", function() {
            var selected_usersId = $("#table_data tr td input[type='checkbox']:checked");
            var allUsers_nowPage = $("#table_data tr td input");
            if (selected_usersId.length < allUsers_nowPage.length) {
                $("#tableHead_selectAll > input").prop("checked", false);
            }
            if (selected_usersId.length == allUsers_nowPage.length) {
                $("#tableHead_selectAll > input").prop("checked", true);
            }
        });
        permissionFilter_pageFunc();
        locale.render({element: "#init_body"});
    }
    /**
     * 全选事件控制
     * */
    $("#tableHead_selectAll").on("click", function() {
        var selected_usersId = $("#table_data tr td input[type='checkbox']:checked");
        var allUsers_nowPage = $("#table_data tr td input");
        if (allUsers_nowPage.length > 0) {
            if (selected_usersId.length < (allUsers_nowPage.length)) {
                $("#table_data tr td input").prop("checked", true);
                $("#tableHead_selectAll > input").prop("checked", true);
            } else {
                $("#table_data tr td input").prop("checked", false);
                $("#tableHead_selectAll > input").prop("checked", false);
            }
        }else{
            $("#tableHead_checkbok").prop("checked", false);
        }
    });
    /**
     * 获取预防性计划列表
     * */
    function getlist_schedule(cursor,limit){
        var params = {
            cursor: cursor,
            limit: limit,
            verbose: "100"
        };
        // 预防性计划名称条件
        var planname=$.trim($("#search_planname").val());
        if (planname !== "") {
            planname = planname.match(pattern);
            params.name = planname;
        }
        $("#search_planname").val(planname);
        // 预防性计划类型条件
        var type=$("#search_type").val();
        if(type!=null || type!=''){
            params.schedule_type=type;
        }
        // 资产id条件
        var asset_id='';
        var assetId_type_select= $("#radio_select_assetid > button > span[name='radio_select_assetid']").attr("data-val");
        if(assetId_type_select == 1){
            if($("#search_assetnumber").val() != null && $("#search_assetnumber").val() != ''){
                if('undefined'!=typeof($("#search_assetnumber").attr('data-assetId')) && $("#search_assetnumber").attr('data-assetId')!=''){
                    asset_id=$.trim($("#search_assetnumber").attr('data-assetId'));
                }
                if(asset_id != ''){
                    params.asset_id=asset_id;
                }else{
                    $("#page_footer").pagination("clear");
                    $("#table_data").empty();
                    errorTipDis("this_device_nonexistence");
                    $("#table_data").append('<tr><td colspan="7"  align="center" lang="text:no_data"></td></tr>');
                    locale.render({element: "#init_body"});
                    return '';
                }
            }
        }else if(assetId_type_select == 2){
            if($("#search_devicename").val() != null && $("#search_devicename").val() != ''){
                if('undefined'!=typeof($("#search_devicename").attr('data-assetId')) && $("#search_devicename").attr('data-assetId')!=''){
                    asset_id=$.trim($("#search_devicename").attr('data-assetId'));
                }
                if(asset_id != ''){
                    params.asset_id=asset_id;
                }else{
                    $("#page_footer").pagination("clear");
                    $("#table_data").empty();
                    errorTipDis("this_device_nonexistence");
                    $("#table_data").append('<tr><td colspan="7"  align="center" lang="text:no_data"></td></tr>');
                    locale.render({element: "#init_body"});
                    return '';
                }
            }
        }

        // 现场id条件
        if(home_detail_flag == "home"){
            if($("#search_site").val() != null && $("#search_site").val() != ''){
                var site_id='';
                if('undefined'!=typeof($("#search_site").attr('data-siteId')) && $("#search_site").attr('data-siteId')!=''){
                    site_id=$.trim($("#search_site").attr("data-siteId"));
                }
                if(site_id != ''){
                    params.site_id=site_id;
                }else{
                    var ssn=$.trim($("#search_site").val());
                    if (ssn !== "") {
                        ssn = ssn.match(pattern);
                        params.site_name=ssn;
                        $("#search_site").val(ssn);
                    }
                }
            }
        }else if(home_detail_flag == "detail"){
            params.site_id=sessionStorage.getItem("_id");
        }

        $("#overlay1").show();
        get_api_schedule(params,function (data) {
            if(data.total && data.total > 0){
                fill_data_schedule(data.result);
                //绘制分页栏数据
                $("#page_footer").pagination("data",data);
            }else {
                //清除分页栏数据
                $("#page_footer").pagination("clear");
                $("#table_data").empty();
                $("#table_data").append('<tr><td colspan="7"  align="center" lang="text:no_data"></td></tr>');
            }
            locale.render({element: "#init_body"});
            $("#overlay1").hide();
        },this);
    }
    /**
     * 删除计划
     * */
    function delete_schedule() {
        var selected_users = $("#table_data tr td input[type='checkbox']:checked");
        if(selected_users.length > 0){
            dialog.render({
                lang: "delete_schedule+?",
                buttons: [{lang: "yes", click: function() {
                    $("#overlay1").show();
                    selected_users.each(function() {
                        delete_api_schedule($(this).val(),null);
                    });
                    $("#overlay1").hide();
                    getlist_schedule(0,$("#page_footer .col-sm-5 select").val());
                    dialog.close();
                }}, {lang: "no", click: function() {
                    dialog.close();
                }}],
                close: function() {
                    dialog.close();
                }
            });
        }else{
            errorTipDis("select_del");
        }
        locale.render({element: "#init_body"});
    }
    /**
     * 创建预防性计划，修改预防性计划
     *
     * @param {string} type add or update  判断操作类型
     * @param {string} form1_id 提交数据的form表单id
     *
     * */
    function create_update_schedule(type,form1_id) {
        // 添加需要验证的 动态生成的内容
        $("#"+form1_id+" input[name='schedule_type_2']").removeClass("validate[required]");
        if($("#"+form1_id+" input[name='select_schedule_type']:checked").val()){
            $("#"+form1_id+" input[name='schedule_type_2']").addClass("validate[required]");
        }
        //点击按钮后，改按钮不可点击，即按钮只能点击一次
        $("#submit_"+form1_id).attr("disabled",true);
        // 表单验证通过时执行
        if($("#"+form1_id).validationEngine('validate')){
            // 周期性，或则，截至日期型
            var schedule_type=$("#"+form1_id+" input[name='select_schedule_type']:radio:checked").val();
            var schedule={};
            var setting={};
            if(schedule_type=='1'){
                var cycle_type=$("#"+form1_id+" input[name='form_typeselect']:radio:checked").val();
                if(cycle_type == 'day'){
                    setting.cycle_type='1';
                    setting.day=$("#"+form1_id+" input[name='cyclicity_day']").val();
                }else if(cycle_type == 'week'){
                    setting.cycle_type='2';
                    setting.day=$("#"+form1_id+" select[name='cyclicity_week']").val();
                }else if(cycle_type == 'month'){
                    setting.cycle_type='3';
                    setting.day=$("#"+form1_id+" input[name='cyclicity_month']").val();
                }
            }else if(schedule_type=='2'){
                var deadline=$("#"+form1_id+" input[name='schedule_type_2").val();
                setting.deadline=(new Date(deadline)).getTime();
                schedule.validation_time=(new Date()).getTime();
            }
            // 设置参数
            setting.schedule_type=schedule_type;
            schedule.setting=setting;
            var plan_name=$("#"+form1_id+" input[name='plan_name']").val();
            if (plan_name !== "") {
                schedule.name= plan_name;
            }
            schedule.asset_no=$("#"+form1_id+" input[name='asset_number']").val();
            schedule.device_name=$("#"+form1_id+" input[name='device_name']").val();
            schedule.site_id=$("#"+form1_id+" > input[name='site_id']").val();
            schedule.site_name=$("#"+form1_id+" > input[name='site_name']").val();
            schedule.validation_time=(new Date($("#"+form1_id+" input[name='validation_time_"+form1_id+"']").val())).getTime();
            schedule.asset_id=$("#"+form1_id+" > input[name='asset_id']").val();
            var failure_time=$("#"+form1_id+" input[name='failure_time_"+form1_id+"']").val();
            if(failure_time != null && failure_time!=''){
                schedule.failure_time=(new Date(failure_time)).getTime();
            }
            var sendData={schedule:schedule};
            if(type==='add'){
                var params="";
                post_api_schedule(params,sendData,function (result) {
                    var showText;
                    if(result.result){
                        showText =  String.format(locale.get("create_schedule_success"),"—"+result.result.schedule.name+"—");
                     }else{
                        showText = locale.get("create_schedule_failed", "");
                     }
                    dialog.render({
                        text: showText
                    });
                    // 刷新列表
                    $("#myNavTabs > .active > div").click();
                    $("#myNavTabs > li > a:first").tab('show');
                    getlist_schedule(0,$("#page_footer .col-sm-5 select").val());
                },this);
            }else if(type==='update'){
                var schedule_id=$("#"+form1_id+" > input[name='schedule_id']").val();
                var params="";
                put_api_schedule(schedule_id,params,sendData,function (result) {
                    var showText;
                    if(result.result){
                        showText = String.format(locale.get("update_schedule_success"),"—"+result.result.schedule.name+"—");
                    }else if(result.error){
                        switch (result.error_code){
                            case 20006:
                                showText = locale.get("this_device_nonexistence");
                                break;
                            default:
                                showText = locale.get("exec_failure");
                                break;
                        }
                    }else{
                        showText = locale.get("update_schedule_failed", "");
                    }
                    dialog.render({
                        text: showText
                    });
                    // 刷新列表
                    $("#myNavTabs > .active > div").click();
                    $("#myNavTabs > li > a:first").tab('show');
                    getlist_schedule(0,$("#page_footer .col-sm-5 select").val());
                },this);
            }
        }
    }

    /**
     * 生成tab标签和tab页
     * 创建计划 或则 修改计划，如果存在则不生成
     * 根据action：add or update  判断操作类型
     * @param {string} id:预防性计划id，创建计划时为空
     * @return
     * */
    function option_schedule(action,id,schedule_name) {
        var nav_id='';
        var panes_id='';
        if(action === "add"){
            nav_id='tab_nav_create';
            panes_id='tab_panes_create';
            var form1_id='add_formcontent';
            var build_tab_param={
                type:"add",
                nav_id:nav_id,
                panes_id:panes_id,
                nav_title_text:"",
                container_nav_id:"myNavTabs",
                container_panes_id:"myPanesTabs"
            };
            if($("#tab_nav_create").length==0){
                 // 生成tab
                create_tab_schedule(build_tab_param);
                // 通过执行函数在tab_panes里加入 创建或更新 计划内容
                create_content_schedule(action,form1_id,nav_id,panes_id,"");
            }
            $("#"+nav_id+" > a:first").tab("show");
        }else if(action === "update"){
            nav_id='tab_nav_update'+id;
            panes_id='tab_panes_update'+id;
            var form1_id='update_formcontent_'+id;
            var build_tab_param={
                type:"update",
                nav_id:nav_id,
                panes_id:panes_id,
                nav_title_text:schedule_name,
                container_nav_id:"myNavTabs",
                container_panes_id:"myPanesTabs"
            };
            if($("#"+nav_id).length==0){
                // 生成tab
                create_tab_schedule(build_tab_param);
                // 通过执行函数在tab_panes里加入 创建或更新 计划内容
                create_content_schedule(action,form1_id,nav_id,panes_id,id);
                // 如果是更新，则在生成form后，填入原来的数据
                get_api_schedule_id(id,"",function (result) {
                    var data=result.result.schedule;
                    $("#"+form1_id+" > input[name='schedule_id']").val(data._id);
                    $("#"+form1_id+" > input[name='asset_id']").val(data.asset_id);
                    $("#"+form1_id+" > input[name='site_id']").val(data.site_id);
                    $("#"+form1_id+" input[name='plan_name']").val(data.name);
                    $("#"+form1_id+" input[name='asset_number']").val(data.asset_no);
                    $("#"+form1_id+" input[name='device_name']").val(data.device_name);
                    $("#"+form1_id+" input[name='site_name']").val(data.site_name);

                    var date_validation = new Date(data.validation_time);
                    $("#"+form1_id+" input[name='validation_time_"+form1_id+"']").datepicker('setDate', schneider.util.dateFormat(date_validation.getTime(), "yyyy-MM-dd"));
                    var failureTime=data.failure_time+"";
                    if(failureTime != 'undefined' && failureTime != null && failureTime != ''){
                        var date_failure = new Date(data.failure_time);
                        $("#"+form1_id+" input[name='failure_time_"+form1_id+"']").datepicker('setDate', schneider.util.dateFormat(date_failure.getTime(), "yyyy-MM-dd"));
                    }

                    var schedule_type=data.setting.schedule_type;
                    if(schedule_type == 1){
                        var cycle_type=data.setting.cycle_type;
                        if(cycle_type == 1){
                            $("#"+form1_id+" input[name='cyclicity_day']").val(data.setting.day);
                        }else if(cycle_type == 2){
                            $("#"+form1_id+" input[name='form_typeselect'][value='week']").click();
                            $("#"+form1_id+" select[name='cyclicity_week'] option").removeAttr("selected");
                            $("#"+form1_id+" select[name='cyclicity_week'] option[value='"+data.setting.day+"']").attr("selected",true);
                        }else if(cycle_type == 3){
                            $("#"+form1_id+" input[name='form_typeselect'][value='month']").click();
                            $("#"+form1_id+" input[name='cyclicity_month']").val(data.setting.day);
                        }
                    }else if(schedule_type == 2){
                        $("#"+form1_id+" input[name='select_schedule_type'][value='2']").click();
                        $("#"+form1_id+" > div[name='group_schedule_type_1']").hide();
                        $("#"+form1_id+" > div[name='group_schedule_type_2']").show();
                        // 填入日期内容
                        var now = new Date(parseInt(data.setting.deadline));
                        //刷新日历视图
                        $("#"+form1_id+" input[name='schedule_type_2']").datepicker('setDate', schneider.util.dateFormat(now.getTime(), "yyyy-MM-dd"));
                    }
                },this);
            }
            $("#"+nav_id+" > a:first").tab("show");
        }
        locale.render({element: "#init_body"});
    }

    /**
     * 查询按钮绑定事件
     * */
    $("#btn_research").on('click',function () {
        getlist_schedule(0,$("#page_footer .col-sm-5 select").val());
    });


</script>