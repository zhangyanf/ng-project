<!--创建工单页面-->

    <div class="panel panel-default" style="margin-bottom: 10px;"><!--故障设备信息-->
        <div class="panel-heading" style="padding: 8px 15px;" lang="text:fault_device_info"></div>
        <div class="panel-body" style="padding: 5px 15px 0px 15px;">
            <form class="form" id="c_form">
                <input type="hidden" id="c_assetId" value=""/>
                <input type="reset" id="c_reset" style="display:none;"/>
                <div class="row">
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label><span lang="text:asset_number"></span>
                                <span class="text-red">*</span>
                            </label>
                            <div class="has-feedback">
                                <input type="text" class="form-control input-sm validate[required]" id="c_asset_number" readonly="readonly" lang="placeholder:asset_number">
                                <div data-permissionFilter="[201,203,205]">
                                    <span style="font-size:16px;line-height: 30px;"  class="form-control-feedback glyphicon glyphicon-search"></span>
                                    <span style="border:1px solid #eee;width:30px;height:28px;position:absolute;right: 1px;cursor: pointer;" lang="title:query" class="glyphicon" onclick="showModal_asset_list('add')"></span>
                                </div>
                            </div>
                           <!-- <input type="text" class="form-control input-sm validate[required]"
                                   id="c_asset_number" readonly="readonly" lang="placeholder:asset_number">
                            <button type="button" style="display: block;margin-top: -30px;height:30px;"
                                    onclick="showModal_asset_list('add')" data-permissionFilter="[201,203,205]"
                                    class="btn btn-default btn-sm pull-right"
                                    data-toggle="tooltip" title="查找" lang="title:query">
                                <span class="glyphicon glyphicon-search"></span>
                            </button>-->
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label><span lang="text:device_name"></span></label>
                            <input type="text" class="form-control input-sm" readonly="readonly"
                                   id="c_device_name" lang="placeholder:device_name">
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label><span lang="text:serial_number"></span></label>
                            <input type="text" class="form-control input-sm"
                                   readonly="readonly" id="c_serial_number"
                                   lang="placeholder:serial_number">
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label><span lang="text:site"></span></label>
                            <input type="text" class="form-control input-sm" readonly="readonly" id="c_site"
                                   lang="placeholder:site">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label><span lang="text:site_address"></span></label>
                            <input type="text" class="form-control input-sm"
                                   readonly="readonly" id="c_site_address" lang="placeholder:site_address">
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label><span lang="text:contact"></span></label>
                            <input type="text"  class="form-control input-sm"
                                   readonly="readonly" id="c_contact" lang="placeholder:contact">
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label><span lang="text:phone"></span></label>
                            <input type="text"  class="form-control input-sm"
                                   readonly="readonly" id="c_phone" lang="placeholder:phone">
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div><!--故障设备信息-->
    <section><!--保修信息 附件信息-->
        <div style="box-shadow: 0 1px 1px rgba(0,0,0,0.1);">
            <ul class="nav nav-tabs" role="tablist" id="c_orderTabs">
                <li role="presentation" class="active" id="repair_info"><a
                        style="color: black;padding: 5px 15px;" role="tab" data-toggle="tab"
                        lang="text:repair_status;"></a></li>
                <!--
                <li role="presentation" id="adjunct_info"><a style="color: black;padding: 5px 15px;" role="tab" data-toggle="tab" lang="text:adjunct_info;">附件信息</a></li>
                -->
            </ul>
            <!-- Tab panes  tab-content-->
            <div class="tab-content" style="padding-bottom: 0px;">
                <!--报修信息-->
                <div id="c_repair_div"
                     style="padding: 5px 15px 0px 15px;border-right: 1px solid #dddddd;border-left: 1px solid #dddddd;border-bottom: 1px solid #dddddd;">
                    <form id="c_repair_form">
                        <input type="reset" style="display: none" id="c_repair_reset"/>
                        <div class="row">
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label><span lang="text:order_name"></span><span class="text-red">*</span></label>
                                    <input type="text"
                                           class="form-control input-sm validate[required,specialCharacter,maxSize[30]]"
                                           id="c_order_name" lang="placeholder:order_name">
                                </div>
                            </div>
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label><span lang="text:repair_date"></span><span class="text-red">*</span></label>
                                    <div class="has-feedback">
                                        <input type="text" class="form-control input-sm" id="c_repair_date"
                                               readonly="readonly">
                                        <span class="glyphicon glyphicon-calendar form-control-feedback" style="right: 0;"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label><span lang="text:repair_man"></span><span class="text-red">*</span></label>
                                    <input type="text"
                                           class="form-control input-sm validate[required,specialCharacter,maxSize[30]]"
                                           id="c_repair_man" lang="placeholder:repair_man">
                                </div>
                            </div>
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label><span lang="text:repair_phone"></span></label>
                                    <input type="text"
                                           class="form-control input-sm validate[custom[phone]]"
                                           id="c_repair_phone" lang="placeholder:repair_phone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label><span lang="text:assigned_engineer"></span></label>
                                    <select type="text" class="form-control input-sm "
                                            id="c_assigned_engineer">
                                        <option value="" lang="text:--+please_select_engineer+--">
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label><input type="checkbox" id="c_fault_type"/><span lang="text:halt_fault"></span></label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <label><span lang="text:fault_phenomenon"></span></label>
                                    <textarea rows="4" class="form-control validate[maxSize[500],specialCharacter]" id="c_fault_phenomenon" style="resize: none; " lang="placeholder:fault_phenomenon" placeholder="故障现象"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <!--附件信息-->
                <div id='c_adjunct_div'
                     style="padding: 5px 15px 0px 15px; display:none;border-right: 1px solid #dddddd;border-left: 1px solid #dddddd;border-bottom: 1px solid #dddddd;">
                    <div class="row">
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label><span>持续开发中,尽情期待。。。。</span></label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section><!--保修信息 附件信息-->
    <div class="modal-footer" style="padding-top: 15px;padding-right: 0px;padding-bottom: 10px;">
        <button type="button" class="btn btn-default" onclick="closeCreateTab()" data-dismiss="modal"
                lang="text:close">
        </button>
        <button class="btn btn-primary" id="createOrder" onclick="createOrder();" lang="text:submit">
        </button>
    </div>

    <script>

        /**
         * 创建工单页面报修信息表单校验
         */
        validator.render("#c_repair_form", {
            promptPosition: "inline",
            scroll: false
        });
        validator.render("#c_form", {
            promptPosition: "inline",
            scroll: false
        });

        //操作时间，绑定日期插件
        $("#c_repair_date").daterangepicker(picker2Option);
        $("#c_repair_date").mousedown(function(){
            setCurrentDate("c_repair_date");
        });
        /**
         * 创建工单
         */
        function createOrder() {
            if ($('#c_form').validationEngine('validate')) {
                if ($('#c_repair_form').validationEngine('validate')) {
                    //采集故障设备信息
                    var assetId = $("#c_assetId").val();
                    if(!assetId) {
                        errorTipDis("please_select_a_fault_device");
                        return;
                    }
                    //采集维修信息
                    var repairDate =$("#c_repair_date").val(); //报修时间
                    if(typeof(repairDate)!="undefined"||repairDate!="") {
                        repairDate = dateConvertUnixtime2(repairDate);
                    }
                    var repairMan = $("#c_repair_man").val(); //报修人
                    var repairPhone = $("#c_repair_phone").val(); //报修电话
                    var assignedEngineerId = $("#c_assigned_engineer :selected").val(); //指派工程师id
                    var assignedEngineer = $("#c_assigned_engineer :selected").text(); //指派工程师
                    var fault_phenomenon = $.trim($("#c_fault_phenomenon").val()); //故障现象
                    var fault_type = 1; // 非停机故障
                    var order_name = $("#c_order_name").val(); // 工单名称
                    if($("#c_fault_type").is(":checked")){
                        fault_type = 2; //停机故障
                    }
                    var data = {
                        wo:{
                            asset_id:assetId,
                            create_time:repairDate,
                            creator:repairMan,
                            order_type:1,
                            fault_type:fault_type,
                            state:"new",
                            name:order_name
                        }
                    }
                    if($.trim(repairPhone)!="") {
                        data.wo.repair_call = repairPhone;
                    }
                    if($.trim(fault_phenomenon)!="") {
                        data.wo.comment = fault_phenomenon;
                    }
                    if($.trim(assignedEngineerId)!="") {
                        data.wo.executor = assignedEngineer;
                        data.wo.executor_id = assignedEngineerId;
                    }
                    addOrder(true,data,function(data){
                        if(typeof(data.result)!="undefined") {
                            dialog.render({
                                lang:"submit_success",
                            });
                            closeCreateTab();
                            research_site(0,parseInt($("#pageNumberSelect").val()));
                            //渲染工单条数
                            if(home_detail_flag == 'home'){
                                getOrderTotal();
                                getUnconfirmedOrderTotal();
                            }else if(home_detail_flag == 'detail'){
                                getOrderTotal(data.result.wo.site_id);
                                getUnconfirmedOrderTotal(data.result.wo.site_id);
                            }
                        }else {
                            dialog.render({
                                lang:"submit_failed",
                            });
                        }
                        locale.render({element: "#init_body"});
                    },this);
                }
            }

        }

        /**
         * 关闭创建工单tab页
         */
        function closeCreateTab() {
            var current_li= $("#myNavTabs a[lang='text:create_order']").parent();
            var close_index=current_li.index();
            if(current_li.hasClass("active")){
                current_li.parent().children("li").eq(close_index-1).children("a").click();
            }
            current_li.remove();
        }

        /**
         * 显示设备列表模态框
         */
        function showModal_asset_list(flag) {
            $("#modal_asset_list").modal("show");
            loading_asset_list(0, $("#page-footer1 .col-sm-5 select").val());
            $("#reset_form_asset").click();
            $("#queryAssetForm").attr("assetFlag",flag);// 标记是添加工单还是编辑工单回填设备信息
        }

        /**
         * 确定，回填报修设备信息
         */
        function ok(data) {
            getDeviceById(true,data._id,{verbose:100}, function(data){
                if(data.result) {
                    fillAssetInfo(data.result); //回填设备信息
                }
            },this)

        }

        /**
         * 回填设备信息
         */
        function fillAssetInfo(data) {

            if($("#queryAssetForm").attr("assetflag")=="add") {
                $("#c_reset").click();
                $("#c_assetId").val(data._id);
                $("#c_asset_number").val(data.asset_no);
                $("#c_device_name").val(data.device_name);
                $("#c_serial_number").val(typeof(data.serial) == 'undefined' ? '' : data.serial);
                $("#c_site").val(typeof(data.site_name) == 'undefined' ? '' : data.site_name);
                $("#c_order_name").val(""+data.device_name+schneider.util.dateFormat(new Date().getTime(), "yyyy-MM-dd hh:mm").replace(/-/g,"").replace(/\s/g,"").replace(/:/g,""));
                $("#c_site_address").val(typeof(data.site_info.address) == 'undefined' ? '' : data.site_info.address);
                if(data.site_info.contact) {
                    $("#c_contact").val(typeof(data.site_info.contact.name) == 'undefined' ? '' : data.site_info.contact.name);
                    $("#c_phone").val(typeof(data.site_info.contact.phone) == 'undefined' ? '' : data.site_info.contact.phone);
                }
            }else {
                $("#d_asset_reset").click();
                $("#d_site_Id").val(data.site_id);
                $("#d_asset_Id").val(data._id); //故障设备id
                $("#d_asset_number").val(data.asset_no); //故障设备编号
                $("#d_device_name").val(data.device_name); //设备名称
                $("#d_serial_number").val(typeof(data.serial) == 'undefined' ? '' : data.serial); //设备序列号
                $("#d_site").val(typeof(data.site_name) == 'undefined' ? '' : data.site_name); //现场名称
                $("#d_order_name").val(""+data.device_name+schneider.util.dateFormat(new Date().getTime(), "yyyy-MM-dd hh:mm").replace(/-/g,"").replace(/\s/g,"").replace(/:/g,""));
                $("#d_site_address").val(typeof(data.site_info.address) == 'undefined' ? '' : data.site_info.address); //现场地址
                if(data.site_info.contact) {
                    $("#d_contact").val(typeof(data.site_info.contact.name) == 'undefined' ? '' : data.site_info.contact.name); //联系人
                    $("#d_phone").val(typeof(data.site_info.contact.phone) == 'undefined' ? '' : data.site_info.contact.phone); //电话
                }
            }
            $("#modal_asset_list").modal("hide"); //关闭故障设备列表模态框


        }

        /**
         * 关闭设备列表模态框
         */
        function close_asset_modal() {
            $("#modal_asset_list").modal("hide"); //关闭故障设备列表模态框
        }

        /**
         * 切换保修信息tab页
         */
        $("#repair_info").click(function (event) {
            $("#c_orderTabs li").removeClass('active');
            $(this).addClass('active');
            $("#c_repair_div").show();
            $("#c_adjunct_div").hide();
        });

        /**
         * 切换附件信息tab页
         */
        $("#adjunct_info").click(function (event) {
            $("#c_orderTabs li").removeClass('active');
            $(this).addClass('active');
            $("#c_repair_div").hide();
            $("#c_adjunct_div").hide();
        });
    </script>