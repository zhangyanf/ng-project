<!--工单详情tab页面-->

<div class="panel panel-default" style="margin-bottom: 10px;"><!--故障设备信息-->
    <div class="panel-heading" style="padding: 8px 15px;" lang="text:fault_device_info"></div>
    <div class="panel-body" style="padding: 5px 15px 0px 15px;">
        <form class="form" id="d_order_form">
            <input type="reset" style="display: none;" id="d_asset_reset"/>
            <input type="hidden" value="" id="d_asset_Id"/>
            <input type="hidden" value="" id="d_site_Id"/>
            <div class="row">
                <div class="col-sm-3">
                    <div class="form-group">
                        <label><span lang="text:asset_number"></span>
                            <span class="text-red">*</span>
                        </label>
                        <div class="has-feedback">
                            <input type="text" class="form-control input-sm" id="d_asset_number" readonly="readonly" lang="placeholder:asset_number" >
                            <div data-permissionFilter="[201,203,205]" id="is_disabled">
                                <span style="font-size:16px;line-height: 30px;"  class="form-control-feedback glyphicon glyphicon-search"></span>
                                <span style="border:1px solid #eee;width:30px;height:28px;position:absolute;right: 1px;cursor: pointer;" lang="title:query" class="glyphicon" onclick="showModal_asset_list('edit')"></span>
                            </div>
                        </div>
                        <!--
                        <input type="text" class="form-control input-sm"
                               id="d_asset_number" readonly="readonly" lang="placeholder:asset_number">
                        <button type="button" style="display: block;margin-top: -30px;height:30px;"　
                                onclick="showModal_asset_list('edit')" data-permissionFilter="[201,203,205]"
                                class="btn btn-default btn-sm pull-right" data-toggle="tooltip" title="查找" lang="title:query"
                                id="is_disabled">
                            <span class="glyphicon glyphicon-search"></span>
                        </button>-->
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="form-group">
                        <label><span lang="text:device_name"></span></label>
                        <input type="text" class="form-control input-sm" readonly="readonly"
                               id="d_device_name" lang="placeholder:device_name">
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="form-group">
                        <label><span lang="text:serial_number"></span></label>
                        <input type="text" class="form-control input-sm"
                               readonly="readonly" id="d_serial_number"
                               lang="placeholder:serial_number">
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="form-group">
                        <label><span lang="text:site"></span></label>
                        <input type="text" class="form-control input-sm" readonly="readonly" id="d_site"
                               lang="placeholder:site">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        <label><span lang="text:site_address"></span></label>
                        <input type="text" class="form-control input-sm"
                               readonly="readonly" id="d_site_address" lang="placeholder:site_address">
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="form-group">
                        <label><span lang="text:contact"></span></label>
                        <input type="text"  class="form-control input-sm"
                               readonly="readonly" id="d_contact" lang="placeholder:contact">
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="form-group">
                        <label><span lang="text:phone"></span></label>
                        <input type="text"  class="form-control input-sm"
                               readonly="readonly" id="d_phone" lang="placeholder:phone">
                    </div>
                </div>
            </div>
        </form>
    </div>
</div><!--故障设备信息-->

<div class="panel panel-default" style="margin-bottom: 10px;"><!--报修信息-->
    <div class="panel-heading" style="padding: 8px 15px;" lang="text:repair_status"></div>
    <div class="panel-body" style="padding: 5px 15px 0px 15px;">
        <form id="d_repair_form">
            <input type="reset" style="display:none" id="d_repair_reset"/>
            <input type="hidden" id="d_order_id" vlaue=""/>
            <input type="hidden" id="d_order_no" vlaue=""/>
            <div class="row">
                <div class="col-sm-3">
                    <div class="form-group">
                        <label><span lang="text:order_name"></span><span class="text-red">*</span></label>
                        <input type="text"
                               class="form-control input-sm validate[required,specialCharacter,maxSize[30]] inputIsReadOnly"
                               id="d_order_name" lang="placeholder:order_name">
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="form-group">
                        <label><span lang="text:repair_date"></span><span class="text-red">*</span></label>
                        <div class="has-feedback">
                            <input type="text" class="form-control input-sm" id="d_repair_date"
                                   readonly="readonly">
                            <span class="glyphicon glyphicon-calendar form-control-feedback" style="right: 0;"></span>
                        </div>
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="form-group">
                        <label><span lang="text:repair_man"></span></label>
                        <input type="text"
                               class="form-control input-sm validate[specialCharacter,maxSize[30]] inputIsReadOnly"
                               id="d_repair_man" lang="placeholder:repair_man">
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="form-group">
                        <label><span lang="text:repair_phone"></span></label>
                        <input type="text"
                               class="form-control input-sm validate[custom[phone]] inputIsReadOnly"
                               id="d_repair_phone" lang="placeholder:repair_phone">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <div class="form-group">
                        <label><span lang="text:assigned_engineer"></span></label>
                        <select type="text" class="form-control input-sm inputIsDisabled"
                                id="d_assigned_engineer">
                            <option value="" lang="text:--+please_select_engineer+--">
                            </option>
                        </select>
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="form-group">
                        <label><span lang="text:order_type"></span></label>
                        <input type="text" class="form-control input-sm " value="" readonly="readonly" id="d_order_type">
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="form-group">
                        <label><span lang="text:fault_type"></span></label>
                        <select type="text" class="form-control input-sm inputIs inputIsDisabled" id="d_fault_type" >
                            <option value="1" selected="selected" lang="text:no_halt_fault"></option>
                            <option value="2" lang="text:halt_fault"></option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label><span lang="text:fault_phenomenon"></span></label>
                        <textarea rows="4" class="form-control input-sm validate[maxSize[500]] inputIsReadOnly" id="d_fault_phenomenon" style="resize:none;" lang="placeholder:fault_phenomenon"></textarea>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div><!--报修信息-->

<div class="panel panel-default" style="margin-bottom: 10px;"><!--工单信息-->
    <div class="panel-heading" style="padding: 8px 15px;" lang="text:order_info"></div>
    <div class="panel-body" style="padding: 5px 15px 0px 15px;">
        <form id="d_orderInfo_form">
            <input type="reset" style="display: none;" id="d_order_reset"/>
            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <div id="orderState_div">
                            <div class="sui-steps" style="display:none;" id="stepOne"><!--这一种状态条，人工报修对应的状态条（state！==rejected)-->
                                <div class="wrap">
                                    <div class="todo">
                                        <label><span lang="text:new2"></span></label><i class="triangle-right-bg"></i><i class="triangle-right"></i>
                                    </div>
                                </div>
                                <div class="wrap">
                                    <div class="todo">
                                        <label><span lang="text:accepted"></span></label><i class="triangle-right-bg"></i><i class="triangle-right"></i>
                                    </div>
                                </div>
                                <div class="wrap">
                                    <div class="todo">
                                        <label><span lang="text:processing"></span></label><i class="triangle-right-bg"></i><i class="triangle-right"></i>
                                    </div>
                                </div>
                                <div class="wrap">
                                    <div class="todo">
                                        <label><span lang="text:finished"></span></label><i class="triangle-right-bg"></i><i class="triangle-right"></i>
                                    </div>
                                </div>
                                <div class="wrap">
                                    <div class="todo">
                                        <label><span lang="text:closed"></span></label>
                                    </div>
                                </div>
                            </div><!--这一种状态条，人工报修对应的状态条（state！==rejected)-->
                            <div class="sui-steps" style="display:none;" id="stepTwo"><!--这一种状态条，人工报修对应的状态条（state=rejected)-->
                                <div class="wrap">
                                    <div class="todo">
                                        <label><span lang="text:new2"></span></label><i class="triangle-right-bg"></i><i class="triangle-right"></i>
                                    </div>
                                </div>
                                <div class="wrap">
                                    <div class="todo">
                                        <label><span lang="text:accepted"></span></label><i class="triangle-right-bg"></i><i class="triangle-right"></i>
                                    </div>
                                </div>
                                <div class="wrap">
                                    <div class="todo">
                                        <label><span lang="text:rejected"></span></label><i class="triangle-right-bg"></i><i class="triangle-right"></i>
                                    </div>
                                </div>
                                <div class="wrap">
                                    <div class="todo">
                                        <label><span lang="text:accepted"></span></label><i class="triangle-right-bg"></i><i class="triangle-right"></i>
                                    </div>
                                </div>
                                <div class="wrap">
                                    <div class="todo">
                                        <label><span lang="text:processing"></span></label><i class="triangle-right-bg"></i><i class="triangle-right"></i>
                                    </div>
                                </div>
                                <div class="wrap">
                                    <div class="todo">
                                        <label><span lang="text:finished"></span></label><i class="triangle-right-bg"></i><i class="triangle-right"></i>
                                    </div>
                                </div>
                                <div class="wrap">
                                    <div class="todo">
                                        <label><span lang="text:closed"></span></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-4">
                    <div class="form-group">
                        <label><span lang="text:reply_time"></span></label>
                        <div class="has-feedback">
                            <input type="text" class="form-control input-sm" id="d_reply_time"
                                   lang="placeholder:reply_time" readonly>
                            <span class="glyphicon glyphicon-calendar form-control-feedback" style="right: 0;"></span>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="form-group">
                        <label><span lang="text:arrival_time"></span></label>
                        <div class="has-feedback">
                            <input type="text" class="form-control input-sm" id="d_arrival_time"
                                   lang="placeholder:arrival_time" readonly>
                            <span class="glyphicon glyphicon-calendar form-control-feedback" style="right: 0;"></span>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="form-group">
                        <label><span lang="text:start_time"></span></label>
                        <input type="text" class="form-control input-sm" id="d_start_time"　
                               lang="placeholder:start_time" readonly>
                    </div>
                </div>
            </div>
            <div class="row" id="repairInfoRow">
                <div class="col-sm-4">
                    <div class="form-group">
                        <label><span lang="text:end_time"></span></label>
                        <input type="text" class="form-control input-sm" id="d_end_time"　
                               lang="placeholder:end_time" readonly>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="form-group">
                        <label><span lang="text:work_time"></span></label>
                        <input type="text" class="form-control input-sm" id="d_work_time"
                               lang="placeholder:work_time" readonly>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div><!--工单信息-->

<div id="repairLog" style="margin-top: 10px;"><!-- 维修记录 部件-->
    <div class="nav-tabs-custom" >
        <ul class="nav nav-tabs" role="tablist" id="repairTabs" style="background-color: #f5f5f5;">
            <li role="presentation" class="active">
                <a role="tab" data-toggle="tab" id="tab_repariInfo_a" lang="text:repair_record" href="#d_repair_info_div" style="border-left-color: #ddd;"></a>
            </li>
        </ul>
        <!-- Tab panes  tab-content-->
        <div class="tab-content" style="padding: 5px 15px 0px 15px;border: 1px solid #dddddd;border-top: none;">
            <!--维修记录-->
            <div role="tabpanel" class="tab-pane active row" id="d_repair_info_div">
                <div class="row worklogBtnbar" style="margin: 0px 15px;">
                    <div class="form-group pull-right" style="padding: 5px 0px;">
                        <button type="button" class="btn btn-default btn-sm"   onclick="show_repair_tab('add');"
                                data-permissionFilter="[216]"
                                data-toggle='tooltip' data-placement="bottom" lang="title:add"
                                onclick="">
                            <i class="glyphicon glyphicon-plus"></i>
                        </button>
                        <!-- <button type="button" class="btn btn-default btn-sm" title='删除'
                                 data-permissionFilter="[216]"
                                 data-toggle='tooltip' data-placement="bottom" lang="title:delete"
                                 onclick="delLogs()">
                             <i class="glyphicon glyphicon-minus"></i>
                         </button>-->
                    </div>
                </div>
                <div class="row" style="margin: 0px 15px;">
                    <table class="table table-bordered table-hover table-striped">
                        <thead >
                        <tr>
                            <!--<th id="r_tableHead_selectAll" class="text-center" style="width:30px">
                                <input type="checkbox" id="r_tableHead_checkbok" data-toggle='tooltip'
                                       data-placement="bottom" lang="title:check_all">
                            </th>-->
                            <th  lang="text:device_sense" > </th>
                            <th lang="text:start_time" > </th>
                            <th lang="text:end_time" > </th>
                            <th lang="text:work_time" > </th>
                            <th  lang="text:operate" class="text-center" style="width:80px;"></th>
                        </tr>
                        </thead>
                        <tbody id="logContent_tbl" >

                        </tbody>
                    </table>
                </div>
            </div>
            <!--添加编辑维修记录模板-->
            <div role="tabpanel" class="tab-pane" id="d_repair_template_div">
                <div class="row"><div  class="col-sm-3"><div class="form-group"> <label><span lang="text:repair_info+:"></span></label></div></div></div>
                <form id="repairForm">
                    <input type="reset" style="display: none;" id="maintain_reset"/>
                    <input type="hidden" id="wo_log_id" value=""/>
                    <div class="row">
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label><span lang="text:device_sense"></span></label>
                                <input type="text" class="form-control input-sm" id="d_device_sense"
                                       lang="placeholder:device_sense" readonly="readonly">
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label><span lang="text:start_time"></span><span class="text-red">*</span></label>
                                <div class="has-feedback">
                                    <input type="text" class="form-control input-sm validate[required]" id="d_repair_start_time"
                                           readonly="readonly">
                                    <span class="glyphicon glyphicon-calendar form-control-feedback" style="right: 0;"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label><span lang="text:end_time"></span><span class="text-red">*</span></label>
                                <div class="has-feedback">
                                    <input type="text" class="form-control input-sm validate[required]" id="d_repair_end_time"
                                           readonly="readonly">
                                    <span class="glyphicon glyphicon-calendar form-control-feedback" style="right: 0;"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label><span lang="text:work_time"></span></label>
                                <input type="text" class="form-control input-sm" id="d_repair_work_time"
                                       lang="placeholder:work_time" readonly="readonly">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label><span lang="text:comment"></span></label>
                                <textarea rows="4" class="form-control validate[maxSize[500]] inputIsReadOnly" id="d_repair_comment" style="resize: none; " lang="placeholder:comment" ></textarea>
                            </div>
                        </div>
                    </div>
                </form>
                <div class="row" style="padding: 0px 15px;">
                    <div class="row" style="padding: 0px 15px;">
                        <div class="form-group pull-left" style="padding: 5px 0px;">
                            <label><span lang="text:repair_part+:"></span></label>
                        </div>
                        <div class="worklogBtnbar form-group pull-right" style="padding: 5px 0px;">
                            <button type="button" class="btn btn-default btn-sm"   onclick="show_repair_part_modal('add')"
                                    data-permissionFilter="[206,201,203,205]"
                                    data-toggle='tooltip' data-placement="bottom" lang="title:add"
                                    onclick="">
                                <i class="glyphicon glyphicon-plus"></i>
                            </button>
                            <!--<button type="button" class="btn btn-default btn-sm" title='删除'
                                    data-permissionFilter="[ ]"
                                    data-toggle='tooltip' data-placement="bottom" lang="title:delete"
                                    onclick="delPart()">
                                <i class="glyphicon glyphicon-minus"></i>
                            </button>-->
                        </div>
                    </div>
                    <!--更换部件列表-->
                    <div class="row" style="padding: 0px 15px;">
                        <table class="table table-bordered table-hover table-striped scrolltable">
                            <thead>
                            <tr>
                                <!--<th id="rpart_tableHead_selectAll" style="width:46px;" class="text-center">
                                    <input type="checkbox" id="rpart_tableHead_checkbok" data-toggle='tooltip'
                                           data-placement="bottom" lang="title:check_all">
                                </th>-->
                                <th lang="text:component_name"></th>
                                <th lang="text:part_no"></th>
                                <th lang="text:serial_number"></th>
                                <th lang="text:device_part_model"></th>
                                <th lang="text:change_time_recently"></th>
                                <th lang="text:maintenance_time_recently"></th>
                                <th lang="text:price"></th>
                                <th lang="text:supplier"></th>
                                <th lang="text:purchasing_time"></th>
                                <th id="operateTH" lang="text:operate" class="text-center worklogBtnbar" style="width:80px"></th>

                            </tr>
                            </thead>
                            <tbody id="d_parts" >

                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer" style="padding-top: 15px;padding-right: 0px;padding-bottom: 10px;">
                        <button type="button" class="btn btn-default" onclick="closeRepairTab()" data-dismiss="modal"
                                lang="text:close">
                        </button>
                        <button class="worklogBtnbar btn btn-primary" id="" onclick="submitRepair()" lang="text:submit">
                        </button>
                    </div>
                    <!--维修记录日志-->
                    <div class="row" style="padding: 0px 15px;">
                        <div class="panel panel-default"><div class="panel-heading"><strong lang="text:parts+-+maintenance_history"></strong></div>
                            <div class="panel-body" style="height:410px;overflow:auto;padding-top: 0;padding-bottom: 0;margin-top: 15px;"
                                 ng-scrollbar="" scrollbar-x="true" scrollbar-y="true">
                                <table class="table table-bordered table-striped">
                                    <thead>
                                    <tr>
                                        <th lang="text:machine"></th>
                                        <th lang="text:component_name"></th>
                                        <th lang="text:part_no"></th>
                                        <th lang="text:repair_type"></th>
                                        <th lang="text:change_time"></th>
                                        <th lang="text:maintenance_time"></th>
                                        <th lang="text:serial_number"></th>
                                        <th lang="text:device_part_model"></th>
                                        <th lang="text:price"></th>
                                        <th lang="text:supplier"></th>
                                        <th lang="text:purchasing_time"></th>
                                    </tr>
                                    </thead>
                                    <tbody id="parts_modal">
                                    <!--动态添加数据-->
                                    </tbody>
                                </table>
                            </div>
                            <div id="page-footer3">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div><!--维修记录 部件-->

<div class="modal-footer" id="d_modal_footer" style="padding-top: 15px;padding-right: 0px;padding-bottom: 10px;">

</div>

<script >

    /***
     * ---------------------------------------------------------工单详情---------------------------------------------------------------
     */
    /**
     * 工单信息表单校验
     */
    validator.render("#d_orderInfo_form", {
        promptPosition: "inline",
        scroll: false
    });

    /**
     *  详情页面报修信息表单校验
     */
    validator.render("#d_repair_form", {
        promptPosition: "inline",
        scroll: false
    });

    /**
     *  详情页面报修信息表单校验
     */
    validator.render("#d_maintain_form", {
        promptPosition: "inline",
        scroll: false
    });


    /**
     * 开始时间 结束时间绑定日期插件
     */
    $("#d_reply_time").daterangepicker(picker2Option);
    $("#d_arrival_time").daterangepicker(picker2Option);
    $("#d_repair_date").daterangepicker(picker2Option);

    $("#d_repair_date").mousedown(function(){
        setCurrentDate("d_repair_date");
    });
    $("#d_reply_time").mousedown(function(){
        setCurrentDate("d_reply_time");
    });
    $("#d_arrival_time").mousedown(function(){
        setCurrentDate("d_arrival_time");
    });
    /**
     * 添加或编辑页面的工作开始时间和工作结束时间绑架日期插件
     */
    $("#d_repair_start_time").daterangepicker(picker2Option);
    $("#d_repair_end_time").daterangepicker(picker2Option);
    $("#d_repair_start_time").mousedown(function(){
        setCurrentDate("d_repair_start_time");
    });
    $("#d_repair_end_time").mousedown(function(){
        setCurrentDate("d_repair_end_time");
    });

    /**
     * 根据orderId渲染工单详情页面
     */
    function renderOrderDetail(orderId){
        //清空故障设备信息
        $("#d_asset_reset").click();
        //清空报修信息
        $("#d_repair_reset").click();
        //清空工单信息
        $("#d_order_reset").click();
        //关闭创建和编辑维修记录的tab页面
        closeRepairTab();
        getOrderDetail(false,orderId,function(data){
            if(data.result) {
                fillOrderDetailInfo(data.result);
                if(data.result.logs!=undefined && data.result.logs.length>0){
                    fillOrderLogs(data.result.logs);
                }else{
                    $("#logContent_tbl").empty();
                    $("#logContent_tbl").append('<tr><td colspan="6"  align="center" lang="text:no_data"></td></tr>');
                    locale.render({element: "#init_body"});
                }
            }
        },this);
    }
    /**
     * 填充维修记录列表
     */
    function fillOrderLogs(logs){
        $("#logContent_tbl").empty();
        var str;
        $.each(logs, function (n, log) {
            str += "<tr id='"+log._id+"'>" +
                /*"<td><input type='checkbox' value='" + log._id + "' class='tabs-checked text-center'></td>" +*/
                "<td>" + (typeof(log.owner) == "undefined" ? "" : log.owner)+ "</td>" +
                "<td>" + (typeof(log.start) == "undefined" ? "" : schneider.util.dateFormat(log.start, "yyyy-MM-dd hh:mm")) + "</td>" +
                "<td>" + (typeof(log.end) == "undefined" ? "" : schneider.util.dateFormat(log.end, "yyyy-MM-dd hh:mm")) + "</td>" +
                "<td>" + (typeof(log.working_time) == "undefined" ? "" : log.working_time) + "</td>" +
                "<td class='text-center worklogBtnbar'>" +
                "<span data-toggle='tooltip' class='glyphicon glyphicon-edit link-black' style='cursor: pointer;' lang='title:edit' data-permissionFilter='[50]' onclick='editWorklog(this,\""+log._id+"\")'>" +
                "</td>" +

                "</tr>";
        })
        $("#logContent_tbl").append(str);
        //给input添加onclick事件
        $("#logContent_tbl > tr > td > input").on("click", function () {
            var selected_rolesId = $("#logContent_tbl tr td input[type='checkbox']:checked");
            var allUsers_nowPage = $("#logContent_tbl tr td input");
            if (selected_rolesId.length < allUsers_nowPage.length) {
                $("#r_tableHead_checkbok").prop("checked", false);
            }
            if (selected_rolesId.length == allUsers_nowPage.length) {
                $("#r_tableHead_checkbok").prop("checked", true);
            }
        });
        locale.render({element: "#init_body"});
    }
    /**
     * 判断是否也显示添加或编辑维修信息tab页面了，没有就显示。
     */
    function showRepairLogTab(title) {
        if ($("#tab_repair_nav").length == 0) {
            $("#repairTabs").append(' <li role="presentation" class="tab_position" id="tab_repair_nav">' +
                '<a role="tab" data-toggle="tab" id="tab_repair_a" href="#d_repair_template_div">'+title+'</a>' +
                '<div class="pull-right tab_btn_close" data-toggle="tooltip" lang="title:close">' +
                '<button class="btn btn-box-tool tab_btn_close_color" onclick="closeRepairTab()"><i class="glyphicon glyphicon-remove"></i></button>' +
                '</div></li>');
            //点击添加或编辑维修信息tab页面li标签时影藏，工单详情提交按钮
            $("#tab_repair_a").click(function(){
                $("#d_modal_footer").hide();
            });
        }else{
            $("#tab_repair_a").text(title);
        }
        $("#tab_repair_a").click();
        $(".formErrorContent").hide();
        //清空添加和编辑维修信息tab页面数据
        $("#maintain_reset").click();
        $("#editPartFlag").val("");
        //隐藏工单详情页面的提交按钮
        $("#d_modal_footer").hide();
    }
    /**
     *编辑维修记录
     */
    function editWorklog(ele,logId){
        //判断到场时间是否填写
        if (!$("#d_arrival_time").val()) {
            errorTipDis("reach_time_not_null");
            return;
        }
        var self = this;
        getOrderLogInfo(logId,function(data){
            if(data.result!=undefined && data.result.log){
                var log = data.result.log ;
                self.showRepairLogTab(locale.get("edit_repair_record"));
                if(data.result.wo!=undefined && data.result.wo.state=="closed"){
                    $("#worklogBtnbar").hide();
                }
                //回填维修信息 工作开始时间 工作结束时间 工作时长 备注
                $("#wo_log_id").val(log._id);
                $("#d_repair_start_time").val( (typeof(log.start) == "undefined" ? "" : schneider.util.dateFormat(log.start, "yyyy-MM-dd hh:mm")));
                $("#d_repair_end_time").val((typeof(log.end) == "undefined" ? "" : schneider.util.dateFormat(log.end, "yyyy-MM-dd hh:mm")));
                $("#d_repair_work_time").val(log.working_time);
                $("#d_repair_comment").val((typeof(log.comment) == "undefined" ? "" : log.comment));
                $("#d_device_sense").val(typeof(log.owner) == "undefined" ? "" : log.owner);

                if(data.result.parts!=undefined && data.result.parts.length>0){
                    renderParts(data.result.parts);
                    if(data.result.wo.state=="closed" || data.result.wo.state=="rejected"){
                        $("#d_parts > tr > td:last").hide();
                    }
                }else{
                    $("#d_parts").empty();
                    $("#d_parts").append('<tr><td colspan="11"  align="center" lang="text:no_data"></td></tr>');
                    locale.render({element: "#init_body"});
                }

                if(data.result.logs!=undefined && data.result.logs.length>0){
                    renderPartRepairLogs(data.result.logs);
                }else{
                    $("#parts_modal").empty();
                    $("#parts_modal").append('<tr><td colspan="11"  align="center" lang="text:no_data"></td></tr>');
                    locale.render({element: "#init_body"});
                }
            }
        },this);
    }

    /**
     * 渲染部件列表
     */
    function renderParts(parts){
        $("#d_parts").empty();
        var str;
        $.each(parts, function (n, part) {
            var str =
                '<tr id=' + part._id + '>'+
                /*"<td class='text-center'><input type='checkbox' value='" + part._id + "' class='tabs-checked text-center'></td>" +*/
                '<td>'+(typeof(part.part_name) == 'undefined'?'':part.part_name)+'</td>'+
                '<td>'+(typeof(part.part_no) == 'undefined'?'':part.part_no)+'</td>'+
                '<td>'+(typeof(part.serial) == 'undefined'?'':part.serial)+'</td>'+
                '<td>'+ (typeof(part.model) == 'undefined'?'':part.model)+'</td>'+
                '<td>'+ (typeof(part.last_replace_ts) == 'undefined'?'':schneider.util.dateFormat(part.last_replace_ts, "yyyy-MM-dd hh:mm")) +'</td>'+
                '<td>'+ (typeof(part.last_maintain_ts) == 'undefined'?'':schneider.util.dateFormat(part.last_maintain_ts, "yyyy-MM-dd hh:mm")) +'</td>'+
                '<td>'+(typeof(part.price) == 'undefined'?'':part.price)+'</td>'+
                '<td>'+(typeof(part.vendor_name) == 'undefined'?'':part.vendor_name)+'</td>'+
                '<td>'+ (typeof(part.purchase_date) == 'undefined'?'':schneider.util.dateFormat(part.purchase_date, "yyyy-MM-dd hh:mm"))+'</td>'+
                '<td class="text-center worklogBtnbar">'+
                '<span class="iconfont icon-config link-black" aria-hidden="true" id="changeModel" lang="title:part_maintain"  onclick="show_repair_part_modal(\'' + part._id + '\');" data-permissionFilter="[206,201,203,205]" style=" cursor: pointer;margin:0px 10px;"></span>'+
                '</td>'+
                '</tr>';

            $("#d_parts").append(str);
        })
        locale.render({element: "#init_body"});
    }
    /**
     * 渲染部件维修记录列表
     */
    function renderPartRepairLogs(logs){
        if($("#parts_modal > tr > td:first").text()==locale.get("no_data")) {
            $("#parts_modal").empty();
        }
        var pTable = "";
        for (var i = 0; i < logs.length; i++) {
            var per = logs[i];
            var stateCss = "";

            if(per.action == "1"){
                stateCss = "label-warning";
            }else{
                stateCss = "label-success";
            }
            pTable +=
                '<tr>' +
                '<td>' + (typeof(per.device_name) == 'undefined' ? '' : per.device_name) + '</td>' +
                '<td>' + (typeof(per.part_name) == 'undefined' ? '' : per.part_name) + '</td>' +
                '<td>' + (typeof(per.part_no) == 'undefined' ? '' : per.part_no) + '</td>' +
                '<td>' + '<span class="label '+stateCss+'">' + (typeof(per.tag) == 'undefined' ? '' : per.tag) +  '</span></td>' +
                '<td>' + (typeof(per.replace_time) == 'undefined' ? '' : schneider.util.dateFormat(per.replace_time, "yyyy-MM-dd hh:mm")) + '</td>' +
                '<td>' + (typeof(per.maintain_time) == 'undefined' ? '' : schneider.util.dateFormat(per.maintain_time, "yyyy-MM-dd hh:mm")) + '</td>' +
                '<td>' + (typeof(per.serial) == 'undefined' ? '' : per.serial) + '</td>' +
                '<td>' + (typeof(per.model) == 'undefined' ? '' : per.model) + '</td>' +
                '<td>' + (typeof(per.price) == 'undefined' ? '' : per.price) + '</td>' +
                '<td>' + (typeof(per.vendor_name) == 'undefined' ? '' : per.vendor_name) + '</td>' +
                '<td>' + (typeof(per.purchase_date) == 'undefined' ? '' : schneider.util.dateFormat(per.purchase_date, "yyyy-MM-dd")) + '</td>' +
                '</tr>';

        }
        $("#parts_modal").empty().append(pTable);
        locale.render({element: "#init_body"});
    }

    /**
     * 回填工单详情信息
     */
    function fillOrderDetailInfo(data) {
        //回填故障设备信息
        $("#d_asset_Id").val(data.wo.asset_id); //故障设备id
        $("#d_site_Id").val(data.wo.site_id);
        $("#d_order_number").val(data.wo.order_no); //工单编号
        $("#d_asset_number").val(data.asset.asset_no); //故障设备编号
        $("#d_device_name").val(data.asset.device_name); //设备名称
        $("#d_serial_number").val(data.asset.serial); //设备序列号
        $("#d_assigned_engineer > option").removeAttr("selected");
        if(data.site) {
            $("#d_site").val(data.site.name); //现场名称
            $("#d_site_address").val(data.site.address); //现场地址
            if(data.site.contact) {
                $("#d_contact").val(data.site.contact.name); //联系人
                $("#d_phone").val(data.site.contact.phone); //电话
            }
        }
        //回填报修信息
        $("#d_order_id").val(data.wo._id); //工单id
        $("#d_order_no").val(data.wo.order_no); //工单编号
        $("#d_repair_date").val(schneider.util.dateFormat(data.wo.create_time, "yyyy-MM-dd hh:mm")); //报修日期
        $("#d_repair_man").val(data.wo.creator); //报修人
        $("#d_repair_phone").val(data.wo.repair_call); //报修电话
        var  arrOption = $("#d_assigned_engineer > option");
        for(var i = 0; i < arrOption.length; i++) {
            if($(arrOption[i]).val()==data.wo.executor_id) {
                $(arrOption[i]).prop("selected","selected");
                break;
            }
        }
        var order_type = data.wo.order_type; //工单类型 1：人工报修的工单；2：报警转故障工单； 3: 预防性计划工单
        if(order_type==1) {
            $("#d_order_type").val(locale.get("artificial_service_work_sheet"));

        }else if(order_type==2) {
            $("#d_order_type").val(locale.get("alarm_fault_repair_order"));
        }else if(order_type==3) {
            $("#d_order_type").val(locale.get("preventive_plan_work_order"));
        }else if(order_type==4){
            $("#d_order_type").val(locale.get("temporary_work_order"));
        }

        $("#d_fault_phenomenon").val(data.wo.comment); //备注
        //回填维修信息
        if(data.wo.reply_time) {
            $("#d_reply_time").val(schneider.util.dateFormat(data.wo.reply_time, "yyyy-MM-dd hh:mm"));
        }
        if(data.wo.working_start!=undefined) {
            $("#d_start_time").val(schneider.util.dateFormat(data.wo.working_start, "yyyy-MM-dd hh:mm"));//工作开始时间
        }
        if(data.wo.working_end!=undefined) {
            $("#d_end_time").val(schneider.util.dateFormat(data.wo.working_end, "yyyy-MM-dd hh:mm"));//工作结束时间
        }
        if(data.wo.reach_time!=undefined) {
            $("#d_arrival_time").val(schneider.util.dateFormat(data.wo.reach_time, "yyyy-MM-dd hh:mm"));//工作结束时间
        }

        if(data.wo.working_time!=undefined) {
            if(round2((data.wo.working_time/3600),2)) {
                $("#d_work_time").val(round2((data.wo.working_time/3600),2)); //工作时长
            }
        }
        var fault_type = data.wo.fault_type;
        if(fault_type==1) {
            $("#d_fault_type > option:eq(0)").prop("selected",true);
        }else if (fault_type==2) {
            $("#d_fault_type > option:eq(1)").prop("selected",true);
        }
        //回填工单信息
        //回填工单状态
        $("#d_order_name").val(data.wo.name); // 工单名称
        var state = data.wo.state;
        if(state=="new") {
            $(".inputIsReadOnly").attr("readonly",false);
            $(".inputIsDisabled").attr("disabled",false);
            if(order_type==1) { // 只有人工报修的工单才可以修改报修时间
                $("#d_repair_date").attr("disabled",false);
                $("#is_disabled").removeAttr("hidden");
            }else{
                $("#d_repair_date").attr("disabled",true);
                $("#is_disabled").attr("hidden","hidden");
            }
            $("#d_reply_time").attr("disabled",true);
            $("#d_arrival_time").attr("disabled",true);
            $("#repairLog").hide();
            $(".worklogBtnbar").show();
            $("#stepOne").show();
            $("#stepTwo").hide();
            $("#stepOne > .wrap > div").removeClass().addClass("todo");
            $("#stepOne > .wrap:eq(0) > div").removeClass().addClass("current");
        }else if(state=="accepted") {
            $(".inputIsReadOnly").attr("readonly",false);
            $(".inputIsDisabled").attr("disabled",false);
            $("#d_arrival_time").attr("disabled",false);
            $("#d_reply_time").attr("disabled",false);
            $("#d_repair_date").attr("disabled",true);
            $("#d_arrival_time").attr("disabled",false);
            $("#is_disabled").attr("hidden","hidden");
            $("#repairLog").show();
            $(".worklogBtnbar").hide();
            $("#stepOne").show();
            $("#stepTwo").hide();
            $("#stepOne > .wrap > div").removeClass().addClass("todo");
            $("#stepOne > .wrap:eq(0) > div").removeClass().addClass("finished");
            $("#stepOne > .wrap:eq(1) > div").removeClass().addClass("current");
        }else if(state=="processing") {
            $(".inputIsReadOnly").attr("readonly",false);
            $(".inputIsDisabled").attr("disabled",false);
            $("#d_arrival_time").attr("disabled",true);
            $("#d_reply_time").attr("disabled",true);
            $("#d_repair_date").attr("disabled",true);
            $("#is_disabled").attr("hidden","hidden");
            $("#repairLog").show();
            $(".worklogBtnbar").show();
            $("#stepOne").show();
            $("#stepTwo").hide();
            $("#stepOne > .wrap > div").removeClass().addClass("todo");
            $("#stepOne > .wrap:eq(0) > div").removeClass().addClass("finished");
            $("#stepOne > .wrap:eq(1) > div").removeClass().addClass("finished");
            $("#stepOne > .wrap:eq(2) > div").removeClass().addClass("current");
        }else if(state=="finished") {
            $(".inputIsReadOnly").attr("readonly",false);
            $(".inputIsDisabled").attr("disabled",false);
            $("#d_arrival_time").attr("disabled",true);
            $("#d_reply_time").attr("disabled",true);
            $("#d_repair_date").attr("disabled",true);
            $("#is_disabled").attr("hidden","hidden");
            $("#repairLog").show();
            $(".worklogBtnbar").hide();
            $("#stepOne").show();
            $("#stepTwo").hide();
            $("#stepOne > .wrap > div").removeClass().addClass("todo");
            $("#stepOne > .wrap:eq(0) > div").removeClass().addClass("finished");
            $("#stepOne > .wrap:eq(1) > div").removeClass().addClass("finished");
            $("#stepOne > .wrap:eq(2) > div").removeClass().addClass("finished");
            $("#stepOne > .wrap:eq(3) > div").removeClass().addClass("current");
        }else if(state=="closed") {
            $(".inputIsReadOnly").attr("readonly",true);
            $(".inputIsDisabled").attr("disabled",true);
            $("#d_arrival_time").attr("disabled",true);
            $("#d_reply_time").attr("disabled",true);
            $("#d_repair_date").attr("disabled",true);
            $("#is_disabled").attr("hidden","hidden");
            $("#repairLog").show();
            $(".worklogBtnbar").hide();
            $("#stepOne").show();
            $("#stepTwo").hide();
            $("#stepOne > .wrap > div").removeClass().addClass("todo");
            $("#stepOne > .wrap:eq(0) > div").removeClass().addClass("finished");
            $("#stepOne > .wrap:eq(1) > div").removeClass().addClass("finished");
            $("#stepOne > .wrap:eq(2) > div").removeClass().addClass("finished");
            $("#stepOne > .wrap:eq(3) > div").removeClass().addClass("finished");
            $("#stepOne > .wrap:eq(4) > div").removeClass().addClass("current");
        }else if(state=="rejected") {
            $(".inputIsReadOnly").attr("readonly",false);
            $(".inputIsDisabled").attr("disabled",false);
            $("#d_arrival_time").attr("disabled",true);
            $("#d_reply_time").attr("disabled",true);
            $("#d_repair_date").attr("disabled",true);
            $("#is_disabled").attr("hidden","hidden");
            $("#repairLog").show();
            $(".worklogBtnbar").hide();
            $("#stepOne").hide();
            $("#stepTwo").show();
            $("#stepTwo > .wrap > div").removeClass().addClass("todo");
            $("#stepTwo > .wrap:eq(0) > div").removeClass().addClass("finished");
            $("#stepTwo > .wrap:eq(1) > div").removeClass().addClass("finished");
            $("#stepTwo > .wrap:eq(2) > div").removeClass().addClass("current");
        }
        //如果预计划工单中的schedule_type==2，就添加一个下一次截止日期
        $("#deadlineDiv").remove();
        if(typeof(data.schedule)!="undefined") {
            if(data.schedule.setting.schedule_type==2) {
                $("#repairInfoRow").append('<div id="deadlineDiv" class="col-sm-4">'+
                    '<div class="form-group">'+
                    '<label><span lang="text:next_deadline"></span></label>'+
                    '<input type="text" class="form-control input-sm" id="d_deadline"'+
                    'lang="placeholder:next_deadline" readonly="readonly">'+
                    '</div>'+
                    ' </div>');
                $("#d_deadline").daterangepicker(picker2Option);
            }else {
                $("#deadlineDiv").remove();
            }
        }

        //提交按钮显示 根据工单类型和工单状态来判断显示的不同的
        $("#d_modal_footer").empty();
        if(order_type==3) { //预防性工单
            if(state=="new") {
                $("#d_modal_footer").append('<button type="button" class="btn btn-primary" onclick="submitOrder(\'accepted\')" data-permissionFilter="[216]" data-dismiss="modal" lang="text:accepted"></button>'+
                    '<button type="button" class="btn btn-primary" onclick="saveOrder(\''+state+'\')"  data-permissionFilter="[216]" data-dismiss="modal" lang="text:save"></button>');
            }else if(state=="accepted") {
                $("#d_modal_footer").append('<button type="button" class="btn btn-primary" onclick="submitOrder(\'closed\')" data-permissionFilter="[216]" data-dismiss="modal" lang="text:finished_order"></button>'+
                    '<button type="button" class="btn btn-primary" onclick="saveOrder(\''+state+'\')" data-permissionFilter="[216]" data-dismiss="modal" lang="text:save"></button>');
            }else if(state=="processing") {
                $("#d_modal_footer").append('<button type="button" class="btn btn-primary" onclick="submitOrder(\'closed\')" data-permissionFilter="[216]" data-dismiss="modal" lang="text:finished_order"></button>'+
                    '<button type="button" class="btn btn-primary" onclick="saveOrder(\''+state+'\')" data-permissionFilter="[216]" data-dismiss="modal" lang="text:save"></button>');
            }
        }else { // 人工报修 告警转故障
            if(state=="new") {
                $("#d_modal_footer").append('<button type="button" class="btn btn-primary" onclick="submitOrder(\'accepted\')" data-permissionFilter="[216]" data-dismiss="modal" lang="text:accepted"></button>'+
                    '<button type="button" class="btn btn-primary" onclick="saveOrder(\''+state+'\')" data-permissionFilter="[216]" data-dismiss="modal" lang="text:save"></button>');
            }else if(state=="accepted") {
                $("#d_modal_footer").append('<button type="button" class="btn btn-primary" onclick="submitOrder(\'rejected\')" data-permissionFilter="[216]" data-dismiss="modal" lang="text:rejected_order"></button>'+
                    '<button type="button" class="btn btn-primary" onclick="saveOrder(\''+state+'\')" data-permissionFilter="[216]" data-dismiss="modal" lang="text:save"></button>');
            }else if(state=="processing") {
                $("#d_modal_footer").append('<button type="button" class="btn btn-primary" onclick="submitOrder(\'rejected\')" data-permissionFilter="[216]" data-dismiss="modal" lang="text:rejected_order"></button>'+
                    '<button type="button" class="btn btn-primary" onclick="submitOrder(\'finished\')" data-permissionFilter="[216]" data-dismiss="modal" lang="text:finished_order"></button>'+
                    '<button type="button" class="btn btn-primary" onclick="saveOrder(\''+state+'\')" data-permissionFilter="[216]" data-dismiss="modal" lang="text:save"></button>');
            }else if(state=="finished") {
                $("#d_modal_footer").append('<button type="button" class="btn btn-primary" onclick="submitOrder(\'closed\')" data-permissionFilter="[216]" data-dismiss="modal" lang="text:closed_order"></button>'+
                    '<button type="button" class="btn btn-primary" onclick="saveOrder(\''+state+'\')" data-permissionFilter="[216]" data-dismiss="modal" lang="text:save"></button>');
            }else if(state=="rejected") {
                $("#d_modal_footer").append('<button type="button" class="btn btn-primary" onclick="submitOrder(\'accepted\')" data-permissionFilter="[216]" data-dismiss="modal" lang="text:accepted"></button>'+
                    '<button type="button" class="btn btn-primary" onclick="saveOrder(\''+state+'\')" data-permissionFilter="[216]" data-dismiss="modal" lang="text:save"></button>');
            }
        }
        locale.render({element: "#init_body"});
    }

    /**
     * 保留到小数n位，v目标数 e位数
     */
    function round2(v,e){
        var t=1;
        for(;e>0;t*=10,e--);
        for(;e<0;t/=10,e++);
        return Math.round(v*t)/t;
    }

    /**
     * 接单时间校验 接单时间不能小于报修时间
     */
    $("#d_reply_time").change(function(){
        if(!$("#d_reply_time").prop("cacheDate")) {
            var d_reply_time = $("#d_reply_time").val();// 接单时间
            var d_repair_date = $("#d_repair_date").val();  // 报修时间
            var d_start_time = $("#d_start_time").val(); // 工作时间
            var d_arrival_time = $("#d_arrival_time").val();  // 到达时间
            if(d_reply_time&&d_repair_date) { // 接单时间不能小于报修时间
                var number = new Date(d_repair_date).getTime() - new Date(d_reply_time).getTime();
                if(number>0) {
                    errorTipDis("reply_time_nlt_create_time");
                }
            }

            if(d_reply_time&&d_arrival_time) { // 接单时间不能大于到达时间
                var number = new Date(d_reply_time).getTime() - new Date(d_arrival_time).getTime();
                if(number>0) {
                    errorTipDis("reply_time_ngt_reach_time"); // 接单时间不能大于到达时间
                }
            }

            if(d_reply_time&&d_start_time) { // 接单时间不能大于工作开始时间
                var number = new Date(d_reply_time).getTime() - new Date(d_start_time).getTime();
                if(number>0) {
                    errorTipDis("reply_time_ngt_start_time"); // 接单时间不能大于工作开始时间
                }
            }
        }
        $("#d_reply_time").prop("cacheDate","");
    });

    /**
     * 到达时间检验 到达时间不能小于接单时间
     */
    $("#d_arrival_time").change(function(){
        if(!$("#d_arrival_time").prop("cacheDate")) {
            var d_reply_time = $("#d_reply_time").val(); // 接单时间
            var d_arrival_time = $("#d_arrival_time").val();  // 到达时间
            var d_start_time = $("#d_start_time").val(); // 工作时间
            var d_repair_date = $("#d_repair_date").val();  // 报修时间
            if(d_arrival_time&&d_repair_date) { // 到场时间不能小于报修时间
                var number = new Date(d_repair_date).getTime() - new Date(d_arrival_time).getTime();
                if(number>0) {
                    errorTipDis("reach_time_nlt_create_time");
                }
            }
            if(d_reply_time&&d_arrival_time) { // 到达时间不能小于接单时间
                var number = new Date(d_reply_time).getTime() - new Date(d_arrival_time).getTime();
                if(number>0) {
                    errorTipDis("reach_time_nlt_reply_time");
                }
            }
            if(d_arrival_time&&d_start_time) { // 到达时间不能大于工作开始时间
                var number = new Date(d_arrival_time).getTime() - new Date(d_start_time).getTime();
                if(number>0) {
                    errorTipDis("reach_time_ngt_start_time");
                }
            }
        }
        $("#d_arrival_time").prop("cacheDate","");
    });

    /**
     * 计算时长（添加或编辑页面的工作时间和结束时间）
     */
    $("#d_repair_start_time").change(function(){
        // 消除不能为空的提示
        if($("#d_repair_start_time").val()) {
            $(".formErrorContent").remove();
        }
        if(!$("#d_repair_start_time").prop("cacheDate")) {
            //工作开始时间
            var statr_time = $("#d_repair_start_time").val(); //工作开始时间
           // var d_reply_time = $("#d_reply_time").val(); // 接单时间
            var d_arrival_time = $("#d_arrival_time").val(); // 到场时间
            var end_time = $("#d_repair_end_time").val();  //工作结束时间


           /* // 工作开始时间不能小于接单时间
            if(statr_time&&d_reply_time) {
                var date3 = new Date(d_reply_time).getTime() - new Date(statr_time).getTime();
                if(date3>0) {
                    errorTipDis("start_time_nlt_reply_time");
                   // $("#d_repair_start_time").val("");
                }
            }*/
            //工作开始时间不能小于到场时间
            if(statr_time&&d_arrival_time) {
                var date3 = new Date(d_arrival_time).getTime() - new Date(statr_time).getTime();
                if(date3>0) {
                    errorTipDis("start_time_nlt_reach_time");
                  //  $("#d_repair_start_time").val("");
                }
            }

            if(statr_time&&end_time) {
                var date3 = new Date(end_time).getTime() - new Date(statr_time).getTime();   //时间差的毫秒数
                if(date3>=0) {
                    //计算出小时数
                    var hours=date3/(3600*1000);
                    hours = round2(hours,2);
                    $("#d_repair_work_time").val(hours);
                }else {
                    errorTipDis("start_time_ngt_end_time");
                  /*  $("#d_repair_work_time").val("");
                    $("#d_repair_start_time").val("");*/
                }

            }
        }
        $("#d_repair_start_time").prop("cacheDate","");
        locale.render({element: "#init_body"});
    });
    $("#d_repair_end_time").change(function(){
        // 消除不能为空的提示
        if($("#d_repair_end_time").val()) {
            $(".formErrorContent").remove();
        }
        if(!$("#d_repair_end_time").prop("cacheDate")) {
            //工作开始时间
            var statr_time = $("#d_repair_start_time").val();
            //工作结束时间
            var end_time = $("#d_repair_end_time").val();
            var d_arrival_time = $("#d_arrival_time").val(); // 到场时间
           // var d_reply_time = $("#d_reply_time").val(); // 接单时间

          /*  // 工作结束时间不能小于接单时间
            if(end_time&&d_reply_time) {
                var date3 = new Date(d_reply_time).getTime() - new Date(end_time).getTime();
                if(date3>0) {
                    errorTipDis("end_time_nlt_reply_time");
                    $("#d_repair_end_time").val("");
                }
            }*/
            //工作结束时间不能小于到场时间
            if(end_time&&d_arrival_time) {
                var date3 = new Date(d_arrival_time).getTime() - new Date(end_time).getTime();
                if(date3>0) {
                    errorTipDis("end_time_nlt_reach_time");
                  //  $("#d_repair_end_time").val("");
                }
            }
            if(statr_time&&end_time) {
                var date3 = new Date(end_time).getTime() - new Date(statr_time).getTime();   //时间差的毫秒数
                if(date3>=0) {
                    //计算出小时数
                    var hours=date3/(3600*1000);
                    hours = round2(hours,2);
                    $("#d_repair_work_time").val(hours);
                }else {
                    errorTipDis("end_time_nlt_start_time");
                   /* $("#d_repair_work_time").val("");
                    $("#d_repair_end_time").val("");*/
                }
            }
        }
        $("#d_repair_end_time").prop("cacheDate","");
        locale.render({element: "#init_body"});
    });


    /**
     * 收集工单数据
     */
    function getOrderData() {
        //故障设备信息
        var asset_id = $("#d_asset_Id").val(); //故障设备id
        var device_name = $("#d_device_name").val(); //设备名称
        var site_name = $("#d_site").val(); //现场名称
        var site_id = $("#d_site_id").val(); //现场id
        //报修信息
        var order_id = $("#d_order_id").val(); //工单id
        var order_no = $("#d_order_no").val(); //工单编号
        var repair_date = dateConvertUnixtime2($("#d_repair_date").val()); //报修日期
        var repair_man = $("#d_repair_man").val(); //报修人
        var repair_phone = $("#d_repair_phone").val(); //报修电话
        var fault_phenomenon = $("#d_fault_phenomenon").val(); //故障现象
        var executor_id = $("#d_assigned_engineer").val(); //指派工程师id
        var executor = '';
        if(executor_id) {
            executor = $("#d_assigned_engineer > option:selected").text();//指派工程师
        }
        var order_type = $("#d_order_type").val(); //工单类型 1：人工报修的工单；2：报警转故障工单； 3: 预防性计划工单
        if(order_type==locale.get("artificial_service_work_sheet")) {
            order_type = 1;
        }else if(order_type==locale.get("alarm_fault_repair_order")) {
            order_type = 2;
        }else if(order_type==locale.get("preventive_plan_work_order")) {
            order_type = 3;
        }else if(order_type==locale.get("temporary_work_order")) {
            order_type = 4;
        }
        var fault_type = parseInt($("#d_fault_type > option:selected").val()); // 故障类型1.非停机故障 2.停机故障

        var comment = $("#d_fault_phenomenon").val(); //备注
        //维修信息
        var state =  $("#d_state input:radio:checked").val(); // 工单状态
        var start_time = $("#d_start_time").val() == '' ? '' : dateConvertUnixtime2($("#d_start_time").val());//工作开始时间
        var end_time = $("#d_end_time").val() == '' ? '' : dateConvertUnixtime2($("#d_end_time").val());//工作结束时间
        var work_time = $("#d_work_time").val(); //工作时长
        var reply_time = $("#d_reply_time").val() == '' ? '' : dateConvertUnixtime2($("#d_reply_time").val()); //接单时间
        var reach_time = $("#d_arrival_time").val() == '' ? '' : dateConvertUnixtime2($("#d_arrival_time").val()); //工程师到达时间
        var order_name = $("#d_order_name").val(); // 工单名称

        //工单信息对象
        var wo = { //workorder 工单数据
            name:order_name,
            asset_id:asset_id,
            fault_type:fault_type,
            order_type:order_type,
            creator:repair_man,
            repair_call:repair_phone,
            state:state,
            comment:fault_phenomenon,
            create_time:repair_date,
            working_start:start_time,
            working_end:end_time,
            working_time:work_time,
            reply_time:reply_time,
            reach_time:reach_time
           // executor:executor,
           // executor_id:executor_id
        };
        if(executor_id) { // 如果指派工程师没有就不传值
            wo.executor = executor;
            wo.executor_id = executor_id;
        }

        var data = {wo:wo};
        locale.render({element: "#init_body"});
        return data;
    }

    /**
     * 预防性工单调用的api
     */
    function scheduleApi(state) {
        var data = getOrderData();
        data.wo.state = state;
        var order_id = $("#d_order_id").val(); //工单id
        var deadline = "";
        if($("#d_deadline").val()) {
            deadline = dateConvertUnixtime2($("#d_deadline").val()); //下一次截止时间
        }
        var create_time = data.create_time;
        if(create_time&&deadline) { // 报修时间不能大于所有时间
            if((create_time-deadline)>0) {
                errorTipDis("deadline_time_nlt_create_time");
                return;
            }
        }
        //更新非预防性工单
        editOrder(false,order_id,data,function(data){
            if(typeof(data.result)!="undefined") {
                //更新预防性工单
                close_api_schedule(false,order_id,{comment:"",sign:"",deadline:deadline},function(data){
                    if(typeof(data.result)!="undefined") {
                        dialog.render({
                            lang:"submit_success",
                        });
                        renderOrderDetail(order_id);
                        research_site(0,parseInt($("#pageNumberSelect").val()));
                        //渲染工单条数
                        if(home_detail_flag == 'home'){
                            getOrderTotal();
                            getUnconfirmedOrderTotal();
                        }else if(home_detail_flag == 'detail'){
                            getOrderTotal(data.result.site._id);
                            getUnconfirmedOrderTotal(data.result.site._id);
                        }
                    }else {
                        dialog.render({
                            lang:"submit_failed",
                        });
                    }
                    locale.render({element: "#init_body"});
                });
            }else {
                dialog.render({
                    lang:"submit_failed",
                });
            }
            locale.render({element: "#init_body"});
        },this);
    }

    /**
     * 非预防性工单调用的api
     */
    function orderApi(state) {
        var data = getOrderData();
        data.wo.state = state;
        var order_id = $("#d_order_id").val(); //工单id
        //更新非预防性工单
        editOrder(false,order_id,data,function(data){
            if(typeof(data.result)!="undefined") {
                dialog.render({
                    lang:"submit_success",
                });
                renderOrderDetail(order_id);
                research_site(0,parseInt($("#pageNumberSelect").val()));
                //渲染工单条数
                if(home_detail_flag == 'home'){
                    getOrderTotal();
                    getUnconfirmedOrderTotal();
                }else if(home_detail_flag == 'detail'){
                    getOrderTotal(data.result.site._id);
                    getUnconfirmedOrderTotal(data.result.site._id);
                }
            }else {
                dialog.render({
                    lang:"submit_failed",
                });
            }
            locale.render({element: "#init_body"});
        },this);
    }

    /**
     * 提交工单
     */
    function submitOrder(state) {
        if ($('#d_repair_form').validationEngine('validate')) {
            var data = getOrderData().wo;
            var create_time = data.create_time;
            var working_start = data.working_start;
            var working_end = data.working_end;
            var reply_time = data.reply_time;
            var reach_time = data.reach_time;
            if(state=="accepted") {
                if(!$("#d_assigned_engineer").val()) {
                    errorTipDis("please_assigned_engineer");
                    return;
                }
            } else  if (state == "finished") { // 完成维修时，必须要有维修记录
                if($("#logContent_tbl > tr:first > td").text()==locale.get("no_data")){
                    errorTipDis("please_create_repair_log");
                    return;
                }
                if (!working_end) {
                    errorTipDis("end_time_not_null");
                    return;
                }
                if (!reach_time) {
                    errorTipDis("reach_time_not_null");
                    return;
                }
            } else if (state == "closed") { //关单时工作结束时间不能为空
                if (!working_end) {
                    errorTipDis("end_time_not_null");
                    return;
                }
            } else if (state == "rejected") { //退单 指派工程清空
                $("#d_assigned_engineer > option").removeAttr("selected");

            }

            if (create_time && working_start) { // 报修时间不能大于所有时间
                if ((create_time - working_start) > 0) {
                    errorTipDis("start_time_nlt_create_time");
                    return;
                }
            }
            if (create_time && working_end) { // 报修时间不能大于所有时间
                if ((create_time - working_end) > 0) {
                    errorTipDis("end_time_nlt_create_time");
                    return;
                }
            }
            if (create_time && reply_time) { // 报修时间不能大于所有时间
                if ((create_time - reply_time) > 0) {
                    errorTipDis("reply_time_nlt_create_time");
                    return;
                }
            }
            if (create_time && reach_time) { // 报修时间不能大于所有时间
                if ((create_time - reach_time) > 0) {
                    errorTipDis("reach_time_nlt_create_time");
                    return;
                }
            }

            if (working_start && reach_time) { // 报修时间不能大于所有时间
                if ((reach_time - working_start) > 0) {
                    errorTipDis("reach_time_ngt_start_time");
                    return;
                }
            }

            if (working_start && reply_time) { // 工作开始时间不能小于接单时间
                if ((working_start - reply_time) < 0) {
                    errorTipDis("reply_time_ngt_start_time");
                    return;
                }
            }
            if (working_start && working_end) { // 工作结束时间不能小于工作开始时间
                if ((working_start - working_end) > 0) {
                    errorTipDis("end_time_nlt_start_time");
                    return;
                }
            }
            if(reply_time && reach_time){
                if(reply_time - reach_time >0){
                    errorTipDis("reply_time_ngt_reach_time");
                    return;
                }
            }
            if (data.order_type == 3) { //预防性工单是有创建 接单 关闭三种状态 创建--》接单 接单--》完成关闭
                if (state == "accepted") {
                    orderApi(state);
                } else if (state == "closed") {
                    scheduleApi(state);
                }
            } else {
                orderApi(state);
            }

        }

    }

    /**
     * 保存工单
     */
    function saveOrder(state) {
        if ($('#d_repair_form').validationEngine('validate')) {
            var data = getOrderData().wo;
            var create_time = data.create_time;
            var working_start = data.working_start;
            var working_end = data.working_end;
            var reply_time = data.reply_time;
            var reach_time = data.reach_time;
            // acccpted状态的工单保存 到场时间不能为空
            if(state=="accepted") {
                if(!$("#d_arrival_time").val()) {
                    errorTipDis("reach_time_not_null");
                    return;
                }
            }

            if (create_time && working_start) { // 报修时间不能大于所有时间
                if ((create_time - working_start) > 0) { 
                    errorTipDis("start_time_nlt_create_time");
                    return;
                }
            }
            if (create_time && working_end) { // 报修时间不能大于所有时间
                if ((create_time - working_end) > 0) { 
                    errorTipDis("end_time_nlt_create_time");
                    return;
                }
            }
            if (create_time && reply_time) { // 报修时间不能大于所有时间
                if ((create_time - reply_time) > 0) { 
                    errorTipDis("reply_time_nlt_create_time");
                    return;
                }
            }
            if (create_time && reach_time) { // 报修时间不能大于所有时间
                if ((create_time - reach_time) > 0) {
                    errorTipDis("reach_time_nlt_create_time");
                    return;
                }
            }

            if (working_start && reply_time) { // 工作开始时间不能小于接单时间
                if ((reply_time - working_start) > 0) {
                    errorTipDis("reply_time_ngt_start_time");
                    return;
                }
            }
            if (working_start && working_end) { // 工作结束时间不能小于工作开始时间
                if ((working_start - working_end) > 0) { 
                    errorTipDis("end_time_nlt_start_time");
                    return;
                }
            }
            if(reply_time && reach_time){
                if(reply_time - reach_time > 0){
                    errorTipDis("reply_time_ngt_reach_time");
                    return;
                }
            }

            if (working_start && reach_time) { // 报修时间不能大于所有时间
                if ((reach_time - working_start) > 0) {
                    errorTipDis("reach_time_ngt_start_time");
                    return;
                }
            }

            orderApi(state);
        }
    }

    /**
     * 点击维修记录li标签时显示工单详情提交按钮
     */
    $("#tab_repariInfo_a").click(function(){
        $("#d_modal_footer").show();
    });

    /**
     * 关闭工单详情tab页
     */
   /* function closeDetailTab(ele) {
        var current_li=$(ele).parent().parent();
        var close_index=current_li.index();
        if(current_li.hasClass("active")){
            // 显示相邻标签的前一个标签
            current_li.parent().children("li").eq(close_index-1).children("a").click();
        }
        current_li.remove();
    }*/
    function closeDetailTab() {
        var current_li= $("#tab_detail_nav");
        var close_index=current_li.index();
        if(current_li.hasClass("active")){
            current_li.parent().children("li").eq(close_index-1).children("a").click();
        }
        current_li.remove();
    }
    /**
     * ------------------添加编辑维修记录-------------------------------------------------------------------------------------------------------------------
     */
    validator.render("#repairForm", {
        promptPosition: "inline",
        scroll: false
    });
    /**
     * 显示添加或编辑维修信息的tab页面
     */
    function show_repair_tab(flag) {
        //判断到场时间是否填写
        if(!$("#d_arrival_time").val()) {
            errorTipDis("reach_time_not_null");
            return;
        }

        //判断是否也显示添加或编辑维修信息tab页面了，没有就显示。
        var title = locale.get("add_repair_record");
        this.showRepairLogTab(title);

        //清空wo_log_id
        $("#wo_log_id").val("");
        //清空更换部件列表信息
        $("#d_parts").empty().append('<tr><td colspan="11" align="center" lang="text:no_data"></td></tr>');
        //清空维修信息
        $("#parts_modal").empty().append('<tr><td colspan="11" align="center" lang="text:no_data"></td></tr>');
        //工程师默认为当前用户
        $("#d_device_sense").val(getUserInfo().userName);
        locale.render({element: "#init_body"});
    }

    /**
     * 删除维修记录
     */
    function delLogs() {
        var selected_orders = $("#logContent_tbl tr td input[type='checkbox']:checked");
        if (selected_orders.length > 0) {
            dialog.render({
                lang: "confirm_to_delete_part",
                buttons: [{
                    lang: "yes", click: function () {

                        selected_orders.each(function () {
                            delOrderLogInfo(false,$(this).val(),function(data){},this);
                            $(this).parent().parent().remove();
                        });
                        $("#r_tableHead_checkbok").prop("checked", false);
                        if(!$("#logContent_tbl tr").length) {
                            $('#logContent_tbl').append('<td colspan="6" align="center"   lang="text:no_data"></td>');
                            locale.render({element: "#init_body"});
                        }
                        dialog.close();
                    }
                }, {
                    lang: "no", click: function () {
                        selected_orders.attr("checked", false);
                        $("#r_tableHead_checkbok").prop("checked", false);
                        dialog.close();
                    }
                }],
                close: function () {
                    dialog.close();
                }
            });
        } else {
            errorTipDis("select_del");
        }
        locale.render({element: "#init_body"});
    }

    /**
     * 编辑或添加维修记录后 重新渲染维修记录列表
     */
    function reRenderRepairLogTbl(log,state){
        if($("#logContent_tbl > tr td").length==1 || state=="add"){
            if($("#logContent_tbl > tr td").length==1 ){
                $("#logContent_tbl").empty();
            }
            var str = "<tr id='"+log._id+"'>" +
                /*"<td><input type='checkbox' value='" + log._id + "' class='tabs-checked text-center'></td>" +*/
                "<td>" + (typeof(log.owner) == "undefined" ? "" : log.owner)+ "</td>" +
                "<td>" + (typeof(log.start) == "undefined" ? "" : schneider.util.dateFormat(log.start, "yyyy-MM-dd hh:mm")) + "</td>" +
                "<td>" + (typeof(log.end) == "undefined" ? "" : schneider.util.dateFormat(log.end, "yyyy-MM-dd hh:mm")) + "</td>" +
                "<td>" + (typeof(log.working_time) == "undefined" ? "" : log.working_time) + "</td>" +
                "<td class='text-center'>" +
                "<span data-toggle='tooltip' class='glyphicon glyphicon-edit link-black' style='cursor: pointer;' lang='title:edit' data-permissionFilter='[50]' onclick='editWorklog(this,\""+log._id+"\",\""+log._id+"\")'>" +
                "</td>" +
                "</tr>";
            $("#logContent_tbl").append(str);
        }else{
            $("#logContent_tbl > tr").each(function(){
                var $tr = $(this);
                if($tr.attr("id")==log._id) {
                    $tr.find("td:eq(1)").text(typeof(log.owner) == "undefined" ? "" : log.owner);
                    $tr.find("td:eq(2)").text(typeof(log.start) == "undefined" ? "" : schneider.util.dateFormat(log.start, "yyyy-MM-dd hh:mm"));
                    $tr.find("td:eq(3)").text(typeof(log.end) == "undefined" ? "" : schneider.util.dateFormat(log.end, "yyyy-MM-dd hh:mm"));
                    $tr.find("td:eq(4)").text(typeof(log.working_time) == "undefined" ? "" : log.working_time);
                }
            });
        }
        locale.render({element: "#init_body"});
    }

    /**
     * 提交创建维修记录
     */
    function submitRepair() {
        if ($('#repairForm').validationEngine('validate')) {
            //采集维修信息
            var repairMan = getUserInfo().userName;
            var wo_log_id = $("#wo_log_id").val();
            var workStartTime = $("#d_repair_start_time").val();
            workStartTime = workStartTime!=""?new Date(workStartTime).getTime() : "";
            var workEndTime = $("#d_repair_end_time").val();
            workEndTime = workEndTime!=""?new Date(workEndTime).getTime() : "";
            var workTimes = $("#d_repair_work_time").val();
            var comment = $("#d_repair_comment").val();
            var order_id = $("#d_order_id").val();
            var d_repair_date = $("#d_repair_date").val();
            d_repair_date = d_repair_date!=""?new Date(d_repair_date).getTime() : "";
            var d_reply_time = $("#d_reply_time").val(); // 接单时间
            d_reply_time = d_reply_time!=""?new Date(d_reply_time).getTime() : "";
            var d_arrival_time = $("#d_arrival_time").val(); // 到场时间
            // 工作开始时间不能小于到场时间
            if (workStartTime&&d_arrival_time) {
                var date3 = new Date(d_arrival_time).getTime() - workStartTime;
                if(date3>0) {
                    errorTipDis("start_time_nlt_reach_time");
                    return;
                }
            }
            // 工作结束时间不能小于工作开始时间
            if (workStartTime&&workEndTime) {
                if (workStartTime-workEndTime>0) {
                    errorTipDis("end_time_nlt_start_time");
                    return;
                }
            }
            var worklog = {
                log:{
                    order_id:order_id,
                    start:workStartTime,
                    end:workEndTime,
                    working_time:workTimes,
                    comment:comment,
                    owner_id:getUserInfo()._id,
                    owner:getUserInfo().userName
                }
            }
            if(wo_log_id!=""){
                worklog.log._id = wo_log_id;
                //已经存在维修记录，调用更改维修记录api
                updateOrderLogInfo(wo_log_id,worklog,function(data){
                    var log = data.result.log;
                    $("#d_start_time").val((typeof(data.result.wo.working_start) == 'undefined' ? '' : schneider.util.dateFormat(data.result.wo.working_start, "yyyy-MM-dd hh:mm")));//工作开始时间
                    $("#d_end_time").val((typeof(data.result.wo.working_end) == 'undefined' ? '' : schneider.util.dateFormat(data.result.wo.working_end, "yyyy-MM-dd hh:mm")));//工作结束时间
                    $("#d_work_time").val((typeof(data.result.wo.working_time) == 'undefined' ? '' : round2((data.result.wo.working_time/3600),2))); //工作时长
                    reRenderRepairLogTbl(log,"update");
                    dialog.render({
                        lang:"submit_success"
                    });
                    closeRepairTab();
                },this);
            }else{
                //不存在维修记录，调用新增维修记录api
                addOrderLogInfo(worklog,function (data) {
                    var log = data.result.log;
                    $("#d_start_time").val((typeof(data.result.wo.working_start) == 'undefined' ? '' : schneider.util.dateFormat(data.result.wo.working_start, "yyyy-MM-dd hh:mm")));//工作开始时间
                    $("#d_end_time").val((typeof(data.result.wo.working_end) == 'undefined' ? '' : schneider.util.dateFormat(data.result.wo.working_end, "yyyy-MM-dd hh:mm")));//工作结束时间
                    $("#d_work_time").val((typeof(data.result.wo.working_time) == 'undefined' ? '' : round2((data.result.wo.working_time/3600),2))); //工作时长
                    reRenderRepairLogTbl(log,"add");
                    dialog.render({
                        lang:"submit_success"
                    });
                    closeRepairTab();
                },this);
            }

            locale.render({element: "#init_body"});
        }
    }

    /**
     * 维修记录列表全选
     */
    $("#r_tableHead_selectAll").on('click', function (event) {
        var selected = $("#logContent_tbl tr td input[type='checkbox']:checked");
        var allSiteCurrentPage = $("#logContent_tbl tr td input");
        if (allSiteCurrentPage.length > 0) {
            if (selected.length < allSiteCurrentPage.length) {
                $("#logContent_tbl tr td input").prop("checked", true);
                $("#r_tableHead_checkbok").prop("checked", true);
            } else {
                $("#logContent_tbl tr td input").prop("checked", false);
                $("#r_tableHead_checkbok").prop("checked", false);
            }
        }
    });

    /**
     * 关闭添加或编辑维修信息tab页面
     */
    function closeRepairTab() {
        $("#tab_repair_nav").remove();
        $("#tab_repariInfo_a").click();
        //显示工单详情页面的提交按钮
        $("#d_modal_footer").show();
    }
    /**
     * -------------------------------------更换部件-----------------------------------------------------------------------------------------------------
     */

    /**
     * 添加维修部件
     */
    function show_repair_part_modal(part_id) {
        $('#changeModal').modal({backdrop: 'static', keyboard: false});
        if(home_detail_flag=="home") {
            $("#changeModal").load("repair/order/order_parts_maintain.html",function(){
                locale.render({element: "#init_body"});
                //详情页面报修信息表单校验
                validator.render("#changeModal", {
                    promptPosition: "inline",
                    scroll: false
                });
                $('#changeModal').modal('show');
                var asset_id = $("#d_asset_Id").val() ;
                initChangeModal(part_id,asset_id);
            });
        }else if(home_detail_flag=="detail") {
            $("#changeModal").load("../repair/order/order_parts_maintain.html",function(){
                locale.render({element: "#init_body"});
                //详情页面报修信息表单校验
                validator.render("#changeModal", {
                    promptPosition: "inline",
                    scroll: false
                });
                $('#changeModal').modal('show');
                var asset_id = $("#d_asset_Id").val() ;
                initChangeModal(part_id,asset_id);
            });
        }

    }

    /**
     * 维修部件全选
     */
    $("#rpart_tableHead_selectAll").on('click', function (event) {
        var selected = $("#d_parts tr td input[type='checkbox']:checked");
        var allSiteCurrentPage = $("#d_parts tr td input");
        if (allSiteCurrentPage.length > 0) {
            if (selected.length < allSiteCurrentPage.length) {
                $("#d_parts tr td input").prop("checked", true);
                $("#rpart_tableHead_checkbok").prop("checked", true);
            } else {
                $("#d_parts tr td input").prop("checked", false);
                $("#rpart_tableHead_checkbok").prop("checked", false);
            }
        }
    });

    /**
     *   删除维修部件
     */
    function delPart() {
        var selected_orders = $("#d_parts tr td input[type='checkbox']:checked");
        if (selected_orders.length > 0) {
            dialog.render({
                lang: "confirm_to_delete_part",
                buttons: [{
                    lang: "yes", click: function () {
                        selected_orders.each(function () {
                            $(this).parent().parent().remove();
                        });
                        $("#rpart_tableHead_checkbok").prop("checked", false);
                        if(!$("#d_parts tr").length) {
                            $('#d_parts').append('<td colspan="11" align="center"   lang="text:no_data"></td>');
                            locale.render({element: "#init_body"});
                        }
                        dialog.close();
                    }
                }, {
                    lang: "no", click: function () {
                        selected_orders.attr("checked", false);
                        $("#rpart_tableHead_checkbok").prop("checked", false);
                        dialog.close();
                    }
                }],
                close: function () {
                    dialog.close();
                }
            });
        } else {
            errorTipDis("select_del");
        }
        locale.render({element: "#init_body"});
    }

</script>
