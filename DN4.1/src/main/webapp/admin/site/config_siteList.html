<!--=========================================
*2016-08-15 Lee李杰
*现场配置的文档说明
*============================================-->
<style type="text/css">
    #editMap {
        height: 400px;
        margin-top: 2rem;
        border: 1px solid #efefef;
        border-radius: 5px;
    }
    .siteHeader li {
        margin: 0px;
        padding: 0px;
    }
    #suggestionAdd {
        background-color: #fff;
        border: 1px solid #efefef;
    }
    #suggestionAdd p {
        padding: 5px;
        margin: auto;
        word-break: break-all;
    }
    #suggestionAdd p:hover {
        background-color: #eee;
        cursor: pointer;
    }
    .dropdown-option {
        cursor: pointer;
        color: rgba(103, 135, 116, 0.91);
    }
    .dropdown-option:hover {
        color: #1fc651;
    }
    #siteTabs li:hover {
        cursor: pointer;
    }
    /* 新加的css */
    .sui-steps {
        font-size: 0px;
        overflow: hidden;
        line-height: 0px;
        margin: 18px 0px;
    }
    .sui-steps .wrap {
        display: inline-block;
    }
    .sui-steps .wrap>div {
        width:  164px;
        height: 32px;
        display: inline-block;
        line-height: 32px;
        vertical-align: top;
        font-size: 12px;
        position: relative;
    }
    .sui-steps .wrap>div>label {
        margin-left: 26px;
        cursor: default;
    }
    .sui-steps .triangle-right {
        display: inline-block;
        width: 0px;
        height: 0px;
        border-style: solid;
        border-width: 16px;
        position: absolute;
        right: -31px;
        z-index: 1;
    }
    .sui-steps .triangle-right-bg {
        display: inline-block;
        width: 0px;
        height: 0px;
        border-style: solid;
        border-width: 16px;
        position: absolute;
        right: -31px;
        z-index: 1;
        border-width: 19px;
        right: -38px;
        border-color: transparent transparent transparent #FFF;
        top: -4px;
    }
    .sui-steps .round {
        display: inline-block;
        width: 18px;
        height: 18px;
        -webkit-border-radius: 9px;
        -moz-border-radius: 9px;
        border-radius: 9px;
        text-align: center;
        line-height: 18px;
    }
    .sui-steps .round .sui-icon {
        vertical-align: -1px;
    }
    .sui-steps .round+span:before {
        content: '\00a0';
    }
    .sui-steps .finished {
        background-color: #3c8dbc;
    }
    .sui-steps .finished .triangle-right {
        border-color: transparent transparent transparent #3c8dbc;
    }
    .sui-steps .finished .round {
        background-color: #ffffff;
        background-color: transparent\9;
        color: #3c8dbc;
    }
    .sui-steps .finished .round>i {
        color: #3c8dbc;
        font-size: 12px;
    }
    .sui-steps .current {
        background-color: #0073b7;
        color: #ffffff;
    }
    .sui-steps .current .triangle-right {
        border-color: transparent transparent transparent #0073b7;
    }
    .sui-steps .current .round {
        background-color: #ffffff;
        color: #0073b7;
        color: #FFF\9;
        background-color: transparent\9;
    }
    .sui-steps .todo {
        background-color: #eeeeee;
        color: #999999;
    }
    .sui-steps .todo .triangle-right {
        border-color: transparent transparent transparent #eeeeee;
    }
    .sui-steps .todo .round {
        background-color: #ffffff;
        background-color: transparent\9;
    }
    .icon-pc-right:before {
        content: "\c603";
    }
    .pac-container {
        z-index: 99999999999;
    }
    /*============device===============*/
    #devices_list li {
        word-break: break-all;
    }
    #devices_list li span {
        cursor: pointer;
    }
    .device_basic_content {
        display: none;
    }
    /*==============site information=================*/
    .datePlugin, .datePlugin2 {
        background-color: #fff;
    }
    #serial_number_index {
        display: none;
    }
</style>
<section class="content-header">
    <h1 lang="text:site">
        <small>Version 2.0</small>
    </h1>
    <ol class="breadcrumb">
        <li>
            <a href="#" lang="text:site_management"></a>
        </li>
        <li class="active" lang="text:site"></li>
    </ol>
</section>

<!--现场列表-->
<section class="content" id="tcontent">
    <div class="nav-tabs-custom">
        <ul class="nav nav-tabs" role="tablist" id="siteTabs">
            <li role="presentation" class="active" id="allSite"><a role="tab" data-toggle="tab" lang="text:all_site;"></a></li>
            <li role="presentation" id="onlineSite"><a role="tab" data-toggle="tab" lang="text:online_site;"></a></li>
            <li role="presentation" id="offlineSite"><a role="tab" data-toggle="tab" lang="text:offline_site;"></a></li>
        </ul>
        <!-- Tab panes  tab-content-->
        <div class="tab-content" style="padding-bottom: 0px;">
            <!--表格数据区-->
            <div class=" tab-pane row active">
                <div class="col-md-12">
                    <div class="box box-solid" style="margin-bottom: 0px;box-shadow: 0px 0px;">
                        <!--加载数据等待-->
                        <div class="overlay" style="display: none;" id="overlay1">
                            <i class="fa icon-refresh icon-spin"></i>
                        </div>

                        <!--查询条件-->
                        <div class="box-body">
                            <div class="row">
                                <div class="col-sm-12" style="padding-bottom: 10px;">
                                    <form class="form-inline" id="siteSearchForm">
                                        <div class="form-group">
                                            <input style="cursor:auto;" type="text" name="search" class="form-control input-sm validate[custom[stopSpecialCharacters]]" id="liveSearch" placeholder lang="placeholder:site_name">
                                            <button type="button" onclick="searchFun()" class="btn btn-default btn-sm" data-toggle="tooltip" title="" lang="title:query" id="btn_research">
                                                <span class="glyphicon glyphicon-search"></span>
                                            </button>
                                        </div>
                                        <div class="form-group pull-right">
                                            <div class="btn-group">
                                                <!--<button id="addLiveSite" type="button" class="btn btn-default btn-sm" title="" data-toggle="tooltip" data-placement="bottom" lang="title:add" data-permissionFilter="[30]">-->
                                                    <!--<i class="glyphicon glyphicon-plus"></i>-->
                                                <!--</button>-->
                                                <button id="deleteLiveSite" type="button" class="btn btn-default btn-sm" title="" data-toggle="tooltip" data-placement="bottom" lang="title:deletesite" data-permissionFilter="[30]">
                                                    <i class="iconfont icon-delete"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div>
                                <table id='liveExample' class='table table-bordered table-hover table-striped'>
                                    <thead>
                                        <tr>
                                            <th style="width:30px;">
                                                <div style="margin:auto">
                                                    <input type="checkbox" name="selectAll" id="selectAll" lang="text:check_all">
                                                </div>
                                            </th>
                                            <th style="width:5%;text-align:center;" lang="{text:state}"></th>
                                            <th style="width:15%;" lang="text:site_name"></th>
                                            <th lang="text:address"></th>
                                            <th style="width:140px" lang="{text:business_state}"></th>
                                            <th style="width:12%;" lang="text:contact_name"></th>
                                            <th style="width:13%;" lang="text:contact_phone"></th>
                                            <th style="width:17%;" lang="text:email"></th>
                                            <th data-permissionfilter="[30,91]" style="width:80px;text-align: center" lang="text:operate"></th>
                                        </tr>
                                    </thead>
                                    <tbody id='liveSite_tbody'>
                                    </tbody>
                                    <tfoot>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                        <!--box-body-->
                        <div id="page-footer">

                        </div>
                        <!--分页工具-->
                    </div>
                </div>
            </div>
        </div>
    </div>

</section>

<!--点击增加或者编辑按钮后的弹出框-->
<div class="modal fade bs-example-modal-lg" id="addBox" data-target=".bs-example-modal-lg">
    <div class="modal-dialog modal-lg" data-target=".bs-example-modal-lg">
        <div class="modal-content">
            <!--Header Information-->
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 id="modal_title" class="modal-title"></h4>
            </div>
            <!--content Information-->
            <div class="modal-body" style="overflow-y: auto;height:450px;">
                <input type="hidden" id="siteId" value="" />
                <input type="hidden" id="oldName" value="" />
                <div class="sui-steps col-md-12" style="text-align: center;">
                    <div class="wrap col-md-３">
                        <div class="finished" id="first_div">
                            <label><span class="round" id="first">1 </span><span class="box-site-header" lang="text:basic_information"></span></label><i class="triangle-right-bg"></i><i class="triangle-right"></i>
                        </div>
                    </div>
                    <div class="wrap col-md-３">
                        <div class="todo" id="two_div">
                            <label><span class="round" id="two">2 </span><span class="box-site-header" lang="text:gateway_config"></span></label><i class="triangle-right-bg"></i><i class="triangle-right"></i>
                        </div>
                    </div>
                    <div class="wrap col-md-３">
                        <div class="todo" id="three_div">
                            <label><span class="round" id="three">3 </span><span class="box-site-header" lang="text:device_config"></span></label><i class="triangle-right-bg"></i><i class="triangle-right"></i>
                        </div>
                    </div>
                    <div class="wrap col-md-３" style="display: none;">
                        <div class="todo" id="four_div">
                            <label><span class="round" id="four">4 </span><span class="box-site-header" lang="text:part_config"></span></label><i class="triangle-right-bg"></i><i class="triangle-right"></i>
                        </div>
                    </div>
                    <div class="wrap col-md-３">
                        <div class="todo" id="five_div">
                            <label><span class="round" id="five">4</span><span class="box-site-header" lang="text:four_complete"></span></label>
                        </div>
                    </div>
                </div>
                <!--现场区域-->
                <div class="addSiteContentBox">
                        <div id="loadSiteInfoDiv"></div>
                </div>
                <!--网关配置-->
                <div class="addGatewayContentBox">
                    <div id="loadSiteGatewayDiv"></div>
                </div>
                <!--设备-->
                <div class="addDeviceContentBox">
                    <div id="loadSiteAssetDiv"></div>
                </div>
                <!--部件-->
                <div class="addPartContentBox">
                    <div id="loadSitePartDiv"></div>
                </div>
                <!--完成-->
                <div class="addFinishContentBox">
                    <div class="text-left" style=" margin-top: 140px;margin-left: 320px;">
                        <h4 id="message1_div"></h4>
                        <h4 id="message2_div"></h4>
                        <h4 id="message3_div"></h4>
                        <h4 id="message4_div"></h4>
                    </div>
                </div>
            </div>
            <!--Footer Information-->
            <div class="modal-footer">
                <div id="next_Step_Site" class="addSiteContentBox">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal" lang="text:close"></button>
                    <!-- <button type="button" class="btn btn-default" id="saveSiteStep" lang="text:save">保存</button> -->
                    <button type="button" class="btn btn-primary" id="saveSiteNextStep" lang="text:next_step"></button>
                </div>
                <div id="next_Step_GateWay" class="addGatewayContentBox">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal" lang="text:close"></button>
                    <button type="button" class="btn btn-default" id="AddPreStep1" lang="text:previous_step"></button>
                    <button type="button" class="btn btn-primary" id="saveGatewayNextStep" lang="text:next_step"></button>
                </div>

                <div id="nextStepDevice" class="addDeviceContentBox">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal" lang="text:close"></button>
                    <button type="button" class="btn btn-default" id="AddPreStep2" lang="text:previous_step"></button>
                    <button type="button" class="btn btn-primary" id="saveAssetNextStep" lang="text:next_step"></button>
                </div>


                <div id="nextStepPart" class="addPartContentBox">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal" lang="text:close"></button>
                    <button type="button" class="btn btn-default" id="AddPreStep３" lang="text:previous_step"></button>
                    <button type="button" class="btn btn-primary" id="finishAdd" lang="text:finish"></button>
                </div>
                <div id="nextStepFinish" class="addFinishContentBox">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal" lang="text:close"></button>
                </div>
            </div>
        </div>
    </div>
</div>


<!--当前现场的scada进行判断-->
<div class="modal fade bs-example-modal-lg" id="createBox" data-target=".bs-example-modal-lg">

</div>
<!--END-->


<!--页面初始化加载-->
<script>
    /**
     * 设置现场查询表单验证
     */
    validator.render("#siteSearchForm", {
        //  promptPosition: "inline",
         scroll: false,
        // showOneMessage:true, // 只显示一条提示信息
        showPrompts:false //不显示提示信息
    });

    //全局变量保存提交信息
    var siteMessage = false; //true 提交成功 false 提交失败
    var deviceMessage = "A"; //A提交失败 B提交成功 C跳过
    var gatewayMessage = "A"; //A提交失败 B提交成功 C跳过
    var partMessage = "A"; //A提交失败 B提交成功 C跳过
    var dFlag = "NO"; //标记现场下是否有设备数据 NO表示没有数据 YES表示有数据
    var globalSiteId = ""; //全局现场Id
    var globalSiteName = ""; //全局现场名称


    //页面权限过滤
    $(document).ready(function() {
        permissionFilter_pageFunc();
        //引入siteService.js   gatewayService.js
        require(['siteService', 'gatewayService', 'machinesService'], function() {
            $("#loadSiteInfoDiv").load("admin/site/config_siteInfo.html");
            $("#loadSiteGatewayDiv").load("admin/site/config_siteGateway.html");
            $("#loadSiteAssetDiv").load("admin/site/config_siteAsset.html");
            $("#loadSitePartDiv").load("admin/site/config_sitePart.html");
            $("#createBox").load("admin/site/config_siteScada.html");
            $("#page-footer").load("admin/pagination.html", function() {
                getModel();
                liveSiteList(0, $("#pageNumberSelect").val());
                renderButton();
            });
        });
        locale.render({
            element: "#init_body"
        });
    });
    var tab = 1;
    //绑定按钮事件
    function renderButton() {
        //全部现场
        $("#allSite").click(function(event) {
            $("#siteTabs li").removeClass('active');
            $(this).addClass('active');
            $("#liveSearch").val("");
            tab = 1;
            // 查找函数
            searchFun();
        });
        //在线现场
        $("#onlineSite").click(function(event) {
            $("#siteTabs li").removeClass('active');
            $(this).addClass('active');
            $("#liveSearch").val("");
            tab = 2;
            searchFun();
        });
        //离线现场
        $("#offlineSite").click(function(event) {
            $("#siteTabs li").removeClass('active');
            $(this).addClass('active');
            $("#liveSearch").val("");
            tab = 3;
            searchFun();
        });
    }
    //获取机型数据
    function getModel() {
        //加载机型数据
        params = {
            "verbose": 3,
            "gateway": true,
            "limit": 0
        };
        $("#info-model").empty();
        // 获取机型的API 调用
        getModels(params, function(data) {
            if (data) {
                var $options = "";
                var re_ir9 = new RegExp(/^6.*/);
                for (var i = 0; i < data.result.length; i++) {
                    if(re_ir9.test(data.result[i].name)){
                        if (i == 0) {
                            $options += "<option selected='selected' value='" + data.result[i]._id + "'>" + data.result[i].name + "</option>";
                        } else {
                            $options += "<option value='" + data.result[i]._id + "'>" + data.result[i].name + "</option>";
                        }
                    }
                }
                $("#info-model").append($options);
            }
        }, this);
    }

    //国际化初始化
    locale.render({
        element: "body"
    });

    //校验规则
    (function($) {
        $.validationEngineLanguage = {
            "giveName": {
                "regex": /^[a-zA-Z0-9_\-\u4e00-\u9fa5]+$/i,
                "alertText": "* Invalid name"
            },
            "serialNumber2": {
                "regex": /^[a-zA-Z]{2}[0-9]{13}$/,
                "alertText": "* Please input the 15 letter serial number of the gateway"
            },
            "phone1": {
                "regex": /^(\+?[0-9]{2,4}\-?\s?)?([0-9]{3,4}\-?\s?)?([0-9]{7,8})(\-[0-9]+)?$/,
                "alertText": "* Invalid phone number"
            },
            "email": {
                // HTML5 compatible email regex ( http://www.whatwg.org/specs/web-apps/current-work/multipage/states-of-the-type-attribute.html#    e-mail-state-%28type=email%29 )
                "regex": /^admin$|^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,
                "alertText": "* Invalid email address"
            }
        }
    })(jQuery);

    //验证月流量阀值不能为负数
    function alaRule(field, rules, i, options) {
        var message = locale.get("Can_not_be_negative");
        var num = $.trim(field[0].value);
        if (num != '') {
            var arr = num.match(/[\-\+]?|[\-\+]?((([0-9]{1,3})([,][0-9]{3})*)|([0-9]+))?([\.]([0-9]+))?/);
            if (arr[0] == "-") {
                return "*" + message;
            }
        }
        locale.render({
            element: "#init_body"
        });
    }

    //验证email
    function emailRule(field, rules, i, options) {
        var message = locale.get("Please_enter_email");
        var email = $.trim(field[0].value);
        if (email != '') {
            var arr = email.match(/^(([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6}\;))*([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6})$/);
            if (arr == null) {
                return "*" + message;
            }
        }
        locale.render({
            element: "#init_body"
        });
    }

    //自定义外部函数
    function cloudInput(field, rules, i, options) {
        var nohtml = new RegExp("(<[^>]+>)|(&gt|&lt|&amp|&quot|&nbsp)");
        if (nohtml.test(field.val())) {
            //add rules at validationengine.lang
            return options.allrules.nohtml.alertText;
        }
        return true;
    }

    //阻止回车事件
    $('body').keypress(function(event) {
        if (event.keyCode === 10 || event.keyCode === 13)
            event.preventDefault();
    });

    // 搜索回车事件绑定
    $('#liveSearch').keypress(function(event) {
        if (event.keyCode === 10 || event.keyCode === 13)
        //event.preventDefault();
            searchFun();
    });

    //搜索函数
    function searchFun() {
        if ($('#siteSearchForm').validationEngine('validate')) {
            $("#selectAll").prop( "checked", false);
            liveSiteList(0, $("#pageNumberSelect").val());
        }
    }

    //每页显示条目切换回调函数
    function changePageNumber(limit) {
        liveSiteList(0, limit);
    }

    //跳转到指定页  回调函数
    function jumpTopage(cursor) {
        liveSiteList(cursor, $("#pageNumberSelect").val());
    }
    //获取现场列表数据
    function liveSiteList(cursor, limit) {
        var params = {
            limit: limit,
            cursor: cursor,
            verbose: 100
        };
        if (tab == 2) {
            params.online = 1;
        } else if (tab == 3) {
            params.online = 0;
        }
        var name = $.trim($("#liveSearch").val());
        if (name !== "") {
            name = name.match(pattern);
        }
        params.name = name;
        $("#liveSearch").val(name);
        loading1();
        loadSite(params);
        /*-------事件监听，点击增加按钮执行--------*/
        $("#addLiveSite").click(function(event) {
            addLiveSite(params);
        });
        /*-------事件监听，点击删除按钮执行--------*/
        $("#deleteLiveSite").click(function(event) {
            deleteLiveSite(params);
        });
    }
    // 加载现场
    function loadSite(param) {
        var paramsF = param;
        loadAllSite(paramsF, function(data) {
            if (data && data.total != undefined && data.total > 0) {
                //填充表单数据
                liveList(data);
                //加载分页工具
                renderPagination(data, liveSiteList);

            } else {
                clearPagination();
                $('#liveSite_tbody').empty();
                var $tr = '<tr><td colspan="9" align="center">' + locale.get("no_data") + '</td></tr>';
                $('#liveSite_tbody').append($tr);
            }
            unload1();
        });
    }
    //为现场列表填值
    function liveList(data) {
        $('#liveSite_tbody').empty();
        var len = data.result.length;
        var clogs = data.result;
        for (var i = 0; i < len; i++) {
            var address = null;
            if (clogs[i] != undefined) {
                var $tr = '<tr class="targetBox">' +
                    '<td><input id="' + clogs[i]._id + '" type="checkbox"></td>';

                if (clogs[i].online == 1) {
                    //在线
                    $tr += '<td style="text-align: center" ><i class="iconfont icon-guanji text-green"></i> </td>';
                } else {
                    //离线
                    $tr += '<td style="text-align: center" ><i class="iconfont icon-guanji1 contacts-list-date"></i></td>';
                }

                $tr += '<td style="word-break: break-all;" id="infoName' + clogs[i]._id + '" ></td>' +
                    '<td style="word-break: break-all;" id="infoAddress' + clogs[i]._id + '"></td>' +
                    '<td style="word-break: break-all;" id="infoState' + clogs[i]._id + '"></td>' +
                    '<td style="word-break: break-all;" id="infoConName' + clogs[i]._id + '"></td>' +
                    '<td style="word-break: break-all;" id="infoConPho' + clogs[i]._id + '"></td>' +
                    '<td style="word-break: break-all;" id="infoConEmail' + clogs[i]._id + '"></td>' +
                    '<td data-permissionfilter="[30,91]" style="word-break: break-all;text-align:center;"><span class="glyphicon glyphicon-edit link-black" lang="title:edit" id="edit' + clogs[i]._id + '" data-permissionfilter="[30]" style="cursor:pointer"></span>' +
                    '<span class="iconfont icon-scada link-black" data-permissionfilter="[91]" lang="title:web_scada" id="scada' + clogs[i]._id + '" style="margin-left:10px;cursor:pointer"></span>' +
                    '</td>';

                $tr += '</tr>';
                $('#liveSite_tbody').append($tr);
                //现场信息
                var siteName = clogs[i].name;
                if (siteName == undefined) {
                    siteName = "";
                } else {
                    siteName = clogs[i].name
                }
                $("#infoName" + clogs[i]._id + "").html(siteName);
                var address = clogs[i].address;
                if (address == undefined) {
                    address = "";
                } else {
                    address = clogs[i].address;
                }
                $("#infoAddress" + clogs[i]._id + "").html(address);
                var state = null;
                var oState = clogs[i].businessState;
                if (oState == 0) {
                    state = locale.get("construction");
                } else if (oState == 1) {
                    state = locale.get("commissionin");
                } else if (oState == 2) {
                    state = locale.get("fault");
                } else if (oState == 3) {
                    state = locale.get("overhaul");
                }
                $("#infoState" + clogs[i]._id + "").html(state);
                var conName = null;
                var conPho = null;
                var conEmail = null;
                if (clogs[i].contact == undefined) {
                    conName = "";
                    conPho = "";
                    conEmail = "";
                } else {
                    conName = clogs[i].contact.name;
                    if (conName == undefined) {
                        conName = "";
                    } else {
                        conName = clogs[i].contact.name;
                    }
                    conPho = clogs[i].contact.phone;
                    if (conPho == undefined) {
                        conPho = "";
                    } else {
                        conPho = clogs[i].contact.phone;
                    }
                    conEmail = clogs[i].contact.email;
                    if (conEmail == undefined) {
                        conEmail = "";
                    } else {
                        conEmail = clogs[i].contact.email;
                    }
                }
                $("#infoConName" + clogs[i]._id + "").html(conName);
                $("#infoConPho" + clogs[i]._id + "").html(conPho);
                $("#infoConEmail" + clogs[i]._id + "").html(conEmail);
                //点击 编辑事件
                $("#edit" + clogs[i]._id + "").click(function() {
                    var oldId = $(this).attr("id");
                    var targetIds = oldId.substring(4);
                    var clogs = data.result;
                    for (var i = 0; i < len; i++)
                        if (clogs[i]._id == targetIds) {
                            var targetInfo = clogs[i];
                            window.targetInfo = targetInfo;
                            editSite(targetIds, targetInfo);
                        }
                });
                //点击 现场事件
                $("#scada" + clogs[i]._id + "").on( "click", function() {
                    var oldScadaId = $(this).attr("id");
                    var targetScadaId = oldScadaId.substring(5);
                    var current_site_name = $("#infoName" + targetScadaId + "").text();
                    //转的scada页面
                    goToScada(targetScadaId, current_site_name);
                });
            }
        }
        $("#liveSite_tbody > tr > td > input").on("click", function() {
            var selected_usersId = $("#liveSite_tbody tr td input[type='checkbox']:checked");
            var allUsers_nowPage = $("#liveSite_tbody tr");
            if (selected_usersId.length < allUsers_nowPage.length) {
                $("#selectAll").prop("checked", false);
            }
            if (selected_usersId.length == allUsers_nowPage.length) {
                $("#selectAll").prop("checked", true);
            }
        });
        //权限执行
        permissionFilter_pageFunc();
    }
    //删除现场函数
    function deleteLiveSite(param) {
        //添加删除判断：判断删除个数，以及确定判断
        var checkedSite = $("#liveSite_tbody tr td input:checked");
        param.delete_all = 0;
        if (checkedSite.length > 0) {
            dialog.render({
                lang: "confirm_to_delete_site",
                buttons: [{
                    lang: "yes",
                    click: function() {
                        checkedSite.each(function() {
                            var current_site_id = $(this).attr( "id");
                            var devices_prama = {
                                "site_id": current_site_id,
                                "verbose": 100,
                                "limit": 0
                            };
                            getDevicesOfSite( devices_prama, true, function(data) {
                                if ( data.total > 0) {
                                    dialog.close();
                                    dialog.render( {
                                        lang: "current_site_had_assets",
                                        buttons: [{
                                            lang: "yes",
                                            click: function() {
                                                $("#selectAll").prop("checked", false);
                                                liveSiteList(0, $("#pageNumberSelect").val());
                                                dialog.close();
                                            }
                                        }],
                                        close: function() {
                                            dialog.close();
                                        }
                                    });
                                } else {
                                    deleteSite( param, current_site_id /*$(this).attr("id")*/);
                                    $("#selectAll").prop("checked", false);
                                    liveSiteList(0, $("#pageNumberSelect").val());
                                    dialog.close();
                                }
                            }, this);
                        });
                        /*$("#selectAll").prop("checked", false);
                        liveSiteList(0, $("#pageNumberSelect").val());
                        dialog.close();*/
                    }
                }, {
                    lang: "no",
                    click: function() {
                        dialog.close();
                    }
                }],
                close: function() {
                    dialog.close();
                }
            });
        } else {
            errorTipDis("please_click_the_site_you_want_to_delete");
        }
        locale.render({
            element: "#init_body"
        });
    }
    //当页全选
    $("#selectAll").on('click', function(event) {
        var selected = $("#liveSite_tbody tr td input[type='checkbox']:checked");
        var allSiteCurrentPage = $("#liveSite_tbody tr");
        if (allSiteCurrentPage.length > 0) {
            if (selected.length < allSiteCurrentPage.length) {
                $("#liveSite_tbody tr td input").prop("checked", true);
                $("#selectAll").prop("checked", true);
            } else {
                $("#liveSite_tbody tr td input").prop("checked", false);
                $("#selectAll").prop("checked", false);
            }
        }
    });

    function loading1() {
        $("#overlay1").show();
    }

    function unload1() {
        $("#overlay1").hide();
    }
</script>






