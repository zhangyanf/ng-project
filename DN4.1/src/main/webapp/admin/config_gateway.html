<!-- 首先需要引入plupload的源代码 -->
<script src="plugins/plupload-2.1.9/js/plupload.full.min.js"></script>

<style type="text/css">
    .showNavTabContent1_center{
        flex: 1;
        margin-right: -17px;
    }
    .showNavTabContent1_right{
        height: 672px;
        overflow: auto;
        width: 0px;
        margin-left: 4px;
        background-color: white;
        transition:width 200ms;
    }
    .switch_tabContent {
        height: 672px;
        background-color: rgba(144, 140, 144, 0.46);
        overflow: hidden;
    }
    .switchButton{
        line-height: 578px;
        width: 22px;
    }
    .input_readOnly{
        border: none;
        background-color: white;
    }
    .textarea_readOnly {
        border: none;
        background-color: #eee;
    }
    .icon_click{
        cursor: pointer;
    }
    .icon_click:hover{
        color: rgba(45, 210, 31, 0.71);
    }
    #CTRight_advanceOptions{
        cursor: pointer;
        color: rgba(103, 135, 116, 0.91);
    }
    #CTRight_advanceOptions:hover{
        color: #1fc651;
    }
    #btn_research{
        width: 40px;
        height: 25px;
        color: rgba(95, 97, 99, 0.68);
    }
    #btn_research:hover{
        color: rgba(105, 210, 124, 0.71);
    }
    #tableHead_selectAll {
        cursor: pointer;
    }

    #tableHead_selectAll:hover {
        color: #1fc651;
    }

    /*表格样式*/
    #statistics_data_table tr td:nth-child(1){word-break: break-all;}
    #statistics_data_table tr td:nth-child(2){word-break: break-all;}
    #statistics_data_table tr td:nth-child(3){word-break: break-all;}
    #statistics_data_table tr td:nth-child(4){word-break: break-all;}
    #statistics_data_table tr td:nth-child(5){word-break: break-all;}
    #statistics_data_table tr td:nth-child(6){word-break: break-all;}
    #statistics_data_table tr td:nth-child(7){word-break: break-all;}
    #statistics_data_table tr td:nth-child(8){word-break: break-all;}
    #statistics_data_table tr td:nth-child(9){word-break: break-all;}
    #statistics_data_table tr td:nth-child(10){word-break: break-all;}
    #statistics_data_table tr td:nth-child(11){word-break: break-all;}

</style>

<script type="text/javascript">
    //加载页面初始化
    function onInit() {
        //添加网关摸态框表单验证配置初始化
        validator.render("#add_edit_form", {
            promptPosition: "inline",
            scroll: false
        });

        //批量导入网关摸态框表单验证配置初始化
        validator.render("#import_gateway_form", {
            promptPosition: "topRight",
            scroll: false
        });
        //添加设备配置摸态框表单验证配置初始化
        validator.render("#dev_config", {
            promptPosition: "inline",
            scroll: false
        });
        //页面功能权限过滤
        permissionFilter_pageFunc();
        require(['gatewayService','logService'], function(gatewayService) {
            getModel();
            // 页面加载时初始化
            $("#page-footer").load("admin/pagination.html", function() {
                showTabContent(1);
            });
        });
        locale.render({element: "#init_body"});
    }


    //校验规则
    (function($) {
        $.validationEngineLanguage = {
            "giveName": {
                "regex": /^[a-zA-Z0-9_\-\u4e00-\u9fa5]+$/i,
                "alertText": "* Invalid name"
            },
            "serialNumber2": {
                "regex": /^[a-zA-Z]{2}[0-9]{13}$/,
                "alertText": "* Please input the 15 letter serial number of the gateway"
            },
            "phone1": {
                "regex": /^(\+?[0-9]{2,4}\-?\s?)?([0-9]{3,4}\-?\s?)?([0-9]{7,8})(\-[0-9]+)?$/,
                "alertText": "* Invalid phone number"
            },
            "email": {
                // HTML5 compatible email regex ( http://www.whatwg.org/specs/web-apps/current-work/multipage/states-of-the-type-attribute.html#    e-mail-state-%28type=email%29 )
                "regex": /^admin$|^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,
                "alertText": "* Invalid email address"
            }
        }
    })(jQuery);

    //验证月流量阀值不能为负数
    function alaRule(field, rules, i, options) {
        var message = locale.get("Can_not_be_negative");
        var num = $.trim(field[0].value);
        if (num != '') {
            var arr = num.match(/[\-\+]?|[\-\+]?((([0-9]{1,3})([,][0-9]{3})*)|([0-9]+))?([\.]([0-9]+))?/);
            if (arr[0] == "-") {
                return "*" + message;
            }
        }
        locale.render({element: "#init_body"});
    }

    //验证email
    function emailRule(field, rules, i, options) {
        var message = locale.get("Please_enter_email");
        var email = $.trim(field[0].value);
        if (email != '') {
            var arr = email.match(/^(([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6}\;))*([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6})$/);
            if (arr == null) {
                return "*" + message;
            }
        }
        locale.render({element: "#init_body"});
    }

    //自定义外部函数
    function cloudInput(field, rules, i, options) {
        var nohtml = new RegExp("(<[^>]+>)|(&gt|&lt|&amp|&quot|&nbsp)");
        if (nohtml.test(field.val())) {
            //add rules at validationengine.lang
            return options.allrules.nohtml.alertText;
        }
        return true;
    }
    // 初始化加载国际化
    locale.render({element: "#init_body"});

    //阻断keydown事件
    $('body').keypress(function(event) {
        if (event.keyCode === 10 || event.keyCode === 13)
            event.preventDefault();
    });
    var tab = 1;
    //nav-tabs选择项切换
    function showTabContent(tabPage) {
        $("#myNavTabs > li").removeClass("active");
        if (tab==1) {
            $("#nav_tab_1").addClass("active");
        } else if (tab==2) {
            $("#nav_tab_2").addClass("active");
        }else {
            $("#nav_tab_3").addClass("active");
        }
        var limit = parseInt($("#pageNumberSelect").val());
        $("#search_gateway").val("");
        tab = tabPage;
        getData(0, limit );//nav标记全部-离线-在线网关切换时查询
    }
    //根据参数获取数据
    function getData(cursor, limit ) {

        var params = {
            limit: limit,
            cursor: cursor,
            verbose: 100
        };
        if (tab == 2) {
            params.online = 1;
        } else if (tab == 3) {
            params.online = 0;
        }
        // 清除全选
        if ($("#selected_all").prop("checked") == true) {
            $("#selected_all").prop("checked", false);
        }
        var name = $.trim($("#search_gateway").val());
        loading();
        if (name !== "") {
            name = name.match(pattern);
            params.name = name;
            searchParams(params);

        }else{
            searchAll(params);
        }
        $("#search_gateway").val(name);
    }

    //根据网关名或者序列号查询
    function searchParams(params,name) {

        var param1 = {
            limit: params.limit,
            cursor: params.cursor,
            verbose: params.verbose,
            name:params.name
        };
        if (params.online || params.online==0) {
            param1.online = params.online;
        }
        searchGateway(true,param1, function(data) {//先根据网关名查询
            if (data.total && data.total > 0) {
                $("#statistics_data_table").empty();
                builtDataForTable(data.result);
                renderPagination(data, getData);
                unload();
            } else { //再根据序列号查询
                var param2 = {
                    limit: params.limit,
                    cursor: params.cursor,
                    verbose: params.verbose,
                    serial_number:params.name
                };
                if (params.online || params.online==0) {
                    param2.online = params.online;
                }
                searchGateway(true,param2,function(data){
                    if (data.total && data.total > 0) {
                        $("#statistics_data_table").empty();
                        builtDataForTable(data.result);
                        renderPagination(data, getData);
                    }else {
                        clearPagination();
                        $("#statistics_data_table").empty();
                        $("#statistics_data_table").append('<tr><td colspan="11"  align="center" lang="text:no_data"></td></tr>');
                        locale.render({element: "#init_body"});
                    }
                    unload();
                },this);
            }
        }, this);
    }

    //查询所有
    function searchAll(params) {
        searchGateway(true,params, function(data) {
            if (data.total && data.total > 0) {
                $("#statistics_data_table").empty();
                builtDataForTable(data.result);
                renderPagination(data, getData);
            } else {
                clearPagination();
                $("#statistics_data_table").empty();
                $("#statistics_data_table").append('<tr><td colspan="11"  align="center" lang="text:no_data"></td></tr>');
                locale.render({element: "#init_body"});
            }
            unload();
        }, this);
    }

    //组装数据-table
    function builtDataForTable(result) {
        var str = "";
        for (var i = 0; i < result.length; i++) {
            str += "<tr>" +
                "<td ><input type='checkbox' name='h1' value='" + result[i]._id + "'/></td>";
            if (result[i].online == 1) {
                //在线
                str += '<td style="text-align: center"><i class="iconfont icon-guanji text-green"></i></td>';
            } else {
                //离线
                str += '<td style="text-align: center"><i class="iconfont icon-guanji1 contacts-list-date"></i></td>';
            }

            str += "<td >" + result[i].name + "</td>";

            if (typeof(result[i].info) == "undefined" || typeof(result[i].info.imsi) == "undefined") {
                str += "<td ></td>";
            } else {
                str += "<td >" + result[i].info.imsi + "</td>";
            }

//            if (typeof(result[i].mobileNumber) == "undefined") {
//                str += "<td ></td>";
//            } else {
//                str += "<td >" + result[i].mobileNumber + "</td>";
//            }

            if (typeof(result[i].pubIp) == "undefined") {
                str += "<td ></td>";
            } else {
                str += "<td >" + result[i].pubIp + "</td>";
            }

            str += "<td >" + result[i].model + "</tdv>";

            if (typeof(result[i].siteName) == "undefined") {
                str += "<td ></td>";
            } else {
                str += "<td >" + result[i].siteName + "</td>";
            }

            if (typeof(result[i].businessState) == "undefined") {
                str += "<td ></td>";
            } else {
                if (result[i].businessState == 0) {
                    str += "<td  lang='text:construction'></td>";
                } else if (result[i].businessState == 1) {
                    str += "<td  lang='text:commissioning'></td>";
                } else if (result[i].businessState == 2) {
                    str += "<td  lang='text:fault'></td>";
                } else if (result[i].businessState == 3) {
                    str += "<td  lang='text:overhaul'></td>";
                }
            }

            if (typeof(result[i].syncState) == "undefined") {
                str += "<td ></td>";
            } else {
                if (result[i].syncState == 0) {
                    str += "<td  lang='text:not_sync'></td>";
                } else if (result[i].syncState == 1) {
                    str += "<td  lang='text:getting_config'></td>";
                } else if (result[i].syncState == 2) {
                    str += "<td  lang='text:applying_config'></td>";
                } else if (result[i].syncState == 3) {
                    str += "<td  lang='text:sync_succeed'></td>";
                } else if (result[i].syncState == 4) {
                    str += "<td  lang='text:sync_fail'></td>";
                }
            }


            if (typeof(result[i].info) == "undefined" || typeof(result[i].info.swVersion) == "undefined") {
                str += "<td ></td>";
            } else {

                str += "<td >" + result[i].info.swVersion + "</td>";
            }

            str += "<td ></td><td ></td><td ></td>";

            str += "<td style='text-align:center;'>"+
                " <span class='glyphicon glyphicon-edit link-black' lang='title:edit'  onclick='show_detailedData(\"" + result[i]._id + "\")' style=' cursor: pointer;' title='编辑'>"+
                "</span></td></tr>";
        }
        $("#statistics_data_table").append(str);
        $("tbody > tr > td > input").on("click", function() {
            var selected_usersId = $("#statistics_data_table tr td input[type='checkbox']:checked");
            var allUsers_nowPage = $("#statistics_data_table tr");
            if (selected_usersId.length < allUsers_nowPage.length) {
                $("#selected_all").prop("checked", false);
            }
            if (selected_usersId.length == allUsers_nowPage.length) {
                $("#selected_all").prop("checked", true);
            }
        });

        locale.render({element: "#init_body"});
    }

    //每页显示条目切换回调函数
    function changePageNumber(limit) {
        getData(0, limit);
    }

    //跳转到指定页  回调函数
    function jumpTopage(cursor) {
        getData(cursor, $("#pageNumberSelect").val());
    }

    // 搜索
    function searchFun() {
        if ($('#gatewaySearchForm').validationEngine('validate')) {
            getData(0, $("#pageNumberSelect").val());
        }
    }

    // 添加enter按键事件
    $("#search_gateway").keydown(function(e) {//当按下按键时
        if (event.keyCode === 10 || event.keyCode === 13) {//.which属性判断按下的是哪个键，回车键的键位序号为13
            $("#search_btn").trigger("click");//触发搜索按钮的点击事件
        }
    });

    /**
     * 删除网关
     */
    function delete_gateway() {
        var gatewayIds = $("input[name='h1']:checked")
        if (gatewayIds.length > 0) {
            dialog.render({
                lang: "deleteGatewayInfo",
                buttons: [{lang: "yes", click: function() {
                    gatewayIds.each(function() {
                        deleteGateway($(this).val());
                    });
                    $("#selected_all").prop("checked", false);
                    getData(0, $("#pageNumberSelect").val());
                    dialog.close();
                }}, {lang: "no", click: function() {
                    dialog.close();
                }}],
                close: function() {
                    dialog.close();
                }
            });
        } else {
            dialog.render({
                lang: "select_del"
            });
        }
        locale.render({element: "#init_body"});
    }

    // 导出网关数据
    function gateway_export() {
        var nowtime = parseInt((new Date()).getTime());
        var deleteTime = (parseInt(nowtime / 1000) + 7 * 24 * 3600) + "";
        var query = {
            report_name: "gatewayExcel.xls",
            language: locale.current(),
            timeout: deleteTime,
            type: '5'
        };
        if (tab == 2) {
            query.online = 1;
        } else if (tab == 3) {
            query.online = 0;
        }

        var name = $.trim($("#search_gateway").val());
        if (name !== "") {
            name = name.match(pattern);
            if(name && name.length>0){
                query.gatewayName = name[0];
            }
        }
        var checkedIds = $("#statistics_data_table tr td input:checked");
        if (checkedIds.length > 0) {
            var ids = [];
            checkedIds.each(function () {
                var perId = $(this).val();
                ids.push(perId);
            });
            query.objectIdList = ids;
        }
        exportReportForm(null, query, function (data) {
            if (data.result) {
                var urlExport = "/api/file/" + data.result._id + "?access_token=" + sessionStorage.getItem("accessToken");
                $.fileDownload(urlExport);
            }
        }, this);
    }

</script>

<section class="content-header">
    <h1 id="gateway_h1" lang="text:gateway">
        <small>Version 2.0</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#" lang="text:site_management"></a></li>
        <li class="active" lang="text:gateway"></li>
    </ol>
</section>

<section class="content" id="tcontent">
    <div class="nav-tabs-custom">
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" role="tablist" id="myNavTabs">
            <li id="nav_tab_1" role="presentation" class="active" onclick="showTabContent(1)"><a href="javascript:void(0)" role="tab"  data-toggle="tab" lang="text:all_gateway"></a></li>
            <li id="nav_tab_2" role="presentation" onclick="showTabContent(2)"><a href="javascript:void(0)" role="tab" data-toggle="tab" lang="text:online_gateway"></a></li>
            <li id="nav_tab_3" role="presentation" onclick="showTabContent(3)"><a href="javascript:void(0)" role="tab" data-toggle="tab"lang="text:offline_gateway"></a></li>
        </ul>
        <!--表格统计-->
        <div class="tab-content" id="allNavTabContent" style="padding-bottom: 0px;">
            <div class="tab-pane row active">
                <div class="col-md-12">
                    <div class="box box-solid" style="margin-bottom: 0px;box-shadow: 0px 0px;">
                        <!--加载数据等待-->
                        <div class="overlay" style="display: none;" id="overlay1">
                            <i class="fa icon-refresh icon-spin"></i>
                        </div>
                        <!--<div class="box-header with-border">-->
                        <!--<span><h3 class="box-title" lang="text:gateway_info">&nbsp;</h3></span>-->
                        <!--<div class="box-tools pull-right">-->
                        <!--<button class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip" title="Collapse"><i class="icon-minus fa-minus"></i></button>-->
                        <!--</div>-->
                        <!--</div>-->
                        <div class="box-body">
                            <!--查询条件-->
                            <div class="row">
                                <div class="col-sm-12" style="padding-bottom: 10px;">
                                    <form class="form-inline" id="gatewaySearchForm">
                                        <div class="form-group">
                                            <input type="text" class="form-control input-sm validate[custom[stopSpecialCharacters]]" id="search_gateway"
                                                   lang="placeholder:enter_the_gateway_name" style="height: 30px;width: 200px;">
                                        </div>
                                        <div class="form-group">
                                            <input type="hidden" id="search_flag" value=""/>
                                            <button id="search_btn" type="button" onclick="searchFun();" class="btn btn-default btn-sm" data-toggle="tooltip"  lang="title:query">
                                                <span class="glyphicon glyphicon-search"></span>
                                            </button>
                                        </div>
                                        <div class="form-group box-tools pull-right">
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-default btn-sm" data-toggle="tooltip"  data-permissionFilter="[83, 84, 85]" onclick="showModal_import_phoneNumber();" lang="title:imsi_mobilenumber">
                                                    <span class="glyphicon glyphicon-earphone"></span>
                                                </button>
                                                <button type="button" class="btn btn-default btn-sm" data-toggle="tooltip"  data-permissionFilter="[83, 84, 85]" onclick="showModal_import_gateway();" lang="title:batch_import">
                                                    <span class="icon-download-alt"></span>
                                                </button>
                                                <button type="button" class="btn btn-default btn-sm" data-toggle="tooltip"  data-permissionFilter="[83]" onclick="gateway_export();" lang="title:export_devices">
                                                    <span class="icon-upload-alt"></span>
                                                </button>
                                                <button type="button" class="btn btn-default btn-sm"   data-permissionFilter="[21,22]" id="getWaymanage" lang="title:gateway_management">
                                                    <span class="glyphicon glyphicon-folder-close" ></span>
                                                </button>
                                                <button type="button" class="btn btn-default btn-sm"
                                                        data-toggle='tooltip' data-placement="bottom" lang="title:add" onclick="showModal_add_update_gateway();" data-permissionFilter="[12]">
                                                    <i class="glyphicon glyphicon-plus"></i>
                                                </button>
                                                <button type="button" class="btn btn-default btn-sm"
                                                        data-toggle='tooltip' data-placement="bottom" lang="title:delete" onclick="delete_gateway();" data-permissionFilter="[12]">
                                                    <i class="iconfont icon-delete"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div id="topo_chart8">
                                <table class="table table-bordered table-hover table-striped" id="tableFirst">
                                    <thead>
                                    <tr>
                                        <th style="max-width:1%" >
                                            <input id="selected_all" lang="title:check_all" type="checkbox"/>
                                        </th>
                                        <th style="width:5%" lang="{text:state}"></th>
                                        <th style="width:9%" lang="{text:device_name1}"></th>
                                        <th >IMSI</th>
                                        <th style="width:9%" lang="{text:ip_address}"></th>
                                        <th style="width:9%" lang="{text:model_type}"></th>
                                        <th style="width:9%" lang="{text:installation_site}"></th>
                                        <th style="width:9%" lang="{text:business_state}"></th>
                                        <th style="width:9%" lang="{text:configuration_state}"></th>
                                        <th style="width:9%" lang="{text:current_version}"></th>
                                        <th style="width:9%" lang="{text:billing_plan_name}"></th>
                                        <th style="width:9%" lang="{text:activation_date}"></th>
                                        <th style="width:9%" lang="{text:deactivation_date}"></th>
                                        <th  style="width:60px;text-align:center;" lang="{text:operate}"></th>
                                    </tr>
                                    </thead>
                                    <tbody id="statistics_data_table">
                                    <!--动态载入数据-->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div id="page-footer"></div>
                    </div>
                </div>
            </div>
            <script>
                //校验月流量预警方法
                function validate_warningnumber() {
                    var warn = $("#info-device-warning").val();
                    var ala = $("#info-warn-alarm").val();
                    var ser = $("#info-device-serious").val();
                    $("#warningseTips11,#warningseTips22,#warningseTips33").hide();
                    if(warn != "" && ala != ""){
                        if (parseFloat(warn) >= parseFloat(ala)) {
                            $("#warningseTips11").show();
                            return -1;
                        } else {
                            $("#warningseTips11").hide();
                        }
                    }else{
                        $("#warningseTips11").hide();
                    }
                    if (warn != "" && ser != "") {
                        if (parseFloat(warn) >= parseFloat(ser)) {
                            $("#warningseTips33").show();
                            return -1;
                        } else {
                            $("#warningseTips33").hide();
                        }
                    } else {
                        $("#warningseTips33").hide();
                    }
                    if (ser != "" && ala != "") {
                        if (parseFloat(ala) >= parseFloat(ser)) {
                            $("#warningseTips22").show();
                            return -1;
                        } else {
                            $("#warningseTips22").hide();
                        }
                    } else {
                        $("#warningseTips22").hide();
                    }
                    return 1;
                }
                //校验月流量预警字段
                $("#info-device-warning,#info-warn-alarm,#info-device-serious").on("blur",function () {
                    validate_warningnumber();
                });
            </script>
        </div>
    </div>
</section>

<!--导入手机号模态框-->
<div class="modal fade" role="dialog" id="modal_import_phoneNumber" aria-labelledby="gridSystemModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title" id="gridSystemModalLabel" lang="text:imsi_mobilenumber"></h4>
            </div>
            <div class="box" style="border-top: 0px solid #d2d6de;">
                <!--等待上传数据加载-->
                <div class="overlay" style="display: none;" id="overlay3">
                    <i class="fa icon-refresh icon-spin"></i>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-4 control-label" lang="text:import_mobilenumber"></label>
                            <div class="col-sm-8">
                                <a id="batch-import-upload-button" class="btn btn-default btn-sm">
                                    <span class="glyphicon glyphicon-open" aria-hidden="true" lang="text:select_file"></span>
                                </a>
                            </div>
                        </div>
                        <div id="batch-import-upload-tips" class="batch-import-form-row batch-import-upload-tips" style="margin: 13px auto;">
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 control-label"></label>
                            <div class="col-sm-8">
                                <a href="javascript:void(0)" onclick="download_phoneFile();" class="btn btn-default btn-sm">
                                    <span class="glyphicon glyphicon-save"  aria-hidden="true" lang="text:download_template_file"></span>
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <input type="hidden" id="batch-import-pupload-id"/>
                    <button type="button" class="btn btn-default pull-left" id="phone_cancel" data-dismiss="modal" lang="text:close"></button>
                    <button type="button" class="btn btn-primary" onclick="p_save()" lang="text:submit"></button>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
    <script>
        //实例化一个导入手机plupload上传对象
        var puploader = new plupload.Uploader({
            browse_button: 'batch-import-upload-button', //触发文件选择对话框的按钮，为那个元素id
            autoUpload: true,
            filters: [
                {title: "Excel files", extensions: "xls"}
            ],
            maxFileSize: "10mb",
            multipart: false,
            multi_selection: false,
            file_data_name: 'filename',
            runtimes: "gears,flash,silverlight,browserplus,html5",
            url: '', //服务器端的上传页面地址
            flash_swf_url: 'plugins/plupload-2.1.9/js/Moxie.swf', //swf文件，当需要使用swf方式进行上传时需要配置该参数
            silverlight_xap_url: 'plugins/plupload-2.1.9/js/Moxie.xap', //silverlight文件，当需要使用silverlight方式进行上传时需要配置该参数
        });

        //绑定各种事件，并在事件监听函数中做你想做的事
        puploader.bind('FilesAdded', function(uploader, files) {
            uploader.setOption('url', '/api/file?filename=' + files[0].name + '&access_token=' + sessionStorage.getItem("accessToken") + '&timeout=' + (Date.parse(new Date()) / 1000 + 604800));
            $("#batch-import-upload-tips").text(files[0].name);
            loading3();
            puploader.start();
        });

        puploader.bind('FileUploaded', function(uploader, file, responseObj) {
            var result = JSON.parse(responseObj.response).result._id;
            if (result) {
                $("#batch-import-pupload-id").val(result);
                dialog.render({
                    lang: "uploadcomplete"
                });
            } else {
                dialog.render({
                    lang: "upload_files_failed",
                });
                $("#batch-import-gateway-tips").empty();
                $("#batch-import-gateway-id").val("");
            }
            unload3();
        });

        // 下载导入手机号模板文件
        function download_phoneFile() {
            var urlFile = "/api/systemfile?filename=template_mobile.xls&access_token=" + sessionStorage.getItem("accessToken");
            var params = {"verbose": 1};
            download_phoneFile_model(params, function(data) {
                if (data.result) {
                    window.open(urlFile);
                }
            }, this);
        }

        //显示导入手机号模态框
        function showModal_import_phoneNumber() {
            $('#modal_import_phoneNumber').modal({backdrop: 'static', keyboard: false, show: true});
            //清空数据
            $("#batch-import-upload-tips").empty();
            $("#batch-import-pupload-id").val("");
            //国际化英文状态样式
            // if ($("#gridSystemModalLabel").text() == "Import mobile number") {
            //     $("#phone_download_template_file_div").css("margin-left", "92px");
            // }
            //在实例对象上调用init()方法进行初始化
            puploader.init();
        }

        //提交
        function p_save() {
            var file_id = $("#batch-import-pupload-id").val();
            if (file_id == "") {
                errorTipDis("please_select_file");
            } else {
                var params = {"verbose": 1, "file_id": file_id};
                submit_batch_import_phoneNumber(params, function(data) {
                    if (typeof(data.result) == "undefined") {
                        for (var j = 0; j < data.length; j++) {
                            if ("error_code" in data[j] && data[j].error_code !== 21336) {
                                if ($.isArray(data[j].params)) {
                                    var _prompt = locale.get(data[j].error_code, data[j].params);
                                    dialog.render({
                                        text: _prompt,
                                        width: 450,
                                        buttons: [{lang: "yes", click: function() {
                                            $("#batch-import-upload-tips").empty();
                                            $("#batch-import-pupload-id").val("");
                                            dialog.close();
                                        }}],
                                        close: function() {
                                            $("#batch-import-upload-tips").empty();
                                            $("#batch-import-pupload-id").val("");
                                            dialog.close();
                                        }
                                    })
                                } else {
                                    var _prompt = locale.get(data[j].error_code);
                                    dialog.render({
                                        text: _prompt,
                                        buttons: [{lang: "yes", click: function() {
                                            $("#batch-import-upload-tips").empty();
                                            $("#batch-import-pupload-id").val("");
                                            dialog.close();
                                        }}],
                                        close: function() {
                                            $("#batch-import-upload-tips").empty();
                                            $("#batch-import-pupload-id").val("");
                                            dialog.close();
                                        }
                                    });
                                }
                                return;
                            }
                        }
                    } else {
                        for (var i = 0; i < data.result.length; i++) {
                            if ("error_code" in data.result[i] && data.result[i].error_code !== 21336) {
                                if ($.isArray(data.result[i].params)) {
                                    var _prompt = locale.get(data.result[i].error_code, data.result[i].params);
                                    dialog.render({
                                        text: _prompt,
                                        buttons: [{lang: "yes", click: function() {
                                            $("#batch-import-upload-tips").empty();
                                            $("#batch-import-pupload-id").val("");
                                            dialog.close();
                                        }}],
                                        close: function() {
                                            $("#batch-import-upload-tips").empty();
                                            $("#batch-import-pupload-id").val("");
                                            dialog.close();
                                        }
                                    })
                                } else {
                                    var _prompt = locale.get(data[j].error_code);
                                    dialog.render({
                                        text: _prompt,
                                        buttons: [{lang: "yes", click: function() {
                                            $("#batch-import-upload-tips").empty();
                                            $("#batch-import-pupload-id").val("");
                                            dialog.close();
                                        }}],
                                        close: function() {
                                            $("#batch-import-upload-tips").empty();
                                            $("#batch-import-pupload-id").val("");
                                            dialog.close();
                                        }
                                    });
                                }
                                return;
                            } else {
                                $("#batch-import-upload-tips").empty();
                                $("#batch-import-pupload-id").val("");
                                dialog.render({
                                    lang: "submit_success"
                                });
                                $("#phone_cancel").click();
                                /* $("#1").addClass("active");
                                 $("#1 a:eq(0)").attr("aria-expanded", "true");
                                 $("#2").removeClass();
                                 $("#2 a:eq(0)").attr("aria-expanded", "false");
                                 $("#3").removeClass();
                                 $("#3 a:eq(0)").attr("aria-expanded", "false");*/
                                showTabContent(tab);
                            }
                        }
                    }
                }, this);
            }
        }
    </script>
</div><!-- /.modal -->

<!--批量导入网关模态框-->
<div class="modal fade" role="dialog" id="modal_import_gateway" aria-labelledby="gridSystemModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="gateway_h4" lang="text:batch_import_gateway_device"></h4>
            </div>


            <div class="box" style="border-top: 0px solid #d2d6de;">
                <!--等待上传数据加载-->
                <div class="overlay" style="display: none;" id="overlay4">
                    <i class="fa icon-refresh icon-spin"></i>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <form id="import_gateway_form" class="form-horizontal">
                            <input type="reset" style="display:none;" id="form_reset2" />
                            <h4 style="text-align: center;" lang="text:max_batch_import"></h4>
                            <div class="form-group">
                                <label lang="text:import_sn_file" class="col-sm-6 control-label"></label>
                                <div class="col-sm-6">
                                    <a id="batch-import-gateway-button" class="btn btn-default btn-sm">
                                        <span class="icon-download-alt" aria-hidden="true" lang="text:select_file"></span>
                                    </a>
                                    <div id="batch-import-gateway-tips" class="batch-import-form-row batch-import-upload-tips" style="margin: 2px auto;">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label  class="col-sm-6 control-label"></label>
                                <div class="col-sm-6">
                                    <div id="gateway_download_import_template_file_div">
                                        <a href="javascript:void(0)" id="button-112" onclick="download_import_templatefile();" class="btn btn-default btn-sm">
                                            <span class="icon-upload-alt" aria-hidden="true" lang="text:download_template_file"></span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label lang="text:vendor_name" class="col-sm-6 control-label"></label>
                                <div class="col-sm-6">
                                    <select id="i-company-id" class="form-control input-sm">
                                        <option selected="selected" value="3" lang="text:inhand"></option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label lang="text:model" class="col-sm-6 control-label"></label>
                                <div class="col-sm-6">
                                    <select id="batch-import-model" class="form-control input-sm">

                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <input type="checkbox" id="module-batch-import-autocreate-site" value="1"style="margin-top:7px;" checked="checked"/>
                                <label lang="text:auto_create_site" class="col-sm-6 control-label"></label>
                            </div>
                            <div class="form-group">
                                <a id="collapseFourA" class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                                    <legend style="border-bottom: 0px solid #e5e5e5; font-size:14px;font-weight: 400; margin-bottom:0px;"><label id="gateway_warning_options" class="col-sm-6 control-label" lang="text:show_warning_options"></label><span style="margin-top:7px;" class="glyphicon glyphicon-triangle-bottom"></span></legend>
                                </a>
                                <div id="collapseFour" class="panel-collapse collapse col-sm-12" style="width:500px;margin: 15px 75px;"role="tabpanel" aria-labelledby="headingTwo">
                                    <div class="panel-body" style="border: 1px solid #e5e5e5;">
                                        <div class="col-sm-10">
                                            <label lang="text:show_threshold"></label>
                                        </div>
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label" lang="text:warning"></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                                <input type="text" class="form-control validate[custom[number],greaterthan[0],funcCall[alaRule]]" value="" id="i-device-warn" style="height: 26px;">
                                            </div>
                                            <div  class="col-sm-2" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:mega">
                                            </div>
                                        </div>
                                        <div class="col-sm-12" id="warningseTips1" style="display:none;"><!--逻辑提示-->
                                            <div class="col-sm-7 col-sm-offset-5">
                                                <span style="color:red; ">*<label style="color:red; " lang="text:warn_tip"></label></span>
                                            </div>
                                        </div><!--逻辑提示-->
                                        <div class="col-sm-12" id="warningseTips3" style="display:none;"><!--逻辑提示-->
                                            <div class="col-sm-7 col-sm-offset-5">
                                                <span  style="color:red; ">*<label style="color:red;" lang="text:warning_tip"></label></span>
                                            </div>
                                        </div><!--逻辑提示-->
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label" lang="text:alarm"></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                                <input type="text" class="form-control validate[custom[number],greaterthan[0],funcCall[alaRule]]" value="" id="i-warn-ala" style="height: 26px;">
                                            </div>
                                            <div  class="col-sm-2" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:mega">
                                            </div>
                                        </div>
                                        <div class="col-sm-12" id="warningseTips2" style="display:none;"><!--逻辑提示-->
                                            <div class="col-sm-7 col-sm-offset-5">
                                                <span  style="color:red; ">*<label style="color:red; " lang="text:warnings_tip"></label></span>
                                            </div>
                                        </div><!--逻辑提示-->
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label" lang="text:serious"></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                                <input type="text" class="form-control validate[custom[number],greaterthan[0],funcCall[alaRule]]" value="" id="i-device-ser" style="height: 26px;">
                                            </div>
                                            <div  class="col-sm-2" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:mega">
                                            </div>
                                        </div>
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label" lang="text:warnhours"></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                                <input type="text" class="form-control validate[custom[number],greaterthan[0],funcCall[alaRule]]" value="" id="i-device-hour" style="height: 26px;">
                                            </div>
                                            <div  class="col-sm-2" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:mega">
                                            </div>
                                        </div>
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label" lang="text:show_recipient"></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                                <textarea class="form-control validate[funcCall[emailRule]]" id="i-recipient-option" style="  resize: none; " lang="placeholder:mailbox_tip"></textarea><br>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <a id="collapseThreeA"  role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                    <legend style="border-bottom: 0px solid #e5e5e5; font-size:14px;font-weight: 400;"><label id="import_advanced_id" class="col-sm-6 control-label" lang="text:show_advanced_options"></label><span class="glyphicon glyphicon-triangle-bottom" style="margin-top:7px;"></span></legend>
                                </a>
                                <div id="collapseThree" class="panel-collapse collapse" style="width:474px;margin-right:75px; margin-left:89px;" role="tabpanel" aria-labelledby="headingOne">
                                    <div class="panel-body" style="border: 1px solid #e5e5e5;">
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-top:10px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label"><span lang="text:heartbeat_timeout"></span><span class="text-red">*</span></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                                <input type="text" class="form-control validate[required,custom[number],min[1],maxSize[6],funcCall[cloudInput]]" value="10" id="i-device-advanced-timeout" style="height: 26px;">
                                            </div>
                                            <div  class="col-sm-2" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:seconds">
                                            </div>
                                        </div>
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label"><span lang="text:heartbeat_interval"></span><span class="text-red">*</span></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                                <input type="text" class="form-control validate[required,custom[number],min[30],max[600],funcCall[cloudInput]]" value="120" id="i-device-interval" style="height: 26px;">
                                            </div>
                                            <div  class="col-sm-2" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:seconds">
                                            </div>
                                        </div>
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label"><span  lang="text:max_heartbeat_lost"></span><span class="text-red">*</span></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                                <input type="text" class="form-control validate[required,custom[number],min[1],max[20],funcCall[cloudInput]]" value="6" id="i-device-lost" style="height: 26px;">
                                            </div>
                                        </div>
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label"><span  lang="text:resend_login"></span><span class="text-red">*</span></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                                <input type="text" class="form-control validate[required,custom[number],min[1],maxSize[6],funcCall[cloudInput]]" value="60" id="i-device-login" style="height: 26px;">
                                            </div>
                                            <div  class="col-sm-2" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:seconds">
                                            </div>
                                        </div>
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label"><span  lang="text:connection_timeout"></span><span class="text-red">*</span></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                                <input type="text" class="form-control validate[required,custom[number],min[1],maxSize[6],funcCall[cloudInput]]" value="300000" id="i-device-ttimeout" style="height: 26px;">
                                            </div>
                                            <div  class="col-sm-2" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:milliscond">
                                            </div>
                                        </div>
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label"><span  lang="text:ack_timeout"></span><span class="text-red">*</span></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                                <input type="text" class="form-control validate[required,custom[number],min[1],maxSize[6],funcCall[cloudInput]]" value="120000" id="i-device-atimeout" style="height: 26px;">
                                            </div>
                                            <div  class="col-sm-2" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:milliscond">
                                            </div>
                                        </div>
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label"><span   lang="text:ack_retries"></span><span class="text-red">*</span></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                                <input type="text" class="form-control validate[required,custom[number],min[1],maxSize[6],funcCall[cloudInput]]" value="3" id="i-device-aretries" style="height: 26px;">
                                            </div>
                                        </div>
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label" lang="text:sync_config"></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                                <select id="i-device-syn" class="form-control input-sm">
                                                    <option selected="selected" value="2" lang="text:keep_device"></option>
                                                    <option value="1" lang="text:keep_platform"></option>
                                                    <option value="0" lang="text:ignore"></option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" id="batch-import-gateway-id"/>
                    <button type="button" class="btn btn-default pull-left" id="gateway-cancel" data-dismiss="modal" lang="text:close"></button>
                    <button type="button" class="btn btn-primary" onclick="g_save();" lang="text:submit"></button>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
    <script>
        //实例化一个导入网关glupload上传对象
        var guploader = new plupload.Uploader({
            browse_button: 'batch-import-gateway-button', //触发文件选择对话框的按钮，为那个元素id
            autoUpload: true,
            filters: [
                {title: "Excel files", extensions: "xls"}
            ],
            maxFileSize: "10mb",
            multipart: false,
            multi_selection: false,
            file_data_name: 'filename',
            runtimes: "gears,flash,silverlight,browserplus,html5",
            url: '', //服务器端的上传页面地址
            flash_swf_url: 'plugins/plupload-2.1.9/js/Moxie.swf', //swf文件，当需要使用swf方式进行上传时需要配置该参数
            silverlight_xap_url: 'plugins/plupload-2.1.9/js/Moxie.xap', //silverlight文件，当需要使用silverlight方式进行上传时需要配置该参数
        });
        //绑定各种事件，并在事件监听函数中做你想做的事
        guploader.bind('FilesAdded', function(uploader, files) {
            uploader.setOption('url', '/api/file?filename=' + files[0].name + '&access_token=' + sessionStorage.getItem("accessToken") + '&timeout=' + (Date.parse(new Date()) / 1000 + 604800));
            $("#batch-import-gateway-tips").text(files[0].name);
            loading4();
            guploader.start();
        });

        guploader.bind('FileUploaded', function(uploader, file, responseObj) {
            var result = JSON.parse(responseObj.response).result._id;
            if (result) {
                $("#batch-import-gateway-id").val(result);
                dialog.render({
                    lang: "uploadcomplete"
                });
            } else {
                dialog.render({
                    lang: "upload_files_failed"
                });
                $("#batch-import-gateway-tips").empty();
                $("#batch-import-gateway-id").val("");
            }
            unload4();
        });

        //月流量预警绑定失去光标验证事件
        $("#i-device-warn,#i-warn-ala,#i-device-ser").blur(function () {
            import_validate_monthtraff();
        });
        //制定月流量校验规则
        function import_validate_monthtraff() {
            var warn = $("#i-device-warn").val();
            var ala = $("#i-warn-ala").val();
            var ser = $("#i-device-ser").val();
            $("#warningseTips1,#warningseTips3,#warningseTips2").hide();
            if (parseFloat(warn) >= parseFloat(ala)) {
                $("#warningseTips1").show();
                return false;
            } else {
                $("#warningseTips1").hide();
            }
            if (parseFloat(warn) >= parseFloat(ser)) {
                $("#warningseTips3").show();
                return false;
            } else {
                $("#warningseTips3").hide();
            }
            if (parseFloat(ala) >= parseFloat(ser)) {
                $("#warningseTips2").show();
                return false;
            } else {
                $("#warningseTips2").hide();
            }
            return true;
        }

        //下载批量导入网关序列号模板文件
        function download_import_templatefile() {
            var urlDownload = "/api/systemfile?filename=template_batch_add.xls&access_token=" + sessionStorage.getItem("accessToken");
            var params = {"verbose": 1};
            download_import_tempfile(params, function(data) {
                if (data.result) {
                    window.open(urlDownload);
                }
            }, this);
        }

        //显示批量导入网关模态框
        function showModal_import_gateway() {
            $('#modal_import_gateway').modal({backdrop: 'static', keyboard: false, show: true});
            //清空数据
            $("#batch-import-gateway-tips").empty();
            $("#batch-import-gateway-id").val("");
            $("#batch-import-model").empty();
            $("#form_reset2").click();
            if ($("#collapseFourA").attr("aria-expanded") == "true") {
                $("#collapseFourA").attr("aria-expanded", "false");
                $("#collapseFourA").addClass("collapsed");
                $("#collapseFour").removeClass();
                $("#collapseFour").addClass("panel-collapse collapse");
                $("#collapseFour").attr("aria-expanded", "false");
            }
            if ($("#collapseThreeA").attr("aria-expanded") == "true") {
                $("#collapseThreeA").attr("aria-expanded", "false");
                $("#collapseThreeA").addClass("collapsed");
                $("#collapseThree").removeClass();
                $("#collapseThree").addClass("panel-collapse collapse");
                $("#collapseThree").attr("aria-expanded", "false");
            }

            //高级选项样式设置 英文状态

            if (locale.current() == 1) {
                var arrInput = $("#collapseFour input[flag='igalarm_en']");
                var arrTextarea = $("#collapseFour textarea[flag='igalarm_en']");
                $(arrInput[0]).css("margin-left", "100px");
                $(arrInput[1]).css("margin-left", "108px");
                $(arrInput[2]).css("margin-left", "104px");
                $(arrInput[3]).css("margin-left", "2px");
                $(arrTextarea[0]).css("width", "263px");
            }
            if (locale.current() == 1) {
                var arrInput = $("#collapseThree input[flag='en']");
                var arrSelect = $("#collapseThree select[flag='en']");
                $(arrInput[0]).css("margin-left", "33px");
                $(arrInput[1]).css("margin-left", "37px");
                $(arrInput[2]).css("margin-left", "19px");
                $(arrInput[3]).css("margin-left", "63px");
                $(arrInput[4]).css("margin-left", "24px");
                $(arrInput[5]).css("margin-left", "32px");
                $(arrInput[6]).css("margin-left", "75px");
                $(arrSelect[0]).css("margin-left", "78px");
            }
            //加载机型数据
            var params = {"verbose": 3, "gateway": true, "limit": 0};
            getModels(params, function(data) {
                if (data) {
                    var $options = "";
                    var re2_ir9=new RegExp(/^IR9.*/);
                    for (var i = 0; i < data.result.length; i++) {
                        if(re2_ir9.test(data.result[i].name)){
                            if($options == ""){
                                $options += "<option selected='selected' value='" + data.result[i]._id + "'>" + data.result[i].name + "</option>";
                            }else{
                                $options += "<option value='" + data.result[i]._id + "'>" + data.result[i].name + "</option>";
                            }
                        }
                    }
                    $("#batch-import-model").append($options);
                }
            }, this);
            //在实例对象上调用init()方法进行初始化
            guploader.init();
        }

        //提交
        function g_save() {
            if ($('#import_gateway_form').validationEngine('validate') && import_validate_monthtraff()) {
                var file_id = $("#batch-import-gateway-id").val();
                if (file_id == "") {
                    infoTipDis("please_select_file");
                } else {
                    var params = {"verbose": 1, "file_id": file_id};
                    if ($("#module-batch-import-autocreate-site:checked").val() == 1) {
                        params.create_site = 1;
                    } else {
                        params.create_site = 0;
                    }
                    var timeout = $("#i-device-ttimeout").val();
                    var ackTimeout = $("#i-device-atimeout").val();
                    var ackRetries = $("#i-device-aretries").val();
                    var sync = $("#i-device-syn option:selected").val();
                    var maxHeartbeatLost = $("#i-device-lost").val();
                    var heartbeatInterval = $("#i-device-interval").val();
                    var heartbeatTimeout = $("#i-device-advanced-timeout").val();
                    var resendLogin = $("#i-device-login").val();
                    var modelId = $("#batch-import-model option:selected").val();
                    var vendorId = $("#i-company-id option:selected").val();
                    var requestData = {
                        "publicAttribute": {
                            "businessState": 1,
                            "config": {
                                "timeout": timeout,
                                "ackTimeout": ackTimeout,
                                "ackRetries": ackRetries,
                                "sync": sync
                            },
                            "deviceConfig": {
                                "maxHeartbeatLost": maxHeartbeatLost,
                                "heartbeatInterval": heartbeatInterval,
                                "heartbeatTimeout": heartbeatTimeout,
                                "resendLogin": resendLogin
                            },
                            "location": {"longitude": 116.407013, "latitude": 39.926588},
                            "modelId": modelId,
                            "plcId": 0,
                            "vendorId": vendorId
                        }
                    };
                    var emailList = $("#i-recipient-option").val();
                    var hoursWarn = $("#i-device-hour").val();
                    var warning1 = $("#i-device-warn").val();
                    var warning2 = $("#i-warn-ala").val();
                    var warning3 = $("#i-device-ser").val();
                    if (parseFloat(warning1) > parseFloat(warning2)) {
                        return;
                    }
                    if (parseFloat(warning2) > parseFloat(warning3)) {
                        return;
                    }
                    if (parseFloat(warning1) > parseFloat(warning3)) {
                        return;
                    }

                    var requestData2 = {
                        "emailList": emailList,
                        "hoursWarn": hoursWarn,
                        "warning1": warning1,
                        "warning2": warning2,
                        "warning3": warning3
                    };
                    batch_import_gateway(params, requestData, function(data) {
                        if (typeof(data.result) == "undefined") {
                            for (var j = 0; j < data.length; j++) {
                                if ("error_code" in data[j] && data[j].error_code !== 21336) {
                                    if ($.isArray(data[j].params)) {
                                        var _prompt = locale.get(data[j].error_code, data[j].params);
                                        dialog.render({
                                            text: _prompt,
                                            width: 450,
                                            buttons: [{lang: "yes", click: function() {
                                                $("#batch-import-gateway-tips").empty();
                                                $("#batch-import-gateway-id").val("");
                                                dialog.close();
                                            }}],
                                            close: function() {
                                                $("#batch-import-gateway-tips").empty();
                                                $("#batch-import-gateway-id").val("");
                                                dialog.close();
                                            }
                                        })
                                    } else {
                                        var _prompt = locale.get(data[j].error_code);
                                        dialog.render({
                                            text: _prompt,
                                            buttons: [{lang: "yes", click: function() {
                                                $("#batch-import-gateway-tips").empty();
                                                $("#batch-import-gateway-id").val("");
                                                dialog.close();
                                            }}],
                                            close: function() {
                                                $("#batch-import-gateway-tips").empty();
                                                $("#batch-import-gateway-id").val("");
                                                dialog.close();
                                            }
                                        });
                                    }
                                    return;
                                }
                            }
                        } else {
                            for (var i = 0; i < data.result.length; i++) {
                                if ("error_code" in data.result[i] && data.result[i].error_code !== 21336) {
                                    if ($.isArray(data.result[i].params)) {
                                        if (data.result[i].error_code == 20007) {
                                            var _prompt = locale.get("200077", data.result[i].params);
                                            dialog.render({
                                                text: _prompt,
                                                buttons: [{lang: "yes", click: function() {
                                                    $("#batch-import-gateway-tips").empty();
                                                    $("#batch-import-gateway-id").val("");
                                                    dialog.close();
                                                }}],
                                                close: function() {
                                                    $("#batch-import-gateway-tips").empty();
                                                    $("#batch-import-gateway-id").val("");
                                                    dialog.close();
                                                }
                                            })
                                        }
                                    } else {
                                        var _prompt = locale.get(data[j].error_code);
                                        dialog.render({
                                            text: _prompt,
                                            buttons: [{lang: "yes", click: function() {
                                                $("#batch-import-gateway-tips").empty();
                                                $("#batch-import-gateway-id").val("");
                                                dialog.close();
                                            }}],
                                            close: function() {
                                                $("#batch-import-gateway-tips").empty();
                                                $("#batch-import-gateway-id").val("");
                                                dialog.close();
                                            }
                                        });
                                    }
                                    return;
                                } else {
                                    set_month_warning(true,data.result[i]._id, requestData2, function(data2) {
                                        if (data2.result == "OK") {
                                            $("#batch-import-gateway-tips").empty();
                                            $("#batch-import-gateway-id").val("");
                                            dialog.render({
                                                lang: "submit_success"
                                            });
                                            $("#gateway-cancel").click();
                                            /* $("#1").addClass("active");
                                             $("#1 a:eq(0)").attr("aria-expanded", "true");
                                             $("#2").removeClass();
                                             $("#2 a:eq(0)").attr("aria-expanded", "false");
                                             $("#3").removeClass();
                                             $("#3 a:eq(0)").attr("aria-expanded", "false");*/
                                            showTabContent(tab);
                                        } else {
                                            $("#batch-import-gateway-tips").empty();
                                            $("#batch-import-gateway-id").val("");
                                            infoTipDis("submit_failed");
                                        }
                                    }, this);

                                }

                            }
                        }
                    }, this);

                }
            }
        }
    </script>
</div><!-- /.modal -->

<!--网关添加修改摸态框-->
<div class="modal fade" role="dialog" id="modal_add_update_gateway" aria-labelledby="gridSystemModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="width:810px;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" >
                    <span aria-hidden="true">×</span>
                </button>
                <h4 class="modal-title" id="modal_add" lang="text:add_gateway"></h4>
                <h4 class="modal-title" id="modal_update" style="display:none;" lang="text:update_gateway"></h4>
            </div>
            <div class="box" style="border-top: 0px solid #d2d6de;">
                <!--等待数据加载-->
                <div class="overlay" style="display: none;" id="overlay2">
                    <i class="fa icon-refresh icon-spin"></i>
                </div>
                <div class="modal-body" style="overflow-y: auto;height:382px;">
                    <div style="padding:0 150px;" id="modal_add_update_div">
                        <form class="form-horizontal" id="add_edit_form">
                            <!--清空form数据-->
                            <input type="reset" style="display:none;" id="form_reset" />
                            <br />
                            <div style="text-align:center ">
                                <span class="glyphicon glyphicon-pencil icon_click" style="display:none;margin-left:400px" lang="title:edit" id="edit_icon" onclick="editGatewayData()" data-permissionFilter="[12]"></span>
                                <input type="hidden" id="gID" value=""/>
                                <input type="hidden" id="optionDataType" value=""/>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-5 control-label"><span lang="text:gateway_name"></span><span class="text-red">*</span></label>
                                <div class="col-sm-6" style="padding-left: 7px;padding-right: 1px;">
                                    <input type="text" class="form-control validate[required,custom[stopSpecialCharacters],minSize[0],maxSize[30],funcCall[cloudInput]]" value="" id="name" gId="" optionDataType="" >
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-5 control-label"><span lang="text:serial_number"></span><span class="text-red">*</span></label>
                                <div class="col-sm-6" style="padding-left: 7px;padding-right: 1px;">
                                    <input type="text" onblur="match＿model();" class="form-control validate[required,custom[stopSpecialCharacters],custom[serialNumber2],funcCall[cloudInput]]" value="" id="info-serial-number" >
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-5 control-label"><span lang="text:mobile_number"></span></label>
                                <div class="col-sm-6" style="padding-left: 7px;padding-right: 1px;">
                                    <input type="text" class="form-control validate[custom[phone1],maxSize[20],minSize[8],funcCall[cloudInput]]" value="" id="info-mobilenumber" >
                                </div>
                            </div>
                            <div class="form-group" id="div_model">
                                <label class="col-sm-5 control-label" lang="text:model"></label>
                                <div class="col-sm-6" style="padding-left: 7px;padding-right: 1px;">
                                    <select id="info-model" class="form-control">

                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-5 control-label" lang="text:business_state"></label>
                                <div class="col-sm-6" style="padding-left: 7px;padding-right: 1px;">
                                    <select id="info-business-state" class="form-control">
                                        <option value="0" lang="text:construction"></option>
                                        <option value="1" lang="text:commissioning"></option>
                                        <option value="2" lang="text:fault"></option>
                                        <option value="3" lang="text:overhaul"></option>
                                    </select>
                                </div>
                            </div>
                            <div id="auto_create_site" class="form-group">
                                <div class="col-sm-10">
                                    <input type="checkbox" style="width:16px;height:16px;" id="info-auto_site" value="1" checked="checked" onclick="if_auto_site()"/>
                                    <span lang="text:auto_create_site"></span>
                                </div>
                            </div>
                            <div id="siteDiv" class="form-group">
                                <label class="col-sm-5 control-label" lang="text:install_site"></label>
                                <div class="col-sm-6" style="padding-left: 7px;padding-right: 1px;">
                                    <select id="info-site-name" class="form-control">
                                    </select>
                                </div>
                            </div>
                            <br/>
                            <div class="form-group">
                                <div style="margin-bottom: 10px;">
                                    <label lang="text:show_warning_options"></label>
                                    <span class="glyphicon glyphicon-triangle-bottom dropdown-option" id="CTRight_alarmOptions" data-toggle="collapse"
                                          onclick="change_alarmOptionsContent()" href="#alarmOptions_content" aria-expanded="false"
                                          aria-controls="advanceOptions_content" style="cursor: pointer;margin-left: 10px;">
                                  </span>
                                </div>
                                <div id="alarmOptions_content" class="collapse" style="border: 1px solid #e5e5e5;">
                                    <div style="width: 100%;">
                                        <label  style=" margin-left:25px;display: inline-block;" lang="text:show_threshold"></label>
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label" lang="text:warning"></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                                <input type="text" class="form-control validate[custom[number]],funcCall[alaRule]" value="" id="info-device-warning" style="height: 26px;">
                                            </div>
                                            <div  class="col-sm-1" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:mega">
                                            </div>
                                        </div>
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label" lang="text:alarm"></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                                <input type="text" class="form-control validate[custom[number],funcCall[alaRule]]" value="" id="info-warn-alarm" style="height: 26px;">
                                            </div>
                                            <div  class="col-sm-1" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:mega">
                                            </div>
                                        </div>
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label" lang="text:serious"></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                                <input type="text" class="form-control validate[custom[number],funcCall[alaRule]]" value="" id="info-device-serious" style="height: 26px;">
                                            </div>
                                            <div  class="col-sm-1" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:mega">
                                            </div>
                                        </div>
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label" lang="text:warnhours"></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                                <input type="text" class="form-control validate[custom[number],funcCall[alaRule]]" value="" id="info-device-hours" style="height: 26px;">
                                            </div>
                                            <div  class="col-sm-1" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:mega">
                                            </div>
                                        </div>
                                        <div class="col-sm-10" id="warningseTips11" style="margin: 13px auto;display:none;">
                                            <span  style="color:red;">*<label style="color:red;" lang="text:warn_tip"></label></span>
                                        </div>
                                        <div class="col-sm-10" id="warningseTips22" style="margin: 13px auto;display:none;">
                                            <span  style="color:red; ">*<label style="color:red;" lang="text:warnings_tip"></label></span>
                                        </div>
                                        <div class="col-sm-10" id="warningseTips33" style="margin: 13px auto;display:none;">
                                            <span  style="color:red; ">*<label style="color:red;" lang="text:warning_tip"></label></span>
                                        </div>
                                        <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                            <label class="col-sm-5 control-label" lang="text:show_recipient"></label>
                                            <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;" id="reTextarea">
                                                <textarea class="form-control validate[funcCall[emailRule]]" id="reContent" style="  resize: none; " lang="placeholder:mailbox_tip"></textarea><br>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <br/>
                            <!--网关配置高级选项-->
                            <!--<div class="form-group">
                              <div style="margin-bottom:10px;margin-left:60px;">
                                  <label lang="text:advanced_options">高级选项</label>
                                  <span class="glyphicon glyphicon-triangle-bottom dropdown-option" id="CTRight_advanceOptions" data-toggle="collapse"
                                        onclick="change_advanceOptionsContent()" href="#advanceOptions_content" aria-expanded="false"
                                        aria-controls="advanceOptions_content" style="cursor: pointer;margin-left: 10px;"></span>
                              </div>
                              <div id="advanceOptions_content" class="collapse" style="border: 1px solid #e5e5e5;">
                                  <div style="width: 100%;">
                                      &lt;!&ndash;<div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-top:10px;margin-right: 1px;margin-left: 1px;">
                                          <label class="col-sm-5 control-label"><span lang="text:heartbeat_timeout"></span><span class="text-red">*</span></label>
                                          <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                              <input type="text" class="form-control validate[required,custom[number],min[1],maxSize[6],funcCall[cloudInput]]" value="10" id="info-device-advanced-heartbeattimeout" style="height: 26px;">
                                          </div>
                                          <div  class="col-sm-2" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:seconds">
                                              秒
                                          </div>
                                      </div>&ndash;&gt;
                                      <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                          <label class="col-sm-5 control-label"><span lang="text:heartbeat_interval"></span><span class="text-red">*</span></label>
                                          <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                              <input type="text" class="form-control validate[required,custom[number],min[30],max[600],funcCall[cloudInput]]" value="120" id="info-device-advanced-heartbeatinterval" style="height: 26px;">
                                          </div>
                                          <div  class="col-sm-2" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:seconds">
                                              秒
                                          </div>
                                      </div>
                                     &lt;!&ndash; <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                          <label class="col-sm-5 control-label" ><span lang="text:max_heartbeat_lost"></span ><span class="text-red">*</span></label>
                                          <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                              <input type="text" class="form-control validate[required,custom[number],min[1],max[20],funcCall[cloudInput]]" value="6" id="info-device-advanced-maxheartbeatlost" style="height: 26px;">
                                          </div>
                                      </div>
                                      <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                          <label class="col-sm-5 control-label"><span lang="text:resend_login"></span><span class="text-red">*</span></label>
                                          <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                              <input type="text" class="form-control validate[required,custom[number],min[1],maxSize[6],funcCall[cloudInput]]" value="60" id="info-device-advanced-resendlogin" style="height: 26px;">
                                          </div>
                                          <div  class="col-sm-2" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:seconds">
                                              秒
                                          </div>
                                      </div>
                                      <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                          <label class="col-sm-5 control-label" ><span lang="text:connection_timeout"></span><span class="text-red">*</span></label>
                                          <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                              <input type="text" class="form-control validate[required,custom[number],min[1],maxSize[6],funcCall[cloudInput]]" value="300000" id="info-device-advanced-timeout" style="height: 26px;">
                                          </div>
                                          <div  class="col-sm-2" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:milliscond">
                                              毫秒
                                          </div>
                                      </div>
                                      <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                          <label class="col-sm-5 control-label" ><span lang="text:ack_timeout"></span><span class="text-red">*</span></label>
                                          <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                              <input type="text" class="form-control validate[required,custom[number],min[1],maxSize[6],funcCall[cloudInput]]" value="120000" id="info-device-advanced-acktimeout" style="height: 26px;">
                                          </div>
                                          <div  class="col-sm-2" style="padding-left: 1px;padding-right: 1px;padding-top: 7px;" lang="text:milliscond">
                                              毫秒
                                          </div>
                                      </div>
                                      <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                          <label class="col-sm-5 control-label" ><span lang="text:ack_retries"></span><span class="text-red">*</span></label>
                                          <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                              <input type="text" class="form-control validate[required,custom[number],min[1],maxSize[6],funcCall[cloudInput]]" value="3" id="info-device-advanced-ackretries" style="height: 26px;">
                                          </div>
                                      </div>
                                      <div class="form-group" style="font-size: 12px;margin-bottom: 5px;margin-right: 1px;margin-left: 1px;">
                                          <label class="col-sm-5 control-label" lang="text:sync_config">配置同步准则:</label>
                                          <div class="col-sm-5" style="padding-left: 7px;padding-right: 1px;">
                                              <select id="info-device-advanced-sync" class="form-control input-sm">
                                                  <option value="2" lang="text:keep_device">以设备为主</option>
                                                  <option value="1" lang="text:keep_platform" selected="true">以平台为主</option>
                                                  <option value="0" lang="text:ignore">忽略</option>
                                              </select>
                                          </div>
                                      </div>&ndash;&gt;
                                  </div>
                              </div>
                            </div>-->
                        </form>
                    </div>
                </div>
                <div class="modal-footer" >
                    <button type="button" class="btn btn-default pull-left"  id="modal_add_update_cancel" data-dismiss="modal" lang="text:close"></button>
                    <button type="button" class="btn btn-primary" onclick="submitDate();" lang="text:submit" data-permissionFilter="[12]"></button>
                </div>
            </div>
        </div>
    </div>
    <script>
        /**
         * 设置网关查询表单验证
         */
        validator.render("#gatewaySearchForm", {
            //  promptPosition: "inline",
            scroll: false,
            // showOneMessage:true, // 只显示一条提示信息
            showPrompts:false //不显示提示信息
        });
        // 显示添加或修改网关配置模态框(添加网关）
        function showModal_add_update_gateway() {
            $('#modal_add_update_gateway').modal({backdrop: 'static', keyboard: false, show: true});
            loading2();
            $("#form_reset").click();
            $("#reContent").text( "");
            $("#div_ip").empty();
            $("#div_base").empty();
            $("#div_signal").empty();
            $("#div_ip").remove();
            $("#div_base").remove();
            $("#div_signal").remove();
            $("#info-site-name").empty();
            $("#name ~ div").remove();
            $("#info-serial-number ~ div").remove();
            $("#info-site-name").append("<option></option>");
            $("#edit_icon").hide();
            $("#modal_footer").show();
            $("#modal_add").show();
            $("#modal_update").hide();
            $("#optionDataType").val("post");
            $("#siteDiv").hide();
            $("#auto_create_site").show();
            var checked = $("#info-auto_site").attr("checked");
            if (checked != "checked") {
                $("#info-auto_site").attr("checked", true);
                $("#siteDiv").css("display", "none");
            }
            $("#modal_add_update_div select").removeAttr("disabled");
            $("#modal_add_update_div option").removeAttr("selected");
            $("#modal_add_update_div input").removeAttr("readonly");
            $("#modal_add_update_div input").removeClass("input_readOnly");
            $("#modal_add_update_div textarea").removeAttr("readonly");
            $("#modal_add_update_div textarea").removeClass("textarea_readOnly");
            $("#name").nextAll("div").show();
            close_advanceOptionsContent();
            close_alarmOptionsContent();
            getSite();
            unload2();
        }

        //查看网关详细信息
        function show_detailedData(gID) {
            $('#modal_add_update_gateway').modal({backdrop: 'static', keyboard: false, show: true});
            $("#form_reset").click();
            $("#reContent").text( "");
            $("#div_ip").empty();
            $("#div_base").empty();
            $("#div_signal").empty();
            $("#div_ip").remove();
            $("#div_base").remove();
            $("#div_signal").remove();
            $("#info-site-name").empty();
            $("#name ~ div").remove();
            $("#info-serial-number ~ div").remove();
            $("#info-site-name").append("<option></option>");
            $("#modal_add").hide();
            $("#modal_update").show();
            $("#modal_footer").hide();
//        $("#edit_icon").show();
            $("#optionDataType").val("put");
            $("#siteDiv").show();
            $("#auto_create_site").hide();
            $("#gID").val(gID);
            $("#info-serial-number").attr("readOnly", "readOnly");
//        $("#modal_add_update_div select").attr("disabled", "disabled");
//        $("#modal_add_update_div input").addClass("input_readOnly");
//        $("#modal_add_update_div input").attr("readOnly", "readOnly");
//        $("#modal_add_update_div textarea").addClass("textarea_readOnly");
//        $("#modal_add_update_div textarea").attr("readOnly", "readOnly");
            loading2();
            close_advanceOptionsContent();
            close_alarmOptionsContent();
            getSite();
            getOneGatewayInfo(gID);
            unload2();
        }

        //网关信息查看状态切换成编辑状态
        function editGatewayData() {

            $("#modal_footer").show();
            $("#edit_icon").hide();
            $("#modal_add_update_div select").removeAttr("disabled");
            $("#modal_add_update_div input").removeAttr("readOnly");
            $("#modal_add_update_div input").removeClass("input_readOnly");
            $("#modal_add_update_div textarea").removeAttr("readonly");
            $("#modal_add_update_div textarea").removeClass("textarea_readOnly");
            $("#info-model").prop("disabled", "disabled"); //更新时忽略机型 disabled="disabled"
            $("#info-serial-number").attr("readOnly", "readOnly");

        }

        // 是否自动创建现场
        function if_auto_site() {
            var checked = $("#info-auto_site").attr("checked");
            if (checked == "checked") {
                $("#info-auto_site").attr("checked", false);
                $("#siteDiv").css("display", "block");
            } else {
                $("#info-auto_site").attr("checked", true);
                $("#siteDiv").css("display", "none");
            }
        }

        //提交网关数据
        function submitDate() {
            if ($('#add_edit_form').validationEngine('validate')) {
                if(validate_warningnumber() < 0){
                    return;
                }
                var operationType = $("#optionDataType").val();
                var params = {};
                if ($("#info-auto_site:checked").val() == 1) {
                    params.create_site = 1;
                } else {
                    params.create_site = 0;
                }
                var name = $("#name").val();
                /* var timeout = $("#info-device-advanced-timeout").val();
                 var ackTimeout = $("#info-device-advanced-acktimeout").val();
                 var ackRetries = $("#info-device-advanced-ackretries").val();
                 var sync = $("#info-device-advanced-sync option:selected").val();
                 var maxHeartbeatLost = $("#info-device-advanced-maxheartbeatlost").val();*/
                //var heartbeatInterval = $("#info-device-advanced-heartbeatinterval").val();
                /*var heartbeatTimeout = $("#info-device-advanced-heartbeattimeout").val();
                 var resendLogin = $("#info-device-advanced-resendlogin").val();*/
                var mobileNumber = $("#info-mobilenumber").val();
                var model = $("#info-model option:selected").text();
                var modelId = $("#info-model option:selected").val();
                var serialNumber = $("#info-serial-number").val();
                var siteId = $("#info-site-name option:selected").val();
                if (typeof(siteId) == "undefined" || siteId == "") {
                    siteId = null;
                }
                var businessState = $("#info-business-state option:selected").val();
                var siteName = "";
                if(siteId) {
                    siteName = $("#info-site-name option:selected").text();
                }
                var requestData = {
                    "businessState": businessState,
                    /* "config": {"timeout": timeout, "ackTimeout": ackTimeout, "ackRetries": ackRetries, "sync": sync},*/
                    /*"deviceConfig": {
                     //"maxHeartbeatLost": maxHeartbeatLost,
                     "heartbeatInterval": heartbeatInterval
                     //"heartbeatTimeout": heartbeatTimeout,
                     // "resendLogin": resendLogin
                     },*/
                    "location": {"longitude": 116.407013, "latitude": 39.926588},
                    "mobileNumber": mobileNumber,
                    "model": model,
                    "modelId": modelId,
                    "name": name,
                    "plcId": 0,
                    "serialNumber": serialNumber,
                    "siteId": siteId,
                    "siteName": siteName
                };
                var emailList = $("#reContent").val();
                var hoursWarn = $("#info-device-hours").val();
                var warning1 = $("#info-device-warning").val();
                var warning2 = $("#info-warn-alarm").val();
                var warning3 = $("#info-device-serious").val();
                if (parseFloat(warning1) > parseFloat(warning2)) {
                    return;
                }
                if (parseFloat(warning2) > parseFloat(warning3)) {
                    return;
                }
                if (parseFloat(warning1) > parseFloat(warning3)) {
                    return;
                }

                var requestData2 = {
                    "emailList": emailList,
                    "hoursWarn": hoursWarn,
                    "warning1": warning1,
                    "warning2": warning2,
                    "warning3": warning3
                };
                loading2();
                if (operationType == "post") { // 新增
                    createGateway(true,params, requestData, function(data) {
                        if (data.result.name == name) {
                            set_month_warning(true,data.result._id, requestData2, function(data2) {
                                unload2();
                                if (data2.result == "OK") {
                                    infoTipDis("add_success");
                                    /*$("#1").addClass("active");
                                     $("#1 a:eq(0)").attr("aria-expanded", "true");
                                     $("#2").removeClass();
                                     $("#2 a:eq(0)").attr("aria-expanded", "false");
                                     $("#3").removeClass();
                                     $("#3 a:eq(0)").attr("aria-expanded", "false");*/
                                    $('#modal_add_update_gateway').modal("hide");
                                    // getData(0, $("#pageNumberSelect").val());
                                    showTabContent(tab);
//                                show_detailedData(data.result._id);
                                    //change_detailedData();
                                }

                            }, this);
                        } else{
                            unload2();
                            errorTipDis("add_failed");
                        }
                    }, this);
                }
                if (operationType == "put") {// 编辑
                    var gID = $("#gID").val();
                    if (typeof(siteId) == "undefined" || siteId == "" || siteId == null) {
                        gID += "?cancel_site=1";
                    }
                    editGateway(true,gID, requestData, function(data) {
                        if (data.result.name == name) {
                            set_month_warning(true,data.result._id, requestData2, function(data) {
                                unload2();
                                if (data.result == "OK") {
                                    dialog.render({
                                        lang: "modify_successful"
                                    });
                                    /* $("#1").addClass("active");
                                     $("#1 a:eq(0)").attr("aria-expanded", "true");
                                     $("#2").removeClass();
                                     $("#2 a:eq(0)").attr("aria-expanded", "false");
                                     $("#3").removeClass();
                                     $("#3 a:eq(0)").attr("aria-expanded", "false");*/
                                    $('#modal_add_update_gateway').modal("hide");
                                    // getData(0, $("#pageNumberSelect").val());
                                    showTabContent(tab);
                                    //change_detailedData();
                                }

                            }, this);
                        } else {
                            unload2();
                            $("#form_reset").click();
                            $("#reContent").test( "");
                            errorTipDis("modify_failed");
                        }

                    }, this);

                }
            }
        }

        //关闭_高级选项区域
        function close_advanceOptionsContent() {
            if ($("#CTRight_advanceOptions").attr("aria-expanded") == 'true') {
                $("#CTRight_advanceOptions").attr("aria-expanded", false);
                $("#CTRight_advanceOptions").removeClass();
                $("#CTRight_advanceOptions").addClass("glyphicon glyphicon-triangle-bottom collapsed");
                $("#advanceOptions_content").attr("aria-expanded", false);
                $("#advanceOptions_content").removeClass();
                $("#advanceOptions_content").addClass("collapse");

            }
        }

        //面板_高级区域闭合
        function change_advanceOptionsContent() {
            if ($("#CTRight_advanceOptions").attr("aria-expanded") == 'true') {
                $("#CTRight_advanceOptions").removeClass();
                $("#CTRight_advanceOptions").addClass("glyphicon glyphicon-triangle-bottom");
            }
            if ($("#CTRight_advanceOptions").attr("aria-expanded") == 'false') {
                $("#CTRight_advanceOptions").removeClass();
                $("#CTRight_advanceOptions").addClass("glyphicon glyphicon-triangle-top");
            }
        }

        //关闭_月流量预警区域
        function close_alarmOptionsContent() {
            if ($("#CTRight_alarmOptions").attr("aria-expanded") == 'true') {
                $("#CTRight_alarmOptions").attr("aria-expanded", false);
                $("#CTRight_alarmOptions").removeClass();
                $("#CTRight_alarmOptions").addClass("glyphicon glyphicon-triangle-bottom collapsed");
                $("#alarmOptions_content").attr("aria-expanded", false);
                $("#alarmOptions_content").removeClass();
                $("#alarmOptions_content").addClass("collapse");

            }
        }

        //面板_月流量预警区域闭合
        function change_alarmOptionsContent() {
            if ($("#CTRight_alarmOptions").attr("aria-expanded") == 'true') {
                $("#CTRight_alarmOptions").removeClass();
                $("#CTRight_alarmOptions").addClass("glyphicon glyphicon-triangle-bottom");
            }
            if ($("#CTRight_alarmOptions").attr("aria-expanded") == 'false') {
                $("#CTRight_alarmOptions").removeClass();
                $("#CTRight_alarmOptions").addClass("glyphicon glyphicon-triangle-top");
            }
        }

        //获取一个网关具体数据
        function getOneGatewayInfo(gId) {
            getOneGatewayOverviewInfo(gId, function(data) {
                getMonthAlarmInfo(gId, function(data2) {
                    fillGatewayInfo(data.result, data2.result);
                }, this);
            }, this);
        }

        //网关数据回填
        function fillGatewayInfo(data, data2) {
            var name = $("#name").val(data.name);
            /* var timeout = $("#info-device-advanced-timeout").val(data.config.timeout);
             var ackTimeout = $("#info-device-advanced-acktimeout").val(data.config.ackTimeout);
             var ackRetries = $("#info-device-advanced-ackretries").val(data.config.ackRetries);
             var maxHeartbeatLost = $("#info-device-advanced-maxheartbeatlost").val(data.deviceConfig.maxHeartbeatLost);*/
            //var heartbeatInterval = $("#info-device-advanced-heartbeatinterval").val(data.deviceConfig.heartbeatInterval);
            /*var heartbeatTimeout = $("#info-device-advanced-heartbeattimeout").val(data.deviceConfig.heartbeatTimeout);
             var resendLogin = $("#info-device-advanced-resendlogin").val(data.deviceConfig.resendLogin);*/
            var mobileNumber = $("#info-mobilenumber").val(data.mobileNumber);
            var serialNumber = $("#info-serial-number").val(data.serialNumber);
            // 如果有Ip 基站 信号强度信息，就显示出来
            var $div = "";
            if(typeof(data.pubIp)!="undefined") {
                var ip = data.pubIp;
                $div += '<div id="div_ip">'+
                    '<label class="col-sm-5" lang="text:ip" style="text-align:right;margin-top:13px;">ip</label>'+
                    '<div class="col-sm-6" style="padding-left: 8px;padding-right: 1px;;margin-bottom: 15px;margin-top:15px;">'+
                    '<span id="info-device-ip" style="width:90px" readonly="readonly">'+ip+'</span>'+
                    '</div>'+
                    '</div>';
            }

            if(typeof(data.info)!="undefined") {
                var dataInfo_mcc = typeof(data.info.mcc)=="undefined" ? "" : data.info.mcc;
                var dataInfo_mnc = typeof(data.info.mnc)=="undefined" ? "" : data.info.mnc;
                var dataInfo_lac = typeof(data.info.lac)=="undefined" ? "" : data.info.lac;
                var dataInfo_cid = typeof(data.info.cid)=="undefined" ? "" : data.info.cid;
                var base_station = "";
                if(dataInfo_mcc!="" && dataInfo_mnc!="" && dataInfo_lac!="" && dataInfo_cid!=""){
                    base_station = dataInfo_mcc+"."+dataInfo_mnc+"."+dataInfo_lac+"."+dataInfo_cid;
                    $div += '<div id="div_base">'+
                        '<label class="col-sm-5" lang="text:base_station" style="text-align: right;margin-bottom: 15px;padding-left: 94px;"></label>'+
                        '<div class="col-sm-6" style="padding-left: 8px;padding-right: 1px;margin-bottom: 15px;">'+
                        '<span id="info-device-basestation" style="width:90px" readonly="readonly">'+base_station+'</span>'+
                        '</div>'+
                        '</div>';
                }
                var rssi = (typeof(data.info.rssi)=="undefined" ||data.info.rssi=="") ? 0 : data.info.rssi;
                var signal =-113+2*parseInt(rssi);
                $div += '<div id="div_signal">'+
                    '<label class="col-sm-5" lang="text:signal_strength" style="text-align: right;margin-top:4px;"></label>'+
                    '<div class="col-sm-6" style="padding-left: 7px;padding-right: 1px;">'+
                    '<span id="info-device-signal-num" style="width:90px" readonly="readonly">'+signal+' dBm</span>';

                if(signal>-91) {//五格
                    $div += '<span style="width: 19px;height: 16px;margin: 3px 0 0 2px;background-image: url(images/signal-5.png);display: inline-block;"/>';
                }else if(signal>-101) {//四格
                    $div += '<span style="width: 19px;height: 16px;margin: 3px 0 0 2px;background-image: url(images/signal-4.png);display: inline-block;"/>';
                }else if(signal>-103) {//三格
                    $div += '<span style="width: 19px;height: 16px;margin: 3px 0 0 2px;background-image: url(images/signal-3.png);display: inline-block;"/>';
                }else if(signal>-107) {//两格
                    $div += '<span style="width: 19px;height: 16px;margin: 3px 0 0 2px;background-image: url(images/signal-2.png);display: inline-block;"/>';
                }else if(signal>-113) {//一格
                    $div += '<span style="width: 19px;height: 16px;margin: 3px 0 0 2px;background-image: url(images/signal-1.png);display: inline-block;"/>';
                }else {//无信号
                    $div += '<span style="width: 19px;height: 16px;margin: 3px 0 0 2px;background-image: url(images/signal-0.png);display: inline-block;"/>';
                }
                $div += '</div></div>';
            }
            if($div!="") {
                $("#div_model").append($div);
            }
            /* var sync = data.config.sync;
             $("#info-device-advanced-sync option").each(function() {
             var $option = $(this);
             if ($option.val() == sync) {
             $option.prop("selected", "selected");
             }
             });*/
            var businessState = data.businessState;
            $("#info-business-state option").each(function() {
                var $option = $(this);
                if ($option.val() == businessState) {
                    $option.prop("selected", "selected");
                }
            });
            var modelId = data.modelId;
            $("#info-model option").each(function() {
                var $option = $(this);
                if ($option.val() == modelId) {
                    $option.prop("selected", "selected");
                }
            });
            $("#info-model").prop( "disabled","disabled");
            if (!typeof(data.siteId) == "undefined" || !data.siteId == "") {
                $("#info-site-name").append("<option selected='selected' value='" + data.siteId + "'>" + data.siteName + "</option>");
            }
            if (data2) {
                $("#reContent").text(data2.emailList);
                $("#info-device-hours").val(data2.hoursWarn);
                $("#info-device-warning").val(data2.warning1);
                $("#info-warn-alarm").val(data2.warning2);
                $("#info-device-serious").val(data2.warning3);
            }
            locale.render({element: "#init_body"});
        }

        // 根据序列号匹配机型
        function match＿model() {
            var serialNumber = $("#info-serial-number").val();
            if (serialNumber.length == 15) {
                var p1 = serialNumber.substring(0, 1);//判断是Router还是DTU
                var p2 = serialNumber.substring(1, 2);//判断网络
                var p3 = serialNumber.substring(2, 3);//判断700还是300还是600,900
                var p4 = serialNumber.substring(3, 4);//是300还是320
                var deviceType = $("#info-model option");
                if (p1 == "R" || p1 == "r") {//Router
                    if (p3 == 7) {//700
                        if (p2 == "w" || p2 == "W") {
                            selectModel("IR7XX_WCDMA", deviceType);
                        } else if (p2 == "v" || p2 == "V") {
                            selectModel("IR7XX_EVDO/CDMA", deviceType);
                        } else if (p2 == "g" || p2 == "G") {
                            selectModel("IR7XX_GPRS/EDGE", deviceType);
                        } else if (p2 == "u" || p2 == "U") {
                            selectModel("IR7XX_UE", deviceType);
                        } else if (p2 == "c" || p2 == "C") {
                            selectModel("IR7XX_EVDO/CDMA", deviceType);
                        } else if (p2 == "e" || p2 == "E") {
                            selectModel("IR7XX_GPRS/EDGE", deviceType);
                        } else if (p2 == "t" || p2 == "T") {
                            selectModel("IR7XX_TD-SCDMA", deviceType);
                        }
                    } else if (p3 == 3) {//300
                        if (p4 == 2) {
                            selectModel("IR320", deviceType);
                        } else {
                            selectModel("IR300", deviceType);
                        }
                    } else if (p3 == 9) {
                        if (p2 == "p" || p2 == "P") {
                            selectModel("IR9XX_WCDMA", deviceType);
                        } else if (p2 == "v" || p2 == "V") {
                            selectModel("IR9XX_EVDO", deviceType);
                        } else if (p2 == "t" || p2 == "T") {
                            selectModel("IR9XX_TDD-LTE", deviceType);
                        }
                        else if (p2 == "f" || p2 == "F") {
                            selectModel("IR9XX_FDD-LTE", deviceType);
                        }
                    } else if (p3 == 6) {
                        if (p2 == "w" || p2 == "W") {
                            selectModel("IR6XX_WCDMA", deviceType);
                        } else if (p2 == "v" || p2 == "V") {
                            selectModel("IR6XX_EVDO", deviceType);
                        } else if (p2 == "t" || p2 == "T") {
                            selectModel("IR6XX_TD", deviceType);
                        }
                    }
                } else if (p1 == "D" || p1 == "d") {//DTU
                    selectModel("InDTU3XX_GPRS/EDGE", deviceType);
                } else if (p1 == "p" || p1 == "P") {
                    if (p2 == "p" || p2 == "P") {
                        selectModel("IR8XX_WCDMA", deviceType);
                    } else if (p2 == "f" || p2 == "F") {
                        selectModel("IR8XX_FDD-LTE", deviceType);
                    }
                    else if (p2 == "t" || p2 == "T") {
                        selectModel("IR8XX_TDD-LTE", deviceType);
                    }
                    else if (p2 == "v" || p2 == "V") {
                        selectModel("IR8XX_EVDO", deviceType);
                    }
                } else if (p1 == "g" || p1 == "G") {
                    if (p2 == "p" || p2 == "P") {
                        selectModel("IG601_HSPA+", deviceType);
                    } else if (p2 == 'V' || p2 == 'V') {
                        selectModel("IG601_EVDO", deviceType);
                    }
                }
            }
        }
        // 设置机型
        function selectModel(mid, modelArray) {
            for (var i = 0; i < modelArray.length; i++) {
                if (modelArray[i].innerHTML == mid) {
                    modelArray[i].selected = true;
                    break;
                }
            }
        }

    </script>
</div>

<script type="text/javascript">
    //国际化英文状态网关配置样式
    if ($("#gateway_h1").text() == "Gateway Config") {
        $("#topo_chart8").css("margin-right", "-295px");
    }

    //当页全选
    $("#selected_all").on('click', function(event) {
        var selected = $("#statistics_data_table tr td input[type='checkbox']:checked");
        var allSiteCurrentPage = $("#statistics_data_table tr");
        if (allSiteCurrentPage.length > 0) {
            if (selected.length < allSiteCurrentPage.length) {
                $("#statistics_data_table tr td input").prop("checked", true);
                $("#selected_all").prop("checked", true);
            } else {
                $("#statistics_data_table tr td input").prop("checked", false);
                $("#selected_all").prop("checked", false);
            }
        }
    });

    //获取现场数据
    function getSite() {
        //加载现场数据
        var params = {"verbose": 1, "has_gateway": false, "limit": 0};
        getSites(params, function(data) {
            var $options = "";
            if (data.total>0) {
                $options = "<option value=''lang='text:--+please_select_site+--'></option>";
                for (var i = 0; i < data.result.length; i++) {
                    $options += "<option value='" + data.result[i]._id + "'>" + data.result[i].name + "</option>";
                }
                $("#info-site-name").empty().append($options);
                locale.render({element: "#init_body"});
            }else {
                $("#info-site-name").empty().append("<option value='' lang='text:no_data'></option>");
                locale.render({element: "#init_body"});
            }
        }, this);
    }

    //获取机型数据
    function getModel() {
        //加载机型数据
        $("#info-model").empty();
        params = {"verbose": 3, "gateway": true, "limit": 0};
        getModels(params, function(data) {
            if (data) {
                var $options = "";
                var re_ir9 = new RegExp(/^IR9.*/);
                for (var i = 0; i < data.result.length; i++) {
                    if(re_ir9.test(data.result[i].name)){
                        if($options == ""){
                            $options += "<option selected='selected' value='" + data.result[i]._id + "'>" + data.result[i].name + "</option>";
                        }else{
                            $options += "<option value='" + data.result[i]._id + "'>" + data.result[i].name + "</option>";
                        }
                    }
                }
                $("#info-model").append($options);
            }
        }, this);
    }

    function loading2() {
        $("#overlay2").show();
    }
    function unload2() {
        $("#overlay2").hide();
    }
    function loading3() {
        $("#overlay3").show();
    }
    function unload3() {
        $("#overlay3").hide();
    }
    function loading4() {
        $("#overlay4").show();
    }
    function unload4() {
        $("#overlay4").hide();
    }
</script>
<!-- 网关管理模态框 -->
<div class="modal fade bs-example-modal-lg" data-backdrop='static' data-keyboard='false' id="getway_upgrade_Box" data-target=".bs-example-modal-lg">
    <div class="modal-dialog modal-lg" data-target=".bs-example-modal-lg">
        <div class="modal-content">
            <div class="modal-header" >
                <button id="close_the_upgrade_1" type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 id="modal_title_device_upgrade" class="modal-title" lang="text:gateway_management"></h4>
            </div>
            <div class="box" style="border-top:none;box-shadow:none;">
                <div class="overlay" style="display: none;" id="overlay_upgrade">
                    <i class="fa icon-refresh icon-spin"></i>
                </div>
                <div class="modal-body" style="overflow-y: hidden">
                    <button type="button" class="btn btn-primary btn-lg btn-block">
                        <span lang="text:device_upgrade"></span>
                    </button>
                    <!--设备升级-->
                    <div class="deviceUpLevel">
                        <div class="col-md-5" style="padding-top: 15px;">
                            <table class="table table-bordered table-hover table-striped" >
                                <thead>
                                <tr>
                                    <th  lang="text:gateway"></th>
                                    <th  lang="text:version_now"></th>
                                    <th  lang="text:state"></th>
                                </tr>
                                </thead>
                                <tbody id="upgrade_infogetway"></tbody>
                            </table>
                        </div>
                        <div class="col-md-7">
                            <form class="form-horizontal" id="dev_config_upgrade">
                                <!--清空form数据-->
                                <div class="form-group">
                                    <h4 class="col-sm-5 control-label" lang="text:upgrade_info"></h4>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-5 control-label"><span lang="text:ip"></span><span class="text-red">*</span></label>
                                    <div class="col-sm-6" style="padding-left: 7px;padding-right: 1px;">
                                        <input type="text" class="form-control input-sm validate[required,custom[giveName],minSize[0],maxSize[30],funcCall[cloudInput]]" value="" id="upgrade_gateway_ip" gid="" lang="placeholder:ip_address" optiondatatype="">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-5 control-label"><span lang="text:port"></span><span class="text-red">*</span></label>
                                    <div class="col-sm-6" style="padding-left: 7px;padding-right: 1px;">
                                        <input type="text" onblur="match＿model();" class="form-control input-sm validate[required,custom[serialNumber2],funcCall[cloudInput]]" value="" id="upgrade_gateway_port" lang="placeholder:port">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-5 control-label" lang="text:import_upgrade_file"></label>
                                    <div class="col-sm-3" style="padding-left: 7px;padding-right: 1px;">
                                        <input type="text" class="form-control input-sm validate[custom[phone1],maxSize[20],minSize[8],funcCall[cloudInput]]" value="" lang="placeholder:gataway_upgrade_file_eg" id="upgrade_gateway_file">
                                    </div>
                                    <div class="col-sm-3" style="padding-left: 7px;padding-right: 1px;">
                                        <a id="choose_upgrade_file" class="btn btn-default btn-sm" style="height:30px;width:120px;">
                                            <span class="glyphicon glyphicon-open" aria-hidden="true" lang="text:select_file"></span>
                                        </a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- 设备配置 -->
                    <!-- <div class="deviceConfig" >
                        <div class="col-md-5" style="padding-top: 15px;">
                          <table class="table table-bordered table-hover" id="tableFirst">
                                      <thead>
                                          <tr>
                                              <th  lang="text:gateway"></th>
                                              <th  lang="text:online_state"></th>
                                          </tr>
                                      </thead>
                                      <tbody id="configArea"></tbody>
                                  </table>
                        </div>
                        <div class="col-md-7">
                        </div>

                    </div> -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="close_the_upgrade" type="button" class="btn btn-default pull-left"  data-dismiss="modal" lang="text:close"></button>
                <button type="button" class="btn btn-primary" id="save_upgrade_file" lang="text:save"></button>
            </div>
        </div>
    </div>
</div>
<style>
    .siteHeader li, .siteHeader {
        margin:0px;
        padding: 0px;
    }
</style>
<!-- 设备管理 -->
<script>
    var resource;
    var target_md5;
    var model_ids;
    //设备管理
    $("#getWaymanage").unbind("click").click(function(event){
        gatewayMange(params);
        permissionFilter_pageFunc();
    });
    function gatewayMange(params){
        var checkedSite = $("#statistics_data_table tr td input:checked");
        if (checkedSite.length > 0) {
            var ids=[];
            checkedSite.each(function (){
                var perId=$(this).val();
                ids.push(perId);
            });
            model_ids = ids;
            var params={
                limit:0,
                verbose:100
            }
            var query={
                resourceIds:ids
            };
            getwayManage(params,query,function(data){
                resource = data;
                $("#upgrade_infogetway").empty();
                var info=data.result;
                var upgrade_service = setting.UPGRADE_SERVER;
                var upgrade_port = setting.UPGRADE_PORT.ENH;
                var info_length = info.length;
                var upgrade_names = [];
                for( var i = 0; i < info_length; i++) {
                    var name_pre = info[i].model.split("_")[0];
                    name_pre = name_pre.charAt( 2);
                    upgrade_names.push( parseInt(name_pre));
                }
                var finally_model = [];
                //数组去重得到最终 finally_model 只有一个内容
                //设备过滤，只留下一个设备
                if( upgrade_names.length == 1) {
                    finally_model = upgrade_names;
                } else {
                    /*for( var k = 1; k < upgrade_names.length; k++) {
                     if( finally_model.indexOf( upgrade_names[k] == -1)) {
                     finally_model.push( upgrade_names[k]);
                     }
                     }*/
                    finally_model = Array.from( new Set(upgrade_names));  //ES6
                }
                if( finally_model.length == 1) {
                    $("#getway_upgrade_Box").modal({show: true});
                    for(var j=0;j<info.length;j++){
                        var state=info[j].online;
                        var version="";
                        if(info[j].info){
                            version = info[j].info.swVersion;
                        }else{
                            version="";
                        }
                        var states = null;
                        if(state == 0){
                            states = locale.get("offline");
                        }else if(state == 1){
                            states= locale.get("online");
                        }
                        var str= '<tr>'+
                            '<td>'+(typeof(info[j].name) == "undefined" ? "" : info[j].name)+'</td>'+
                            '<td style="width:75px;">'+version+'</td>'+
                            '<td style="width:75px;">'+states+'</td>'+
                            '</tr>';
                        $("#upgrade_infogetway").append(str);
                    }
                    $("#upgrade_gateway_ip").val( upgrade_service);
                    $("#upgrade_gateway_port").val( upgrade_port);
                    $("#upgrade_gateway_file").val('');
                    init_uploader();
                } else {
                    errorTipDis("select_same_model");
                }
                permissionFilter_pageFunc();

            },this)
        } else {
            errorTipDis("select_del");
        }
    }
    //上传升级文件函数
    function init_uploader() {
        //实例化一个导入上传对象
        //这里需要选择的网关的modelId
        if( this.choose_upgrade_file) {
            this.choose_upgrade_file = null;
        }
        var choose_upgrade_file = new plupload.Uploader({
            browse_button: 'choose_upgrade_file', //触发文件选择对话框的按钮，为那个元素id
            autoUpload: true,
            filters: [
                {title: "Firmware files", extensions: "bin,ihd"}
            ],
            maxFileSize: "50mb",
            multipart: false,
            multi_selection: false,
            file_data_name: 'filename',
            runtimes: "gears,flash,silverlight,browserplus,html5",
            url: '', //服务器端的上传页面地址
            flash_swf_url: 'plugins/plupload-2.1.9/js/Moxie.swf', //swf文件，当需要使用swf方式进行上传时需要配置该参数
            silverlight_xap_url: 'plugins/plupload-2.1.9/js/Moxie.xap', //silverlight文件，当需要使用silverlight方式进行上传时需要配置该参数
        });
        choose_upgrade_file.init();
        choose_upgrade_file.bind("Error", function(up, err) {
            var err_code = err.code + "";
            if (err_code === "-600") {
                var maxSize = up.settings.max_file_size / 1024;
                if (maxSize >= 1) {
                    var _maxSize = maxSize / 1024;
                    if (_maxSize >= 1) {
                        err.text = locale.get(err_code) + parseInt(_maxSize) + "MB";
                    } else {
                        err.text = locale.locale.get(err_code) + parseInt(maxSize) + "KB";
                    }
                } else {
                    err.text = locale.get(err_code) + maxSize + "KB";
                }
            } else {
                err.text = locale.get(err_code);
            }
            var show_err = err.text;
            dialog.render(  { text:show_err});
        });
        choose_upgrade_file.bind("FilesAdded", function(uploader, files) {
            uploader.setOption('url', '/api/file?filename=' + files[0].name + '&access_token=' + sessionStorage.getItem("accessToken") + '&timeout=' + (Date.parse(new Date()) / 1000 + 604800));
            choose_upgrade_file.start();
            $("#overlay_upgrade").show();
        });
        choose_upgrade_file.bind("FileUploaded", function(uploader, file, response) {
            var response = response.response;
            //返回的数值
            var upgrade_response = JSON.parse(response);
            target_md5 = upgrade_response.result.md5;
            //返回的文件
            var upgrade_file = file;
            var device_upgrade_id;
            if (upgrade_response.result && upgrade_response.result._id) {
                device_upgrade_id = upgrade_response.result._id;
                var device_upgrade_name = upgrade_file.name;
                $("#upgrade_gateway_file").val( device_upgrade_name);
                if( target_md5 === null) {
                    dialog.render({lang: "please_lead_into_the_update_file"});
                    errorTipDis("please_lead_into_the_update_file");
                } else {
                    // upgrade_submit( resource, target_md5, model_ids);
                }
                $("#close_the_upgrade").unbind("click").click( function(e) {
                    delete_upgrade_file( device_upgrade_id);
                });
                $("#close_the_upgrade_1").unbind("click").click( function(e) {
                    delete_upgrade_file( device_upgrade_id);
                });
                $("#save_upgrade_file").click( function(e) {
                    upgrade_submit( resource, target_md5, model_ids);
                    var gateway_file = $("#upgrade_gateway_file").val();
                    if(gateway_file !=null && gateway_file !=""){
                        $("#save_upgrade_file").attr("data-dismiss","modal");
                    }
                });
            }
            $("#overlay_upgrade").hide();
        });
    }
    //保存函数
    function upgrade_submit( resource, target_md5, model_ids) {
        var resource = resource.result;
        for(var i=0;i<resource.length;i++){
            var id = resource[i]._id;
            var name = resource[i].name;
            var target_md5 = target_md5;
            var model_ids = model_ids;
            var ip = $("#upgrade_gateway_ip").val();
            var port = parseInt( $("#upgrade_gateway_port").val());
            var send_data = {
                version: "1",
                filename: target_md5,
                ip: ip,
                port: port,
                username: "2",
                password: "3"
            };
            var params={
                verbose: 100
            }
            var query= {
                objectId: id,
                objectName: name,
                userType: 1,
                name: "Device Upgrade",
                type: 6,
                priority: 30,
                data: send_data
            }
            // var rescount = resource.length;

            saveFile(params, query,function(data){
                if(typeof(data.result)!="undefined") {
                    $('#getway_upgrade_Box').modal("hide");
                    showTabContent(tab);
                    errorTipDis("submit_success");
                }else {
                    errorTipDis("submit_failed");
                }
            },this)
        }

        // schneider.Ajax.request({
        //     url: "api2/tasks",
        //     type: "post",
        //     parameters: {
        //         verbose: 100
        //     },
        //     data: {
        //         objectId: resource._id,
        //         objectName: resource.name,
        //         userType: 1,
        //         name: "Device Upgrade",
        //         type: 6,
        //         priority: 30,
        //         data: send_data
        //     },
        //     success: function( result) {
        //       console.log(result);
        //         // rescount--;
        //         // if( rescount === 0) {
        //         //
        //         // }
        //     },
        //     error: function( data) {
        //         console.log("this is tasks error,", data);
        //     }
        // });
        // });
    };
    //删除文件
    function delete_upgrade_file( delete_file_id) {
        deleteFile( null, delete_file_id, function( data) {
            //console.log("there is delete file");
        }, this);
    }


    $("#buttonFirst").click(function (){
        $(".deviceUpLevel").hide();
        $(".deviceConfig").show();
    });
    $("#buttonSecond").click(function (){
        $(".deviceUpLevel").show();
        $(".deviceConfig").hide();
    })
    // 2017-03-21 Lee Lijie Add query the exit gataway's searial number
    $("#info-serial-number").blur( function() {
        var serialNumber = $.trim($("#info-serial-number").val());
        // console.log( "state_input,", state_input);
        if( !$("#info-serial-number").attr( "readonly")&&/^[a-zA-Z0-9_\-\u4e00-\u9fa5]+$/i.test(serialNumber)) {
            search_exit_number();
        }
    });
    // 根据网关序列号查询网关数据
    function search_exit_number() {
        var serialNumber = $("#info-serial-number").val();
        searchGateway(true, {"verbose": 100, "serial_number": serialNumber}, function(data) {
            // console.log( "data.total", data.total);
            if( data.total == 1) {
                errorTipDis("serial_number_already_exists");
            }
        });
    }
</script>
