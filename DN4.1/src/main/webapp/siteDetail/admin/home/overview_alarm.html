<div class="box box-solid">
    <div class="box-body no-margin" style="height: 246px;">
        <div>
            <div class="form-group">
            <span class="serious_warning"><i class="iconfont icon-alarm-serious"></i><span
                    lang="text:severe_alarm"></span></span>&nbsp;&nbsp;&nbsp;
            <span class="important_warning"><i class="iconfont icon-alarm"></i><span
                    lang="text:important_alarm"></span></span>&nbsp;&nbsp;&nbsp;
            <span class="minor_warning"><i class="iconfont icon-alarm"></i><span
                    lang="text:minor_alarm"></span></span>&nbsp;&nbsp;&nbsp;
            <span class="caution"><i class="iconfont icon-alarm"></i><span
                    lang="text:warn"></span></span>&nbsp;&nbsp;&nbsp;
            <span class="remind"><i class="iconfont icon-alarm-attention"></i><span
                    lang="text:remind"></span></span>
            </div>
            <table class="table table-bordered table-striped">
                <thead>
                <tr>
                    <th lang="text:alarm_level" style="width:50px;"></th>
                   <!--  <th lang="text:site" style="width:160px;">现场名称</th>
                    <th lang="text:warning_source"  style="width:150px;">告警来源</th> -->
                    <th lang="text:alarm_time" style="width:160px;"></th>
                    <th lang="text:clear_time" style="width:160px;"></th>
                    <th lang="text:description"></th>
                    <!-- <th lang="text:state" style="width:70px;">状态</th> --> 
                    <th lang="text:type" style="width:65px;"></th>
                    <th data-permissionFilter='[50]' lang="text:operate" style="text-align:center;width:60px"></th>
                </tr>
                </thead>
                <tbody id="historicalAlarms_table">
                <!--动态载入数据-->
                </tbody>
            </table>
        </div>
    </div>
    <div id="page-footer">

    </div>
</div>

<!-- 确认告警模态框（Modal） -->
<div class="modal fade" id="myModal" style="overflow-y:auto">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span></button>
                <h4 class="modal-title" id="myModalLabel" lang="text:alarm_details"></h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="form">
                    <div class="form-group">
                        <label lang="text:alarm_time" class="col-sm-3 control-label">告警时间</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="time" readonly="readonly">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label" lang="text:site_name">现场名称</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="siteName" readonly="readonly">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label" lang="text:alarm_origin">告警来源</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="origin" readonly="readonly">
                        </div>
                    </div>
                    <div class="form-group" style="display:none" id="qrzh">
                        <label class="col-sm-3 control-label" lang="text:confirm_account">确认账户</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="sure_name" readonly="readonly">
                        </div>
                    </div>
                    <div class="form-group" style="display:none" id="qrsj">
                        <label class="col-sm-3 control-label" lang="text:confirm_time">确认时间</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="sure_time" readonly="readonly">
                        </div>
                    </div>
                    <div class="form-group" style="display:none" id="qczh">
                        <label class="col-sm-3 control-label" lang="text:clear_account">清除账户</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="clear_name" readonly="readonly">
                        </div>
                    </div>
                    <div class="form-group" style="display:none" id="qcsj">
                        <label class="col-sm-3 control-label" lang="text:clear_time">清除时间</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="clear_time" readonly="readonly">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label" lang="text:level">级别</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="levels" readonly="readonly">
                        </div>
                    </div>
                    <div class="form-group" id="add">
                        <label class="col-sm-3 control-label" lang="text:state">状态</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="states" readonly="readonly">
                        </div>
                    </div>
                    <div class="form-group" id="alarm_type">
                        <label class="col-sm-3 control-label" lang="text:type">类型</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="info_type" readonly="readonly">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label" lang="text:description">描述</label>
                        <div class="col-sm-9">
                            <textarea rows="3" cols="20" id="dec" style="width:420px;height:66px;resize: none;"
                                      readonly="readonly"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label" lang="text:comment"></label>
                        <div class="col-sm-9">
                            <textarea rows="3" cols="20" id="tips"
                                      style="width:420px;height:66px;resize:vertical"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-3 col-sm-9">
                            <input id="isTurnHidden" type="hidden">
                            <input id="isTurn" type="checkbox" >
                            <span lang="text:turn_to_fault"></span>
                            <span></span>
                        </div>
                    </div>
                    <div name="repair_asset_div" class="form-group" style="display: none;">
                        <div class="col-sm-offset-3 col-sm-9">
                            <input id="fault_type" type="checkbox" value="2">
                            <span lang="text:halt_fault"></span>
                        </div>
                    </div>
                    <div name="repair_asset_div" class="form-group" style="display: none;">
                        <label class="col-sm-3 control-label" lang="text:machine"></label>
                        <div class="col-sm-9">
                            <select id="repair_asset" class="form-control input-sm">
                                <option value="" selected="selected" lang="text:---+select+---"></option>
                            </select>
                        </div>
                    </div>
                    <div name="repair_order_div" class="form-group" style="display: none;">
                        <label class="col-sm-3 control-label" lang="text:order_number"></label>
                        <div class="col-sm-9">
                            <input type="text" id="order_no" class="form-control"  readonly="readonly">
                        </div>
                    </div>
                </form>
            </div>
            <input type="hidden" value="" id="tempMid"/>
            <div class="modal-footer">
                <button type="button" class="btn btn-default pull-left" data-dismiss="modal" lang="text:close">关闭
                </button>
                <button data-permissionFilter="[50]"  class="btn btn-primary" id="confirm_1" lang="text:affirm">
                    确认
                </button>
                <!-- <button class="btn  btn-primary" id="remove_1" onclick="clearBtn();" lang="text:clear">
                    清除
                </button> -->
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<script>
    //操作按钮 填充告警详情表单数据
    function moreInfo(mId) {
        var params = {
            verbose: 100
        };
        $("#tempMid").val(mId);
        $("#tips").val("");
        $('#myModal').modal({backdrop: 'static', keyboard: false});
        $("#isTurn").click(function(){
            if($("#isTurn").is(":checked")==true){
                $("[name=repair_asset_div]").show();
            }else{
                $("[name=repair_asset_div]").hide();
            }
        })
        getAlarmInfoById(mId, params, function (data) {
            var result = data.result;
            var len = data.result.length;
            if (result.comment == undefined) {
                $("#tips").val("");
            } else {
                $("#tips").val(result.comment);
            }
            $("#isTurn ~ span:eq(1)").text("");
            $("#time").val(schneider.util.dateFormat(result.createTime, "yyyy-MM-dd hh:mm:ss"));
            $("#siteName").val(result.siteName);
            $("#origin").val(result.sourceName);
            $("#info_type").val(result.type);
            var levels = null;
            if (result.level == 5) {
                levels = locale.get("severe_alarm");
            } else if (result.level == 4) {
                levels = locale.get("important_alarm");
            } else if (result.level == 3) {
                levels = locale.get("minor_alarm");
            } else if (result.level == 2) {
                levels = locale.get("warn");
            } else if (result.level == 1) {
                levels = locale.get("remind");
            }
            $("#levels").val(levels);

            var states = null;
            if (result.confirmState == 1) {
                states = locale.get("unconfirmed");
//                $("#confirm_1").attr('disabled', false);
//                $("#remove_1").attr('disabled', false);
            } else if (result.confirmState == 0) {
                states = locale.get("confirmed");
//                $("#confirm_1").attr('disabled', true);
//                $("#remove_1").attr('disabled', false);
            }
            if (result.confirmTime) {
                $("#qrsj").show();
                $("#sure_time").val(schneider.util.dateFormat(result.confirmTime, "yyyy-MM-dd hh:mm:ss"));
            } else {
                $("#qrsj").hide();
            }
            if (result.confirmUserName) {
                $("#qrzh").show();
                $("#sure_name").val(result.confirmUserName);
            } else {
                $("#qrzh").hide();
            }
            if (result.clearTime) {
                $("#qcsj").show();
                $("#clear_time").val(schneider.util.dateFormat(result.clearTime, "yyyy-MM-dd hh:mm:ss"));
            } else {
                $("#qcsj").hide();
            }
            if (result.clearUserName) {
                $("#qczh").show();
                $("#clear_name").val(result.clearUserName);
            } else {
                $("#qczh").hide();
            }
            $("#states").val(states);
            $("#dec").val(result.desc);

            var param = {
                site_id:result.siteId
            }
            if(result.order_id && result.order_id!="undefined"){
                $("[name=repair_asset_div]").show();
                $("[name=repair_order_div]").show();
                $("#isTurn").prop("checked",true);
                $("#isTurn").attr("disabled","disabled");
                $("#repair_asset").attr("disabled","disabled");
                $("#fault_type").attr("disabled","disabled");
                $("#order_no").val(result.order_no);
                if(result.fault_type && result.fault_type!="undefined" && result.fault_type=="2"){
                    $("#fault_type").prop("checked",true);
                }else{
                    $("#fault_type").removeAttr("checked");
                }
                renderAssets(param,result);
            }else{
                $("[name=repair_asset_div]").hide();
                $("[name=repair_order_div]").hide();
                $("#isTurn").removeAttr("checked");
                $("#isTurn").removeAttr("disabled");
                $("#repair_asset").removeAttr("disabled");
                $("#order_no").val("");
                $("#fault_type").removeAttr("checked");
                renderAssets(param,null);
            }
            $('#myModal').modal('show');

            $("#confirm_1").off().on("click", {alarmId: mId}, alarms_deal);
        }, this);
    }

    /**
     * 填充设备下拉列表
     * @param param
     */
    function renderAssets(param,alarmData){
        if(alarmData && alarmData.asset_id){
            $("#repair_asset").empty();
            $("#repair_asset").append("<option value='" + alarmData.asset_id + "' selected='selected'>" + alarmData.asset_name + "</option>");
        }else{
            loadAllDevice(param,function(data){
                $("#repair_asset").empty();
                if (data.result && data.result.length>0) {
                    var str = '';
                    for (var i = 0; i < data.result.length; i++) {
                        str += "<option value='" + data.result[i]._id + "'>" + data.result[i].device_name + "</option>";
                    }
                    $("#repair_asset").append(str);
                    //国际化初始化
                    locale.render({
                        element: "body"
                    });
                }else{
                    $("#isTurn").prop("checked",false);
                    $("#isTurn").attr("disabled","disabled");

                    $("#isTurn ~ span:eq(1)").text("("+locale.get("no_devices")+")");
                }
            },this);
        }
    }
    /**
     * 告警转故障 生成工单
     */
    function alarmToRepair(){
        var formData = {
            wo:{
                asset_id:$("#repair_asset").val(),
                create_time:new Date().getTime(),
                executor:$("#user_info_1").text(),
                executor_id:$("#user_id").val(),
                creator:$("#user_info_1").text(),
                comment:$("#dec").val(),
                order_type:2,
                source_id:$("#tempMid").val(),
                repair_call:$("#user_phone_hidden").text(),
                fault_type:$("#fault_type").is(":checked")==true ? 2 :1
            }
        };
        formData.wo.name=""+$("#repair_asset option[value='"+formData.wo.asset_id+"']").text()+schneider.util.dateFormat(new Date().getTime(), "yyyy-MM-dd hh:mm").replace(/-/g,"").replace(/\s/g,"").replace(/:/g,"");
        addOrder(true,formData,function(data){
            if(typeof(data.result)!="undefined") {
                var order_no = data.result.wo.order_no;
                var order_id = data.result.wo._id;
                $("[name=repair_order_div]").show();
                confirmAlarmFun(order_id,order_no);
//                dialog.render({
//                    lang:"submit_success",
//                });
            }else {
                errorTipDis("turn_to_fault_prompt");
                return false;
            }
            locale.render({element: "#init_body"});
        },this);
    }
    //确认告警
    function alarms_deal(event) {
        var alarmId=event.data.alarmId;
        var comment = $.trim($("#tips").val());
        var params = {confirmWay: 1};
        if (comment != '') {
            params.comment = comment
        }
        dialog.render({
            lang: 31011,
            buttons: [{
                lang: "affirm", click: function () {
                    /**
                    * 判断是否选择转故障 且未转故障，则生成工单
                    * */
                    if($("#isTurn").is(":checked") && $("#order_no").val()==""){
                        if($("#repair_asset").val()==""){
                            errorTipDis("please_select_device");
                            return false;
                        }else{
                            alarmToRepair();
                        }
                    }else{
                        confirmAlarmFun();
                    }
//                    updateUnfirmedAlarms();
                    $('#myModal').modal('hide');
                    dialog.close();
                }
            }, {
                lang: "close", click: function () {
                    dialog.close();
                }
            }],
            close: function () {
                dialog.close();
            }
        });
        locale.render({element: "#init_body"});
    }
    //（点击确认按钮）
    function confirmAlarmFun(order_id,order_no) {
        var comment = $.trim($("#tips").val());
        var params = {
            confirmWay: 1
        }
        if (comment != '') {
            params.comment = comment
        }
        if (order_id != "" && order_no != "") {
            params.order_id = order_id;
            params.order_no = order_no;
        }
        if ($("#fault_type").is(":checked") == true) {
            params.fault_type = $("#fault_type").val();
        }
        var mId = $("#tempMid").val();
        confirmAlarm(mId, params, true, function (data) {
            this.confirmAlarmCallBack(data);
        }, this);
    }
    /**
     * 确认告警回调函数
     */
    function confirmAlarmCallBack(data) {
        var parm = {
            verbose: 100
        }
        getAlarmInfoById(data.result._id, parm, function (data) {
            var confirm = data.result;
            $("#qrsj").show();
            $("#qrzh").show();
            $("#states").val(locale.get("confirmed"));
            // $("#" + data.result._id).find("td").eq(7).html(locale.get("confirmed"));
            if(confirm.order_no && confirm.order_no!="undefined"){
                $("#order_no").val(confirm.order_no);
                $("#isTurn").attr("disabled","disabled");
                $("#repair_asset").attr("disabled","disabled");
            }
            $("#sure_name").val(confirm.confirmUserName);
            $("#sure_time").val(schneider.util.dateFormat(confirm.confirmTime, "yyyy-MM-dd hh:mm:ss"));
//            $("#confirm_1").attr('disabled', true);
            acquire_histoyicalAlarms(0, $("#pageNumberSelect").val());
            updateUnfirmedAlarms();
        }, this);

    }
    ////填充告警列表数据
    function fill_histoyicalAlarms(result) {
        $("#historicalAlarms_table").empty();
        var str = "";
        for (var i = 0; i < result.length; i++) {
            var levels = null;
            var levelCss = "";
            var levelIcon = "";
            if (result[i].level == 5) {
                levels = locale.get({lang: "severe_alarm"});
                levelCss = "serious_warning";
                levelIcon = "iconfont icon-alarm-serious"
            } else if (result[i].level == 4) {
                levels = locale.get("important_alarm");
                levelCss = "important_warning";
                levelIcon = "iconfont icon-alarm"
            } else if (result[i].level == 3) {
                levels = locale.get("minor_alarm");
                levelCss = "minor_warning";
                levelIcon = "iconfont icon-alarm"
            } else if (result[i].level == 2) {
                levels = locale.get("warn");
                levelCss = "caution";
                levelIcon = "iconfont icon-alarm"
            } else if (result[i].level == 1) {
                levels = locale.get("remind");
                levelCss = "remind";
                levelIcon = "iconfont icon-alarm-attention"
            }
            var states = null;
            if (result[i].confirmState == 1) {
                states = locale.get("unconfirmed");
            } else if (result[i].confirmState == 0) {
                states = locale.get("confirmed");
            }
            var order_no = "";
            if(result[i].order_no!=undefined && result[i].order_no!=""){
                order_no =  "<a href='javascript:void(0)' onclick='searchOrder(\"" + result[i].order_id + "\")'>"+result[i].order_no +"</a>"; 
            }
            str = "<tr>" +
                    "<td class='" + levelCss + "'><i class='"+levelIcon+"'></i></td>" +
                    // "<td>" + (typeof(result[i].siteName) == "undefined" ? "" : result[i].siteName) + "</td>" +
                    // "<td>" + (typeof(result[i].sourceName) == "undefined" ? "" : result[i].sourceName) + "</td>" +
                    "<td>" + schneider.util.dateFormat(result[i].createTime, "yyyy-MM-dd hh:mm:ss") + "</td>" +
                    "<td>" + (typeof(result[i].clearTime) == "undefined" ? "" : schneider.util.dateFormat(result[i].clearTime, "yyyy-MM-dd hh:mm:ss")) + "</td>" +
                    "<td>" + (typeof(result[i].desc) == "undefined" ? "" : result[i].desc) + "</td>" +
                    // "<td>" + states + "</td>" + 
                    "<td>" + (typeof(result[i].type) == "undefined" ? "" : result[i].type) + "</td>" +
                    "<td data-permissionFilter='[50]' style='text-align:center;'>" +
                    "<span  data-toggle='tooltip' class='glyphicon glyphicon-ok link-black' style='cursor: pointer;'lang='title:_affirm' onclick='moreInfo(\"" + result[i]._id + "\")'>&nbsp;</span>" +
                    "</td>" +
                    "</tr>";
            $("#historicalAlarms_table").append(str);
        }
        locale.render({element: "#init_body"});
        permissionFilter_pageFunc();
    }
    /**
    *
    * 查询相应的工单，跳转到工单页面
    */
    function searchOrder(orderId){
        console.log("orderId ",orderId)
    }
    function acquire_histoyicalAlarms(cursor,limit) {
        var end_time = (Date.parse(new Date())) / 1000;
        var siteId = sessionStorage.getItem("_id");
        var params = {
            verbose: 100,
            start_time: 0,
            end_time: end_time,
            cursor: cursor,
            limit: limit,
            site_id: siteId,
            confirm_states: 1
        };
        loadAllAlarm(params, function (data) {
            $("#historicalAlarms_table").empty();
            if (data.result && data.result.length > 0) {
                fill_histoyicalAlarms(data.result);
                renderPagination(data, acquire_histoyicalAlarms);
            } else {
                $("#historicalAlarms_table").append('<tr><td colspan="7"  align="center" lang="text:no_data" lang="text:no_data"></td></tr>');
            }
            locale.render({element: "#init_body"});
        }, this);
        locale.render({element: "#init_body"});
    }
    //点击查看告警显示active状态
    $("#alarm_more").click(function () {
        $("#p_alarm a").click();
    });
    //加载分页
    $(document).ready(function () {
        $("#page-footer").load("../admin/pagination.html");
        acquire_histoyicalAlarms(0,$("#pageNumberSelect").val());
        locale.render({element: "#init_body"});
    });

    //每页显示条目切换回调函数
    function changePageNumber(limit) {
        acquire_histoyicalAlarms(0, limit);
    }

    //跳转到指定页  回调函数
    function jumpTopage(cursor) {
        acquire_histoyicalAlarms(cursor, $("#pageNumberSelect").val());
    }
</script>
